<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¤ãƒ³ã‚µã‚¤ãƒ‰ãƒ»ãƒ«ãƒ¼ãƒ—æŠ€èƒ½è©•ä¾¡</title>
  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      text-align: center;
    }
    #heatmap,
    #comparePlot,
    #CombinedContainer {
      display: none !important;
    }

    body { font-family: 'Hiragino Sans', sans-serif; padding: 20px; }
    button { margin-right: 10px; padding: 10px; font-size: 25px; }
    #score, #loopSummary, #loopDetails, #proDistance { font-size: 30px;}
    pre { background: #f4f4f4; padding: 10px; max-height: 200px; overflow: auto; }
    #loading {
      display: none;
      font-size: 100px;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      background: white;
      padding: 20px 40px;
      border-radius: 10px;
    }
    #loopPlot, #comparePlot {
      display: none;
      margin: 0 auto;
      width: auto;
      max-width: 100%;
      margin-bottom: 40px; 
    }
    h2 {
      font-size: 40px;  /* ä¾‹ï¼šå¤§ããã—ãŸã„ã‚µã‚¤ã‚ºã«å¤‰æ›´ã€‚30px ã‚„ 32px ã‚‚å¯ */
    }

    h3 {
      font-size: 30px;  /* ä¾‹ï¼šå¤§ããã—ãŸã„ã‚µã‚¤ã‚ºã«å¤‰æ›´ã€‚30px ã‚„ 32px ã‚‚å¯ */
    }

    #CombinedContainer{
      text-align: center;
    }

    .heatmap-grid {
      display: flex;
      justify-content: center; /* ä¸­å¤®æƒãˆ */
      align-items: flex-start;
      gap: 40px;               /* ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—é–“ã®ä½™ç™½ */
      flex-wrap: nowrap;       /* æŠ˜ã‚Šè¿”ã—ç¦æ­¢ */
      margin: 20px auto;
      max-width: 100%;
    }

    .heatmap-grid div {
      flex: 1;
      max-width: 50%;          /* ãã‚Œãã‚Œ50%ãšã¤ã®å¹… */
      text-align: center;
    }

    .heatmap-grid img {
      width: 100%;             /* divã®å¹…ã„ã£ã±ã„ã«è¡¨ç¤º */
      height: auto;
    }

    #radarChart {
      display: block;        /* ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã«ã™ã‚‹ */
      margin: 0 auto;        /* å·¦å³ä¸­å¤®å¯„ã› */
      width: 600px;
      max-width: 100%;
      margin-bottom: 30px;
    }
    .heatmap-grid h4 {
      min-height: 3em; /* ã©ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚‚æœ€ä½2è¡Œåˆ†ã®é«˜ã•ã‚’ç¢ºä¿ */
      text-align: center;
    }





  </style>
</head>
<body>
  <div class="container">
    <button id="btnConnect">æ¥ç¶š &amp; ã‚»ãƒ³ã‚·ãƒ³ã‚°é–‹å§‹</button>
    <input type="file" id="csvFiles" accept=".csv" multiple style="display:none;">
    <button id="btnCsvMode">CSVã‹ã‚‰è§£æ</button>
    <button id="btnStop" disabled>ã‚»ãƒ³ã‚·ãƒ³ã‚°çµ‚äº† &amp; è§£æ</button>
    <button id="btnRi"  onclick="location.href='/viewer'">å±¥æ­´ã‚’è¦‹ã‚‹</button>
    <div id="loading" style="display: none;">
      <p>è§£æä¸­...</p>
      <progress id="progressBar" value="0" max="100" style="width: 400px; height: 30px;"></progress>
    </div>



    <!-- åŠ é€Ÿåº¦ã¨è§’é€Ÿåº¦ã‚’åˆ¥ã€…ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚°ãƒ©ãƒ•ã§è¡¨ç¤º -->
    <h3 style="display:none;" id="accTitle">åŠ é€Ÿåº¦</h3>
    <canvas id="accChart" width="800" height="150" style="display: none;"></canvas>
    <h3 style="display:none;" id="gyroTitle">è§’é€Ÿåº¦</h3>
    <canvas id="gyroChart" width="800" height="150" style="display: none;"></canvas>

    <hr id="hrTitle" style="display: none; border: none; border-top: 2px solid black; width: 100%; margin: 40px 0;" />
    <div id="saveSection" style="display: none;">
      <input type="text" id="resultName" placeholder="çµæœã®åå‰ã‚’å…¥åŠ›" style="font-size:16px; padding:5px; width:200px;" />
      <button id="btnSaveResult" style="display:none;">çµæœã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <h2 id="Title" style="display: none;">è§£æçµæœ</h2>
    <h3 id="RadarTitle" style="display: none;">ç·åˆè©•ä¾¡ï¼ˆãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆï¼‰</h3>
    <img id="radarChart" style="display: none; width: 600px; max-width: 100%; margin-bottom: 30px;" />

    <div id="score"></div>
    <br>
    <div id="proDistance"></div>
    <br>
    <div id="loopSummary"></div>
    <pre id="loopDetails" style="display: none;"></pre>
    <h3 id="Ken" style="display: none;">ãƒ«ãƒ¼ãƒ—æ¤œå‡º</h3>
    <img id="loopPlot" style="display: none; width: 1200px; height: auto;" />
    <h3 id="HeatmapTitle" style="display: none;">ãƒ«ãƒ¼ãƒ—é¡ä¼¼åº¦</h3>
    <div id="Rui" style="display: none;" class="heatmap-grid">
      <div>
        <h4>è‡ªå·±æ¯”è¼ƒ</h4>
        <img id="selfHeatmap" alt="è‡ªåˆ† vs è‡ªåˆ†ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—" style="max-width: 100%;" />
      </div>
      <!-- <div>
        <h4>éå¯¾è§’æˆåˆ†ï¼šè‡ªå·±æ¯”è¼ƒã€€å¯¾è§’æˆåˆ†ï¼šãƒ—ãƒ­æ¯”è¼ƒï¼ˆã¾ã¨ã‚ã¦æ­£è¦åŒ–ï¼‰</h4>
        <img id="heatmap" alt="ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—" style="max-width: 100%;" />
      </div> -->
      <div>
        <h4>å¯¾è§’æˆåˆ†ï¼šãƒ—ãƒ­æ¯”è¼ƒ</h4>
        <img id="proHeatmap" alt="ãƒ—ãƒ­è·é›¢ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—" style="max-width: 100%;" />
      </div>
    </div>

    <!-- <div id="CombinedContainer" style="display: none; text-align: center; margin-top: 30px;">
      <h4>éå¯¾è§’æˆåˆ†ï¼šè‡ªå·±æ¯”è¼ƒã€€å¯¾è§’æˆåˆ†ï¼šãƒ—ãƒ­æ¯”è¼ƒï¼ˆãã‚Œãã‚Œæ­£è¦åŒ–ï¼‰</h4>
      <img id="combinedHeatmap" alt="åˆæˆãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—" style="max-width: 90%;" />
    </div> -->

    <!-- <h3 id="Pro" style="display: none;">ãƒ—ãƒ­ã¨æ¯”è¼ƒ</h3>
    <img id="comparePlot" style="width: 1000px; display: none; " /> -->
    <!-- ãƒ—ãƒ­ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <hr id="hrPro" style="display: none; border: none; border-top: 2px solid black; width: 100%; margin: 40px 0;" />
    <div id="proExample" style="display: none;">
      <h2>å‚è€ƒãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ—ãƒ­ï¼‰</h2>
      <h3>å¹³å‡ãƒ«ãƒ¼ãƒ—æ™‚é–“: 0.429 ç§’</h3>
      <h3>ãƒ«ãƒ¼ãƒ—æ™‚é–“ã®æ¨™æº–åå·®: 0.072 ç§’</h3>
      <h3>ãƒ—ãƒ­ã®ãƒ«ãƒ¼ãƒ—æ¤œå‡º</h3>
      <img src="/pro_segu.png" alt="ãƒ—ãƒ­ã®ãƒ«ãƒ¼ãƒ—æ¤œå‡ºå›³" style="width: 100%; max-width: 1200px;" />

      <h3>ãƒ—ãƒ­ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</h3>
      <img src="/pro_heatmap.png" alt="ãƒ—ãƒ­ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—" style="width: 100%; max-width: 800px;" />

      <h3>ãƒ—ãƒ­ã®å®Ÿæ¼”æ˜ åƒ</h3>
      <video controls style="max-width: 60%;">
        <source src="/pro.mp4" type="video/mp4" />
        ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
      </video>
    </div>

    <hr id="hrCsv" style="display: none; border: none; border-top: 2px solid black; width: 100%; margin: 40px 0;" />
    <h2 id="csvTitle" style="display: none;">å–å¾—ãƒ‡ãƒ¼ã‚¿ (CSVå½¢å¼)</h2>
    <button id="btnSaveCsv" style="display: none;">CSVã‚’ä¿å­˜</button>

    <h3 id="accLabel" style="display: none;">åŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿</h3>
    <pre id="accOutput" style="display: none;"></pre>

    <h3 id="gyroLabel" style="display: none;">è§’é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿</h3>
    <pre id="gyroOutput" style="display: none;"></pre>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      let progress = 0;
      let progressInterval = null;

      function startFakeProgress() {
        const bar = document.getElementById("progressBar");
        progress = 0;
        bar.value = 0;

        progressInterval = setInterval(() => {
          if (progress < 90) {
            progress += Math.random() * 3 + 1; // 1ã€œ4%ãšã¤å¢—ã‚„ã™
            bar.value = Math.min(progress, 90);
          }
        }, 200); // 0.2ç§’ã”ã¨ã«æ›´æ–°
      }

      function completeProgress() {
        clearInterval(progressInterval);
        const bar = document.getElementById("progressBar");
        bar.value = 100;
      }

      const csvInput = document.getElementById('csvFiles');
      const btnSaveResult = document.getElementById('btnSaveResult');
      const btnConnect = document.getElementById('btnConnect');
      const btnStop = document.getElementById('btnStop');
      const btnRi = document.getElementById('btnRi');
      const scoreDiv = document.getElementById('score');
      const loopPlotImg = document.getElementById('loopPlot');
      const loadingDiv = document.getElementById('loading');
      const accOutput = document.getElementById('accOutput');
      const gyroOutput = document.getElementById('gyroOutput');
      const btnCsvMode = document.getElementById('btnCsvMode');


      let lastResult = null;
      let device, dataChar, controlChar;
      let buffer = '';
      const acc = [], gyro = [];

      const accCtx = document.getElementById('accChart').getContext('2d');
      const gyroCtx = document.getElementById('gyroChart').getContext('2d');

      const accData = { labels: [], datasets: [
        { label: 'ax', data: [], borderColor: 'blue', fill: false, pointRadius: 0 },
        { label: 'ay', data: [], borderColor: 'skyblue', fill: false, pointRadius: 0 },
        { label: 'az', data: [], borderColor: 'navy', fill: false, pointRadius: 0 }
      ]};
      const gyroData = { labels: [], datasets: [
        { label: 'gx', data: [], borderColor: 'red', fill: false, pointRadius: 0 },
        { label: 'gy', data: [], borderColor: 'orange', fill: false, pointRadius: 0 },
        { label: 'gz', data: [], borderColor: 'darkred', fill: false, pointRadius: 0 }
      ]};

      const accChart = new Chart(accCtx, { type: 'line', data: accData, options: { animation: false, scales: { x: { display: false } } } });
      const gyroChart = new Chart(gyroCtx, { type: 'line', data: gyroData, options: { animation: false, scales: { x: { display: false } } } });

      const SERVICE_UUID = '88888888-4abd-ba0d-b7c6-ff0a00200021';
      const CONTROL_UUID = '88888888-4abd-ba0d-b7c6-ff0a00200022';
      const DATA_UUID = '88888888-4abd-ba0d-b7c6-ff0a00200023';
      const API_BASE = 'https://yoyo-backend.kajilab.dev/analyze';

      // ä¿å­˜å‡¦ç†ï¼ˆ1å›ã ã‘å®šç¾©ï¼‰
      async function saveResult() {
        if (!lastResult) {
          alert('ä¿å­˜ã§ãã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }
        const name = document.getElementById('resultName').value.trim() || 'ç„¡é¡Œ';
        const accCsv = 'time,x,y,z\n' + acc.map(d => `${d.t},${d.ax},${d.ay},${d.az}`).join('\n');
        const gyroCsv = 'time,x,y,z\n' + gyro.map(d => `${d.t},${d.gx},${d.gy},${d.gz}`).join('\n');
        const payload = { ...lastResult, name, acc_csv: accCsv, gyro_csv: gyroCsv };
        const res = await fetch('https://yoyo-backend.kajilab.dev/save_result', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        alert(result.status === 'saved' ? `ã€Œ${name}ã€ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ` : 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      btnSaveResult.onclick = saveResult;

      // CSVãƒ¢ãƒ¼ãƒ‰è§£æ
      btnCsvMode.onclick = () => csvInput.click();
      csvInput.onchange = async () => {
        if (csvInput.files.length < 2) {
          alert("åŠ é€Ÿåº¦CSVã¨è§’é€Ÿåº¦CSVã®2ã¤ã‚’é¸ã‚“ã§ãã ã•ã„");
          return;
        }
        const accText = await csvInput.files[0].text();
        const gyroText = await csvInput.files[1].text();
        const accDataJson = csvToJson(accText, true);
        const gyroDataJson = csvToJson(gyroText, false);

        // ã“ã“ã§å‰å›ã®çµæœã‚„UIã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦éè¡¨ç¤ºã«ã™ã‚‹
        resetUIBeforeMeasure();

        btnConnect.style.display = 'none';
        btnCsvMode.style.display = 'none';
        btnStop.style.display = 'none';
        btnRi.style.display = 'none';
        loadingDiv.style.display = 'block';
        startFakeProgress(); // â† è¿½åŠ 
        try {
          startRealAnalysis(accDataJson, gyroDataJson);  // â† å·®ã—æ›¿ãˆã“ã“ã ã‘ï¼
          // const res = await fetch(API_BASE, {
          //   method: 'POST', headers: { 'Content-Type': 'application/json' },
          //   body: JSON.stringify({ acc: accDataJson, gyro: gyroDataJson })
          // });
          // const json = await res.json();
          // renderResult(json);
          
        } catch (err) {
          alert("è§£æå¤±æ•—: " + err.message);
        } finally {
          loadingDiv.style.display = 'none';
          completeProgress();  // â† è¿½åŠ 

          // è§£æçµ‚äº†å¾Œã«ãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
          btnConnect.style.display = 'inline-block';
          btnCsvMode.style.display = 'inline-block';
          btnStop.style.display = 'inline-block';
          btnRi.style.display = 'inline-block';
        }
      };

      function csvToJson(csvText, isAcc = true) {
        const lines = csvText.trim().split('\n');
        lines.shift();
        return lines.map(line => {
          const cols = line.split(',');
          return isAcc
            ? { t: +cols[0], ax: +cols[1], ay: +cols[2], az: +cols[3] }
            : { t: +cols[0], gx: +cols[1], gy: +cols[2], gz: +cols[3] };
        });
      }

      // ã‚»ãƒ³ã‚·ãƒ³ã‚°é–‹å§‹
      btnConnect.onclick = async () => {
        resetUIBeforeMeasure();
        try {
          if (!device || !device.gatt.connected) {
            device = await navigator.bluetooth.requestDevice({
              filters: [{ name: 'ArduinoIMU' }],
              optionalServices: [SERVICE_UUID]
            });
          }
          const server = await device.gatt.connect();
          const service = await server.getPrimaryService(SERVICE_UUID);
          controlChar = await service.getCharacteristic(CONTROL_UUID);
          dataChar = await service.getCharacteristic(DATA_UUID);
          await controlChar.writeValue(new Uint8Array([1]));
          await dataChar.startNotifications();
          dataChar.addEventListener('characteristicvaluechanged', handleNotify);
          document.getElementById('accTitle').style.display = 'block';
          document.getElementById('gyroTitle').style.display = 'block';
          document.getElementById('accChart').style.display = 'block';
          document.getElementById('gyroChart').style.display = 'block';
          btnConnect.disabled = true;
          btnStop.disabled = false;

           // CSVè§£æã¨å±¥æ­´ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
          btnCsvMode.style.display = 'none';
          btnRi.style.display = 'none';

        } catch (err) {
          alert('æ¥ç¶šå¤±æ•—: ' + err.message);
        }
      };

      // ã‚»ãƒ³ã‚·ãƒ³ã‚°çµ‚äº† â†’ è§£æ
      btnStop.onclick = async () => {
        try {
           // è§£æä¸­ã¯ä»–ã®ãƒœã‚¿ãƒ³ã‚’éš ã™
          btnConnect.style.display = 'none';
          btnCsvMode.style.display = 'none';
          btnStop.style.display = 'none';
          btnRi.style.display = 'none';
          loadingDiv.style.display = 'block';
          hideMeasureUI();
          await controlChar.writeValue(new Uint8Array([0]));
          await dataChar.stopNotifications();
          btnStop.disabled = true;
          accOutput.textContent = 'time,x,y,z\n' + acc.map(d => `${d.t},${d.ax},${d.ay},${d.az}`).join('\n');
          gyroOutput.textContent = 'time,x,y,z\n' + gyro.map(d => `${d.t},${d.gx},${d.gy},${d.gz}`).join('\n');
          // ğŸ”„ é€²æ—ãƒãƒ¼ä»˜ãè§£æé–‹å§‹ï¼
          startRealAnalysis(acc, gyro);  // â† ã“ã“ã ã‘å¤‰ãˆã‚Œã°OK
          const res = await fetch(API_BASE, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ acc, gyro })
          });
          const json = await res.json();
          lastResult = json;
          renderResult(json);
        } catch (err) {
          alert('è§£æå¤±æ•—: ' + err.message);
        } finally {
          loadingDiv.style.display = 'none';
           // è§£æä¸­ã¯ä»–ã®ãƒœã‚¿ãƒ³ã‚’éš ã™
          btnConnect.style.display = 'none';
          btnCsvMode.style.display = 'none';
          btnStop.style.display = 'none';
          btnRi.style.display = 'none';
          btnConnect.style.display = 'inline-block';
          btnStop.style.display = 'inline-block';
          btnRi.style.display = 'inline-block';
          btnConnect.disabled = false;
          btnConnect.textContent = 'ã‚‚ã†ä¸€åº¦ã‚»ãƒ³ã‚·ãƒ³ã‚°';
          document.getElementById('proExample').style.display = 'block';
          document.getElementById('saveSection').style.display = 'block';
          btnSaveResult.style.display = 'inline-block';
          // ã‚»ãƒ³ã‚·ãƒ³ã‚°çµ‚äº†å¾Œã€CSVè§£æã¨å±¥æ­´ãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
          btnCsvMode.style.display = 'inline-block';
          btnRi.style.display = 'inline-block';


        }
      };

      function handleNotify(event) {
        buffer += new TextDecoder().decode(event.target.value);
        const lines = buffer.split('\n');
        buffer = lines.pop();
        for (const line of lines) {
          const p = line.trim().split(',').map(Number);
          if (p.length === 7) {
            const [t, ax, ay, az, gx, gy, gz] = p;
            acc.push({ t, ax, ay, az });
            gyro.push({ t, gx, gy, gz });
            accData.labels.push('');
            gyroData.labels.push('');
            accData.datasets[0].data.push(ax);
            accData.datasets[1].data.push(ay);
            accData.datasets[2].data.push(az);
            gyroData.datasets[0].data.push(gx);
            gyroData.datasets[1].data.push(gy);
            gyroData.datasets[2].data.push(gz);
            if (accData.labels.length > 100) {
              accData.labels.shift();
              accData.datasets.forEach(ds => ds.data.shift());
            }
            if (gyroData.labels.length > 100) {
              gyroData.labels.shift();
              gyroData.datasets.forEach(ds => ds.data.shift());
            }
            accChart.update();
            gyroChart.update();
          }
        }
      }

      function resetUIBeforeMeasure() {
        document.getElementById('loopPlot').style.display = 'none';
        scoreDiv.textContent = '';
        document.getElementById('proDistance').textContent = '';
        document.getElementById('loopSummary').textContent = '';
        document.getElementById('loopDetails').style.display = 'none';
        document.getElementById('proExample').style.display = 'none';
        document.getElementById('Title').style.display = 'none';
        document.getElementById('csvTitle').style.display = 'none';
        document.getElementById('btnSaveCsv').style.display = 'none';
        document.getElementById('accLabel').style.display = 'none';
        document.getElementById('gyroLabel').style.display = 'none';
        document.getElementById('accOutput').style.display = 'none';
        document.getElementById('gyroOutput').style.display = 'none';
        document.getElementById('hrPro').style.display = 'none';
        document.getElementById('hrCsv').style.display = 'none';
        document.getElementById('hrTitle').style.display = 'none';
        document.getElementById('Ken').style.display = 'none';
        document.getElementById('HeatmapTitle').style.display = 'none';
        document.getElementById('Rui').style.display = 'none';
        document.getElementById('saveSection').style.display = 'none';
        document.getElementById('radarChart').style.display = 'none';
        document.getElementById('RadarTitle').style.display = 'none';
        acc.length = 0;
        gyro.length = 0;
        accData.labels.length = 0;
        accData.datasets.forEach(ds => ds.data.length = 0);
        gyroData.labels.length = 0;
        gyroData.datasets.forEach(ds => ds.data.length = 0);
        accChart.update();
        gyroChart.update();
      }

      function hideMeasureUI() {
        document.getElementById('accChart').style.display = 'none';
        document.getElementById('gyroChart').style.display = 'none';
        document.getElementById('accTitle').style.display = 'none';
        document.getElementById('gyroTitle').style.display = 'none';
        document.getElementById('saveSection').style.display = 'none';
      }

      // çµæœè¡¨ç¤º
      function renderResult(json) {
        lastResult = json;
        document.getElementById('Title').style.display = 'block';
        document.getElementById('csvTitle').style.display = 'block';
        document.getElementById('btnSaveCsv').style.display = 'inline-block';
        document.getElementById('accLabel').style.display = 'block';
        document.getElementById('gyroLabel').style.display = 'block';
        document.getElementById('hrPro').style.display = 'block';
        document.getElementById('hrCsv').style.display = 'block';
        document.getElementById('hrTitle').style.display = 'block';
        document.getElementById('Ken').style.display = 'block';
        document.getElementById('HeatmapTitle').style.display = 'block';
        document.getElementById('Rui').style.display = 'flex';
        document.getElementById('accOutput').style.display = 'block';
        document.getElementById('gyroOutput').style.display = 'block';
        btnSaveResult.style.display = 'inline-block';
        document.getElementById('proExample').style.display = 'block';

        // Radar chart
        if (json.radar_chart && typeof json.radar_chart === 'string') {
          const radarImg = document.getElementById('radarChart');
          radarImg.src = `data:image/png;base64,${json.radar_chart}`;
          radarImg.style.display = 'block';
          const radarTitle = document.getElementById('RadarTitle');
          radarTitle.textContent = `ç·åˆè©•ä¾¡: ${json.total_score.toFixed(1)} ç‚¹`;
          radarTitle.style.display = 'block';
        }

        // Loop plot
        if (json.loop_plot) {
          loopPlotImg.src = `data:image/png;base64,${json.loop_plot}`;
          loopPlotImg.style.display = 'block';
        }

        // Heatmaps
        if (json.self_heatmap) {
          document.getElementById('selfHeatmap').src = `data:image/png;base64,${json.self_heatmap}`;
          document.getElementById('selfHeatmap').style.display = 'block';
        }
        if (json.pro_heatmap) {
          document.getElementById('proHeatmap').src = `data:image/png;base64,${json.pro_heatmap}`;
          document.getElementById('proHeatmap').style.display = 'block';
        }

        // Stats
        scoreDiv.textContent = `é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢: ${json.score.toFixed(1)}ã€€ç·ãƒ«ãƒ¼ãƒ—æ•°: ${json.loop_count}ã€€${
          json.stable_loop !== null ? `å®‰å®šé–‹å§‹ãƒ«ãƒ¼ãƒ—: ${json.stable_loop}å‘¨ç›®` : 'å®‰å®šé–‹å§‹ãƒ«ãƒ¼ãƒ—: ãªã—'
        }`;
        const avgElem = document.getElementById('proDistance');
        avgElem.textContent = json.pro_distance_mean
          ? `ãƒ—ãƒ­ã¨ã®å¹³å‡è·é›¢: ${json.pro_distance_mean.toFixed(1)}`
          : 'ãƒ—ãƒ­ã¨ã®å¹³å‡è·é›¢: ãªã—';
        avgElem.style.display = 'block';
        const meanStr = json.loop_mean_duration !== null
          ? `å¹³å‡ãƒ«ãƒ¼ãƒ—æ™‚é–“: ${json.loop_mean_duration.toFixed(3)} ç§’`
          : `å¹³å‡ãƒ«ãƒ¼ãƒ—æ™‚é–“: ãªã—`;
        const stdStr = json.loop_std_duration !== null
          ? `ã€€ãƒ«ãƒ¼ãƒ—æ™‚é–“ã®æ¨™æº–åå·®: ${json.loop_std_duration.toFixed(3)} ç§’`
          : `ã€€ãƒ«ãƒ¼ãƒ—æ™‚é–“ã®æ¨™æº–åå·®: ãªã—`;
        document.getElementById('loopSummary').textContent = `${meanStr}\n${stdStr}`;
        const loopDetails = document.getElementById('loopDetails');

        if (json.loop_duration_list?.length) {
          const durations = json.loop_duration_list.join('\n');
          loopDetails.textContent = durations 
          loopDetails.style.display = 'block';
        }else {
          loopDetails.textContent = '';
          loopDetails.style.display = 'none';
        }

       if (json.snap_median !== null && json.snap_std !== null) {
          const loopSummary = document.getElementById('loopSummary');
          loopSummary.innerHTML += `
            <p>æ‰‹é¦–ã‚’è¿”ã™å¼·ã•ï¼ˆãƒ«ãƒ¼ãƒ—ã”ã¨ã®ä¸­å¤®å€¤ï¼‰ï¼š${json.snap_median.toFixed(2)} m/sÂ²</p>
            <p>æ‰‹é¦–ã‚’è¿”ã™å¼·ã•ï¼ˆãƒ«ãƒ¼ãƒ—ã”ã¨ã®ã°ã‚‰ã¤ãï¼‰ï¼š${json.snap_std.toFixed(2)} m/sÂ²</p>
          `;
        }





        // CSVãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ä¿å­˜ãƒœã‚¿ãƒ³ã‚’å‡ºã™
        document.getElementById('saveSection').style.display = 'block';
        btnSaveResult.style.display = 'inline-block';
      }

      // CSVä¿å­˜ãƒœã‚¿ãƒ³
      document.getElementById('btnSaveCsv').onclick = () => {
        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        const ts = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
        const accCsv = 'time,x,y,z\n' + acc.map(d => `${d.t},${d.ax},${d.ay},${d.az}`).join('\n');
        const gyroCsv = 'time,x,y,z\n' + gyro.map(d => `${d.t},${d.gx},${d.gy},${d.gz}`).join('\n');
        const saveFile = (content, filename) => {
          const blob = new Blob([content], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.click();
          URL.revokeObjectURL(url);
        };
        saveFile(accCsv, `${ts}_acc.csv`);
        saveFile(gyroCsv, `${ts}_gyro.csv`);
      };
    </script>

  </div>
  <script src="/ProgressBar.js"></script>
</body>
</html>
