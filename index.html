<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¤ãƒ³ã‚µã‚¤ãƒ‰ãƒ»ãƒ«ãƒ¼ãƒ—æŠ€èƒ½è©•ä¾¡</title>
  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      text-align: center;
    }
    body { font-family: 'Hiragino Sans', sans-serif; padding: 20px; }
    button { margin-right: 10px; padding: 10px; font-size: 16px; }
    #score, #loopSummary, #loopDetails { font-size: 30px;}
    pre { background: #f4f4f4; padding: 10px; max-height: 200px; overflow: auto; }
    #loading {
      display: none;
      font-size: 50px;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      background: white;
      padding: 20px 40px;
      border-radius: 10px;
    }
    #heatmap, #loopPlot, #comparePlot {
      display: none;
      margin: 0 auto;
      width: auto;
      max-width: 100%;
      margin-bottom: 40px; 
    }
    h2 {
      font-size: 40px;  /* ä¾‹ï¼šå¤§ããã—ãŸã„ã‚µã‚¤ã‚ºã«å¤‰æ›´ã€‚30px ã‚„ 32px ã‚‚å¯ */
    }

    h3 {
      font-size: 30px;  /* ä¾‹ï¼šå¤§ããã—ãŸã„ã‚µã‚¤ã‚ºã«å¤‰æ›´ã€‚30px ã‚„ 32px ã‚‚å¯ */
    }


  </style>
</head>
<body>
  <div class="container">
    <button id="btnConnect">æ¥ç¶š &amp; ã‚»ãƒ³ã‚·ãƒ³ã‚°é–‹å§‹</button>
    <button id="btnStop" disabled>ã‚»ãƒ³ã‚·ãƒ³ã‚°çµ‚äº† &amp; è§£æ</button>
    <button id="btnRi"  onclick="location.href='/viewer'">å±¥æ­´ã‚’è¦‹ã‚‹</button>
    <div id="loading" style="display: none;">è§£æä¸­...</div>

    <canvas id="liveChart" width="800" height="300" style="display: none;"></canvas>
    <hr id="hrTitle" style="display: none; border: none; border-top: 2px solid black; width: 100%; margin: 40px 0;" />
    <div id="saveSection" style="display: none;">
      <input type="text" id="resultName" placeholder="çµæœã®åå‰ã‚’å…¥åŠ›" style="font-size:16px; padding:5px; width:200px;" />
      <button id="btnSaveResult">çµæœã‚’ä¿å­˜ã™ã‚‹</button>
    </div>
    <h2 id="Title" style="display: none;">è§£æçµæœ</h2>
    <div id="score"></div>
    <div id="loopSummary"></div>
    <pre id="loopDetails" style="display: none;"></pre>
    <h3 id="Ken" style="display: none;">ãƒ«ãƒ¼ãƒ—æ¤œå‡º</h3>
    <img id="loopPlot" style="display: none; width: 1200px; height: auto;" />
    <h3 id="Rui" style="display: none;">ãƒ«ãƒ¼ãƒ—ã”ã¨ã®é¡ä¼¼åº¦</h3>
    <img id="heatmap" alt="ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—" style="display: none;" />
    <h3 id="Pro" style="display: none;">ãƒ—ãƒ­ã¨æ¯”è¼ƒ</h3>
    <img id="comparePlot" style="width: 1000px; display: none; " />
    <!-- ãƒ—ãƒ­ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <hr id="hrPro" style="display: none; border: none; border-top: 2px solid black; width: 100%; margin: 40px 0;" />
    <div id="proExample" style="display: none;">
      <h2>å‚è€ƒãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ—ãƒ­ï¼‰</h2>

      <h3>ãƒ—ãƒ­ã®ãƒ«ãƒ¼ãƒ—æ¤œå‡º</h3>
      <img src="/pro_segu.png" alt="ãƒ—ãƒ­ã®ãƒ«ãƒ¼ãƒ—æ¤œå‡ºå›³" style="width: 100%; max-width: 1200px;" />

      <h3>ãƒ—ãƒ­ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</h3>
      <img src="/pro_heatmap.png" alt="ãƒ—ãƒ­ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—" style="width: 100%; max-width: 800px;" />

      <h3>ãƒ—ãƒ­ã®å®Ÿæ¼”æ˜ åƒ</h3>
      <video controls style="max-width: 60%;">
        <source src="/pro.mp4" type="video/mp4" />
        ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
      </video>
    </div>

    <hr id="hrCsv" style="display: none; border: none; border-top: 2px solid black; width: 100%; margin: 40px 0;" />
    <h2 id="csvTitle" style="display: none;">å–å¾—ãƒ‡ãƒ¼ã‚¿ (CSVå½¢å¼)</h2>
    <button id="btnSaveCsv" style="display: none;">CSVã‚’ä¿å­˜</button>

    <h3 id="accLabel" style="display: none;">åŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿</h3>
    <pre id="accOutput" style="display: none;"></pre>

    <h3 id="gyroLabel" style="display: none;">è§’é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿</h3>
    <pre id="gyroOutput" style="display: none;"></pre>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const SERVICE_UUID = '88888888-4abd-ba0d-b7c6-ff0a00200021';
      const CONTROL_UUID = '88888888-4abd-ba0d-b7c6-ff0a00200022';
      const DATA_UUID    = '88888888-4abd-ba0d-b7c6-ff0a00200023';
      //const API_BASE     = '/analyze';
      const API_BASE     = 'https://yoyo-backend.kajilab.dev/analyze';


      let device, dataChar, controlChar;
      let buffer = '';
      const acc = [], gyro = [];

      const btnConnect = document.getElementById('btnConnect');
      const btnStop    = document.getElementById('btnStop');
      const btnRi    = document.getElementById('btnRi');
      const scoreDiv   = document.getElementById('score');
      const loopPlotImg = document.getElementById('loopPlot');
      const heatmapImg  = document.getElementById('heatmap');
      const loadingDiv = document.getElementById('loading');
      const accOutput = document.getElementById('accOutput');
      const gyroOutput = document.getElementById('gyroOutput');

      const ctx = document.getElementById('liveChart').getContext('2d');
      const chartData = {
        labels: [],
        datasets: [
          { label: 'ax', data: [], borderColor: 'blue', fill: false, pointRadius: 0 },
          { label: 'ay', data: [], borderColor: 'skyblue', fill: false, pointRadius: 0 },
          { label: 'az', data: [], borderColor: 'navy', fill: false, pointRadius: 0 },
          { label: 'gx', data: [], borderColor: 'red', fill: false, pointRadius: 0 },
          { label: 'gy', data: [], borderColor: 'orange', fill: false, pointRadius: 0 },
          { label: 'gz', data: [], borderColor: 'darkred', fill: false, pointRadius: 0 }
        ]
      };

      const liveChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          animation: false,
          scales: { x: { display: false } },
          plugins: { legend: { labels: { font: { size: 14 } } } }
        }
      });

      let hasShownLiveChart = false; // â† è¿½åŠ : ã‚°ãƒ©ãƒ•è¡¨ç¤ºæ¸ˆã¿ã‹ã®ãƒ•ãƒ©ã‚°


      // ã‚»ãƒ³ã‚·ãƒ³ã‚°é–‹å§‹
      btnConnect.onclick = async () => {
        // ğŸ”½ å‰å›ã®è¡¨ç¤ºã‚’åˆæœŸåŒ–
        document.getElementById('loopPlot').style.display = 'none';
        document.getElementById('heatmap').style.display = 'none';
        document.getElementById('comparePlot').style.display = 'none';
        document.getElementById('score').textContent = '';
        document.getElementById('loopSummary').textContent = '';
        document.getElementById('loopDetails').style.display = 'none';
        document.getElementById('proExample').style.display = 'none';
        document.getElementById('Title').style.display = 'none'; 
        document.getElementById('csvTitle').style.display = 'none';
        document.getElementById('btnSaveCsv').style.display = 'none';
        document.getElementById('accLabel').style.display = 'none';
        document.getElementById('gyroLabel').style.display = 'none';
        document.getElementById('accOutput').style.display = 'none';
        document.getElementById('gyroOutput').style.display = 'none';
        document.getElementById('loopDetails').textContent = '';
        document.getElementById('accOutput').textContent = '';
        document.getElementById('gyroOutput').textContent = '';
        document.getElementById('hrPro').style.display = 'none';
        document.getElementById('hrCsv').style.display = 'none';
        document.getElementById('hrTitle').style.display = 'none';
        document.getElementById('Ken').style.display = 'none';
        document.getElementById('Rui').style.display = 'none';
        document.getElementById('Pro').style.display = 'none';

        acc.length = 0;
        gyro.length = 0;
        hasShownLiveChart = false; // â† è¿½åŠ 
        chartData.labels.length = 0;
        chartData.datasets.forEach(ds => ds.data.length = 0);
        liveChart.update();

        document.getElementById('loopPlot').style.display = 'none';

        try {
          if (!device || !device.gatt.connected) {
            device = await navigator.bluetooth.requestDevice({
              filters: [{ name: 'ArduinoIMU' }],
              optionalServices: [SERVICE_UUID]
            });
          }
          const server = await device.gatt.connect();
          const service = await server.getPrimaryService(SERVICE_UUID);
          controlChar = await service.getCharacteristic(CONTROL_UUID);
          dataChar = await service.getCharacteristic(DATA_UUID);

          await controlChar.writeValue(new Uint8Array([1]));
          await new Promise(r => setTimeout(r, 100));
          await dataChar.startNotifications();
          dataChar.addEventListener('characteristicvaluechanged', handleNotify);

          btnConnect.disabled = true;
          btnStop.disabled = false;
          console.log('â–¶ ã‚»ãƒ³ã‚·ãƒ³ã‚°é–‹å§‹');
        } catch (err) {
          console.error(err);
          alert('æ¥ç¶šå¤±æ•—: ' + err.message);
        }
      };

      // ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿å—ä¿¡
      function handleNotify(event) {
      buffer += new TextDecoder().decode(event.target.value);
      const lines = buffer.split('\n');
      buffer = lines.pop();
      for (const line of lines) {
        const p = line.trim().split(',').map(Number);
        if (p.length === 7) {
          const [t, ax, ay, az, gx, gy, gz] = p;
          acc.push({ t, ax, ay, az });
          gyro.push({ t, gx, gy, gz });

          chartData.labels.push('');
          chartData.datasets[0].data.push(ax);
          chartData.datasets[1].data.push(ay);
          chartData.datasets[2].data.push(az);
          chartData.datasets[3].data.push(gx);
          chartData.datasets[4].data.push(gy);
          chartData.datasets[5].data.push(gz);

          if (chartData.labels.length > 100) {
            chartData.labels.shift();
            chartData.datasets.forEach(ds => ds.data.shift());
          }

          // ğŸ”½ åˆå›å—ä¿¡æ™‚ã«ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º
          if (!hasShownLiveChart) {
            document.getElementById('liveChart').style.display = 'block';
            hasShownLiveChart = true;
          }

          liveChart.update();
        }
      }
    }

    let lastResult = null;  // è§£æçµæœã‚’ä¿æŒ


      // ã‚»ãƒ³ã‚·ãƒ³ã‚°çµ‚äº† â†’ è§£æ
      btnStop.onclick = async () => {
        try {
          loadingDiv.style.display = 'block';
        

          // ğŸ”½ è§£æä¸­ã¯ä»–ã®è¦ç´ ã‚’éè¡¨ç¤ºã«ã™ã‚‹
          document.getElementById('liveChart').style.display = 'none';
          document.getElementById('loopPlot').style.display = 'none';
          document.getElementById('heatmap').style.display = 'none';
          document.getElementById('comparePlot').style.display = 'none';
          document.getElementById('score').textContent = '';
          document.getElementById('loopSummary').textContent = '';
          document.getElementById('loopDetails').style.display = 'none';
          document.getElementById('proExample').style.display = 'none';
          document.getElementById('btnSaveCsv').style.display = 'none';
          document.getElementById('accLabel').style.display = 'none';
          document.getElementById('gyroLabel').style.display = 'none';
          document.getElementById('proExample').style.display = 'none'; // â† ãƒ—ãƒ­ã®å‚è€ƒãƒ‡ãƒ¼ã‚¿
          document.getElementById('Title').style.display = 'none';  
          document.getElementById('csvTitle').style.display = 'none';    // â† ã‚¿ã‚¤ãƒˆãƒ«ã€Œå–å¾—ãƒ‡ãƒ¼ã‚¿ (CSVå½¢å¼)ã€
          document.getElementById('btnSaveCsv').style.display = 'none';   // â† CSVã‚’ä¿å­˜ãƒœã‚¿ãƒ³
          document.getElementById('hrPro').style.display = 'none';
          document.getElementById('hrCsv').style.display = 'none';
          document.getElementById('hrTitle').style.display = 'none';
          document.getElementById('Ken').style.display = 'none';
          document.getElementById('Rui').style.display = 'none';
          document.getElementById('Pro').style.display = 'none';
          document.getElementById('saveSection').style.display = 'block';

          accOutput.style.display = 'none';
          gyroOutput.style.display = 'none';

          await controlChar.writeValue(new Uint8Array([0]));
          await dataChar.stopNotifications();
          btnStop.disabled = true;

          document.getElementById('liveChart').style.display = 'none';

          accOutput.textContent = 'time,x,y,z\n' + acc.map(d => `${d.t},${d.ax},${d.ay},${d.az}`).join('\n');
          gyroOutput.textContent = 'time,x,y,z\n' + gyro.map(d => `${d.t},${d.gx},${d.gy},${d.gz}`).join('\n');

          

          const res = await fetch(API_BASE, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ acc, gyro })
          });
          const json = await res.json();
          lastResult = json;  // çµæœã‚’ä¿æŒ

          document.getElementById('Title').style.display = 'block';
          document.getElementById('csvTitle').style.display = 'block'; 
          document.getElementById('btnSaveCsv').style.display = 'inline-block';
          document.getElementById('accLabel').style.display = 'block';
          document.getElementById('gyroLabel').style.display = 'block';
          document.getElementById('hrPro').style.display = 'block';
          document.getElementById('hrCsv').style.display = 'block';
          document.getElementById('hrTitle').style.display = 'block';
          document.getElementById('Ken').style.display = 'block';
          document.getElementById('Rui').style.display = 'block';
          document.getElementById('Pro').style.display = 'block';

          accOutput.style.display = 'block';
          gyroOutput.style.display = 'block';

          

          if (json.loop_plot && typeof json.loop_plot === 'string' && json.loop_plot.length > 0) {
            loopPlotImg.src = `data:image/png;base64,${json.loop_plot}`;
            loopPlotImg.style.display = 'block';
          } else {
            console.warn('loop_plot is null or invalid');
            loopPlotImg.style.display = 'none';
          }


          if (json.heatmap) {
            heatmapImg.src = `data:image/png;base64,${json.heatmap}`;
            heatmapImg.style.display = 'block';
          } else {
            heatmapImg.style.display = 'none';
            console.warn('heatmap is null or undefined');
          }

          if (json.compare_plot) {
            document.getElementById('comparePlot').src = `data:image/png;base64,${json.compare_plot}`;
            document.getElementById('comparePlot').style.display = 'block';
          }


          scoreDiv.textContent = `é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢: ${json.score.toFixed(1)}ã€€ç·ãƒ«ãƒ¼ãƒ—æ•°: ${json.loop_count}ã€€${json.stable_loop !== null ? `å®‰å®šé–‹å§‹ãƒ«ãƒ¼ãƒ—: ${json.stable_loop}å‘¨ç›®` : 'å®‰å®šé–‹å§‹ãƒ«ãƒ¼ãƒ—: ãªã—'}`;
          const meanStr = (json.loop_mean_duration !== null) ? `å¹³å‡ãƒ«ãƒ¼ãƒ—æ™‚é–“: ${json.loop_mean_duration.toFixed(3)} ç§’` : `å¹³å‡ãƒ«ãƒ¼ãƒ—æ™‚é–“: ãªã—`;
          const stdStr  = (json.loop_std_duration !== null)  ? `ã€€ãƒ«ãƒ¼ãƒ—æ™‚é–“ã®æ¨™æº–åå·®: ${json.loop_std_duration.toFixed(3)} ç§’` : `ã€€ãƒ«ãƒ¼ãƒ—æ™‚é–“ã®æ¨™æº–åå·®: ãªã—`;
          document.getElementById('loopSummary').textContent = `${meanStr}\n${stdStr}`;

          const loopDetails = document.getElementById('loopDetails');
          if (json.loop_duration_list?.length) {
            loopDetails.textContent = json.loop_duration_list.join('\n');
            loopDetails.style.display = 'block';
          } else {
            loopDetails.textContent = '';
            loopDetails.style.display = 'none';
          }

           // çµæœã®è¡¨ç¤ºå‡¦ç†
          document.getElementById('Title').style.display = 'block';
          document.getElementById('btnSaveResult').style.display = 'inline-block'

        } catch (err) {
          console.error(err);
          alert('è§£æå¤±æ•—: ' + err.message);
        } finally {
          loadingDiv.style.display = 'none';
          btnConnect.disabled = false;
          btnConnect.textContent = 'ã‚‚ã†ä¸€åº¦ã‚»ãƒ³ã‚·ãƒ³ã‚°';
          document.getElementById('proExample').style.display = 'block';
        }

        // ä¿å­˜ãƒœã‚¿ãƒ³ã®å‡¦ç†
        document.getElementById('btnSaveResult').onclick = async () => {
          if (!lastResult) {
            alert('ä¿å­˜ã§ãã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“');
            return;
          }
          const name = document.getElementById('resultName').value.trim() || 'ç„¡é¡Œ';
          const payload = { ...lastResult, name };  // åå‰ã‚’è¿½åŠ 
          const res = await fetch('https://yoyo-backend.kajilab.dev/save_result', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const result = await res.json();
          if (result.status === 'saved') {
            alert(`ã€Œ${name}ã€ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ`);
          } else {
            alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        };


        // è§£æå®Œäº†å¾Œã«ä¿å­˜ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        btnStop.addEventListener('click', () => {
          btnSaveResult.style.display = 'inline-block';
        });

        

        // ä¿å­˜ãƒœã‚¿ãƒ³ã®å‡¦ç†
        document.getElementById('btnSaveCsv').onclick = () => {
          const now = new Date();
          const pad = n => n.toString().padStart(2, '0');
          const ts = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
          const accCsv = 'time,x,y,z\n' + acc.map(d => `${d.t},${d.ax},${d.ay},${d.az}`).join('\n');
          const gyroCsv = 'time,x,y,z\n' + gyro.map(d => `${d.t},${d.gx},${d.gy},${d.gz}`).join('\n');

          const saveFile = (content, filename) => {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
          };

          saveFile(accCsv, `${ts}_acc.csv`);
          saveFile(gyroCsv, `${ts}_gyro.csv`);
        };
      };
    </script>
  </div>
</body>
</html>
