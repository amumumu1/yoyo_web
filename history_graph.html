<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æŠ€èƒ½æ¨ç§»</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<style>
    body {
        text-align:center;
        font-family:sans-serif;
        margin:0;                 /* â† ä½™ç™½ã‚¼ãƒ­ */
        padding-top:15px;         /* å°‘ã—ã®ã¿ä½™ç™½ */
    }

    canvas{
        width:100vw !important;
        height:calc(100vh - 200px) !important;  /* â† ã»ã¼ç”»é¢å…¨ä½“ */
        max-width:none !important;
        display:block;
        margin:0 auto;
    }

    select{
        font-size:22px;
        padding:6px 12px;
        margin:10px;
    }

    .button{
        padding:10px 16px;
        background:#eee;
        border-radius:5px;
        border:1px solid #aaa;
        font-size:20px;
        text-decoration:none;
        color:#333;
    }
    .back-btn{
        position: fixed;
        top: 40px;      /* â† å°‘ã—ä¸‹ã¸ */
        right: 40px;    /* â† å°‘ã—å·¦ã¸ */
        padding: 10px 18px;
        background:#eee;
        border-radius:5px;
        border:1px solid #aaa;
        font-size:20px;
        text-decoration:none;
        color:#333;
        z-index: 1000;
    }


</style>


<script>
const firebaseConfig={
    apiKey:"AIzaSyCIoMI9P-shqBz6RF38L_V9PG3bl5J7Pbc",
    authDomain:"yoyo-sensing.firebaseapp.com",
    projectId:"yoyo-sensing",
    storageBucket:"yoyo-sensing.firebasestorage.app",
    messagingSenderId:"129908163482",
    appId:"1:129908163482:web:8cb1c024e25b2c9a96f023"
};
firebase.initializeApp(firebaseConfig);

const ADMIN_EMAIL = "prj.yoyo@gmail.com";

let chart = null;
let currentMetric = "total_score";
let userFilterInitialized = false;

//------------------ ã‚°ãƒ©ãƒ•æç”» ------------------
async function drawGraph(type, filterUid = ""){
    currentMetric = type; 
    const user = firebase.auth().currentUser;
    if(!user) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");

    let url =
        `https://yoyo-backend.kajilab.dev/results_user_graph?uid=${user.uid}&email=${user.email}`;
    if (filterUid) {
        url += `&filter_uid=${filterUid}`;
    }

    const res = await fetch(url);
  const data = await res.json();
    // ğŸ‘‘ ç®¡ç†è€…ã®ã¿ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆç”Ÿæˆï¼ˆ1å›ã ã‘ï¼‰
    if (user.email === ADMIN_EMAIL && !userFilterInitialized) {
        buildUserFilterForGraph(data);
        userFilterInitialized = true;
    }
    
    const labels = data.map(d => {
        const dt = new Date(d.timestamp.replace(/-/g,'/')); 
        return `${dt.getMonth()+1}/${dt.getDate()} ${dt.getHours()}:${String(dt.getMinutes()).padStart(2,"0")}`;
    });

    const values = data.map(d => d[type]);

    // â˜… æ—¥æœ¬èªãƒ©ãƒ™ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«
    const jpLabels = {
        total_score: "ç·åˆè©•ä¾¡",
        raw_self_distance: "è‡ªå·±é¡ä¼¼åº¦ï¼ˆè·é›¢ï¼‰",
        pro_distance_mean: "ãƒ—ãƒ­é¡ä¼¼åº¦ï¼ˆè·é›¢ï¼‰",
        loop_mean_duration: "å¹³å‡ãƒ«ãƒ¼ãƒ—æ™‚é–“",
        loop_std_duration: "ãƒ«ãƒ¼ãƒ—æ™‚é–“ã®ã°ã‚‰ã¤ã",
        stable_loop: "å®‰å®šé–‹å§‹ãƒ«ãƒ¼ãƒ—",
        snap_median: "æ‰‹é¦–ã‚’è¿”ã™å¼·ã•ï¼ˆä¸­å¤®å€¤ï¼‰",
        snap_std: "æ‰‹é¦–ã‚’è¿”ã™å¼·ã•ã®ã°ã‚‰ã¤ã"
    };

    // â˜… å˜ä½ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ—¢å­˜ï¼‰
    const units = {
        total_score: "ç‚¹",
        raw_self_distance: "",
        pro_distance_mean: "",
        loop_mean_duration: "ç§’",
        loop_std_duration: "ç§’",
        stable_loop: "å›",
        snap_median: "m/sÂ²",
        snap_std: "m/sÂ²"
    };

    // â˜… yè»¸ãƒ©ãƒ™ãƒ«ï¼ˆæ—¥æœ¬èªï¼‹å˜ä½ï¼‰
    const yLabel = units[type]
        ? `${jpLabels[type]}ï¼ˆ${units[type]}ï¼‰`
        : jpLabels[type];


    if(chart) chart.destroy();

    // â˜… yè»¸è¨­å®šï¼ˆç·åˆç‚¹ã ã‘ 0-100 å›ºå®šï¼‰
    const yScale = {
        title:{ display:true, text:yLabel, font:{size:20} },
        ticks:{ font:{size:18} }
    };

    if(type === "total_score"){
        yScale.min = 0;
        yScale.max = 100;
    }


    chart=new Chart(document.getElementById("graph"),{
        type:"line",
        data:{ labels, datasets:[{
            label:type,
            data:values,
            borderWidth:3,
            pointRadius:5,
            fill:false
        }]},
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins: {
                legend: { display: false }
            },

            scales:{
                x:{
                    title:{display:true,text:"æ—¥æ™‚", font:{size:20}},
                    ticks:{ font:{size:18}, maxRotation:45, minRotation:30, autoSkip:true, autoSkipPadding:10 }
                },
                y:yScale
            }
        }
    });
}

function buildUserFilterForGraph(data) {
  const select = document.getElementById("user-filter");
  select.innerHTML = `<option value="">ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>`;

  const users = {};
  data.forEach(d => {
    if (d.user_id) {
      users[d.user_id] = d.user_name || d.email || d.user_id;
    }
  });

  for (const [uid, name] of Object.entries(users)) {
    const opt = document.createElement("option");
    opt.value = uid;
    opt.textContent = name;
    select.appendChild(opt);
  }

  select.style.display = "inline-block";

  // ğŸ” åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å†æç”»
  select.addEventListener("change", e => {
    const metric = document.querySelector("select[onchange]").value;
    drawGraph(metric, e.target.value);
  });
}


document.addEventListener("DOMContentLoaded", () => {
  firebase.auth().onAuthStateChanged(user => {
    if (!user) return location.href = "login.html";
    drawGraph("total_score");
  });
});

</script>
</head>

<body>

<h1>ğŸ“ˆ æŠ€èƒ½æ¨ç§»ã‚°ãƒ©ãƒ•</h1>

<select id="user-filter" style="display:none;">
  <option value="">ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
</select>


<select onchange="drawGraph(this.value, document.getElementById('user-filter').value)">
    <option value="total_score">ç·åˆè©•ä¾¡</option>
    <option value="raw_self_distance">è‡ªå·±é¡ä¼¼åº¦ï¼ˆè·é›¢ï¼‰</option>
    <option value="pro_distance_mean">ãƒ—ãƒ­é¡ä¼¼åº¦ï¼ˆè·é›¢ï¼‰</option>
    <option value="loop_mean_duration">å¹³å‡ãƒ«ãƒ¼ãƒ—æ™‚é–“</option>
    <option value="loop_std_duration">ãƒ«ãƒ¼ãƒ—ã°ã‚‰ã¤ã</option>
    <option value="stable_loop">å®‰å®šé–‹å§‹ãƒ«ãƒ¼ãƒ—</option>
    <option value="snap_median">æ‰‹é¦–ã‚’è¿”ã™å¼·ã•</option>
    <option value="snap_std">æ‰‹é¦–ã‚’è¿”ã™å¼·ã•ã®ã°ã‚‰ã¤ã</option>
</select>


<br>
<a href="viewer.html" class="back-btn">å±¥æ­´ã«æˆ»ã‚‹</a>


<canvas id="graph"></canvas>

</body>
</html>
