<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé›†è¨ˆçµæœ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
      overflow-x: hidden;
    }
    table {
      margin: 10px auto;
      border-collapse: collapse;
      font-size: 18px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
    }
    h2 {
      margin-top: 40px;
    }
    canvas {
      margin: 30px auto;
      width: 900px;
      height: 450px;
      display: block;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé›†è¨ˆçµæœ</h1>
  <a href="viewer.html" class="button">å±¥æ­´ä¸€è¦§ã«æˆ»ã‚‹</a>

  <h2>å¹´é½¢åˆ†å¸ƒ</h2>
  <canvas id="ageChart"></canvas>

  <h2>ãƒ¨ãƒ¼ãƒ¨ãƒ¼æ­´ã¨ã‚¹ã‚³ã‚¢ã®é–¢ä¿‚</h2>
  <canvas id="historyScoreChart"></canvas>

  <h2>å¾—æ„ä¸å¾—æ„ã¨ã‚¹ã‚³ã‚¢ã®é–¢ä¿‚</h2>
  <canvas id="skillScoreChart"></canvas>


  <div id="summary"></div>

  <script>
    let historyChartInstance = null;
    let skillChartInstance = null;

    async function loadSurveySummary() {
      const res = await fetch("https://yoyo-backend.kajilab.dev/survey_summary");
      const data = await res.json();
      console.log("ğŸ”¹ survey_summary:", data);

      const container = document.getElementById("summary");
      container.innerHTML = `
        <h2>äº‹å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h2>
        ${renderSummaryTable(data.pre)}
        <h2>äº‹å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h2>
        ${renderSummaryTable(data.post)}
      `;

      // å¹´é½¢åˆ†å¸ƒ
      if (data.pre?.length) drawAgeChart(data.pre);

      // ã‚¹ã‚³ã‚¢ä»˜ãã®æ•£å¸ƒå›³
      if (data.pre?.length) {
    drawHistoryScoreChart(data.pre);
    drawSkillScoreChart(data.pre); // â† ã“ã‚Œè¿½åŠ ï¼
    }

    }

    function renderSummaryTable(surveys) {
      if (!surveys?.length) return "<p>ãƒ‡ãƒ¼ã‚¿ãªã—</p>";
      const counts = {};
      surveys.forEach(s => {
        for (const [k, v] of Object.entries(s)) {
          const val = Array.isArray(v) ? v.join(", ") : v;
          counts[k] = counts[k] || {};
          counts[k][val] = (counts[k][val] || 0) + 1;
        }
      });
      return `<table>${
        Object.entries(counts)
          .map(([q, vals]) => 
            `<tr><th>${q}</th><td>${Object.entries(vals)
              .map(([ans, num]) => `${ans}: ${num}`).join("<br>")}</td></tr>`)
          .join("")
      }</table>`;
    }

    // === å¹´é½¢åˆ†å¸ƒ ===
    function drawAgeChart(preSurveys) {
      const toHalfWidth = (str) => str.replace(/[ï¼-ï¼™]/g, s => 
        String.fromCharCode(s.charCodeAt(0) - 0xFEE0)
      );

      const ages = preSurveys
        .map(s => parseInt(toHalfWidth(String(s.age || "")).trim()))
        .filter(n => !isNaN(n) && n > 0 && n < 100);

      const bins = {
        "10æ­³æœªæº€": 0, "10ä»£": 0, "20ä»£": 0, "30ä»£": 0,
        "40ä»£": 0, "50ä»£": 0, "60ä»£": 0, "70ä»£": 0
      };

      ages.forEach(a => {
        if (a < 10) bins["10æ­³æœªæº€"]++;
        else if (a < 20) bins["10ä»£"]++;
        else if (a < 30) bins["20ä»£"]++;
        else if (a < 40) bins["30ä»£"]++;
        else if (a < 50) bins["40ä»£"]++;
        else if (a < 60) bins["50ä»£"]++;
        else if (a < 70) bins["60ä»£"]++;
        else bins["70ä»£"]++;
      });

      const ctx = document.getElementById("ageChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: Object.keys(bins),
          datasets: [{
            label: "å¹´é½¢åˆ†å¸ƒï¼ˆ10æ­³åˆ»ã¿ï¼‰",
            data: Object.values(bins),
            backgroundColor: "rgba(54, 162, 235, 0.6)"
          }]
        },
        options: { responsive: false, scales: { y: { beginAtZero: true } } }
      });
    }

    // === æ•£å¸ƒå›³ ===
    function drawHistoryScoreChart(preSurveys) {
  if (historyChartInstance) historyChartInstance.destroy();

  // --- å…¨è§’â†’åŠè§’ï¼‹æ•´å½¢ ---
  const normalize = (str) =>
    (str || "")
      .replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
      .replace(/[ã€œï½]/g, "ï½")
      .replace(/(ã‚«æœˆ|ãƒ¶æœˆ)/g, "ã‹æœˆ")
      .replace(/\s+/g, "")
      .trim();

  const categories = [
    "ã¯ã˜ã‚ã¦",
    "3ã‹æœˆæœªæº€",
    "3ã‹æœˆï½åŠå¹´",
    "åŠå¹´ï½1å¹´",
    "1ï½2å¹´",
    "3ï½4å¹´",
    "5å¹´ä»¥ä¸Š"
  ];

  const mapHistoryToIndex = (history) => {
    const h = normalize(history);
    return categories.findIndex(cat => h === cat);
  };

  // --- ãƒ‡ãƒ¼ã‚¿ç‚¹ã‚’æ•°å€¤è»¸ã«å¤‰æ› ---
  const numericData = preSurveys
    .map(s => {
      const idx = mapHistoryToIndex(s.history);
      const score = parseFloat(s.total_score);
      return idx >= 0 && !isNaN(score) ? { x: idx, y: score } : null;
    })
    .filter(Boolean);

  if (!numericData.length) {
    console.warn("âš ï¸ æ•£å¸ƒå›³ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚");
    return;
  }

  // --- å›å¸°ç›´ç·šã‚’è¨ˆç®—ï¼ˆæœ€å°äºŒä¹—æ³•ï¼‰ ---
  const n = numericData.length;
  const meanX = numericData.reduce((a, p) => a + p.x, 0) / n;
  const meanY = numericData.reduce((a, p) => a + p.y, 0) / n;

  let num = 0, den = 0;
  numericData.forEach(p => {
    num += (p.x - meanX) * (p.y - meanY);
    den += (p.x - meanX) ** 2;
  });

  const slope = num / den; // å‚¾ã
  const intercept = meanY - slope * meanX; // åˆ‡ç‰‡

  // --- ç›¸é–¢ä¿‚æ•° r ---
  const numerator = numericData.reduce((a, p) => a + (p.x - meanX) * (p.y - meanY), 0);
  const denomX = Math.sqrt(numericData.reduce((a, p) => a + (p.x - meanX) ** 2, 0));
  const denomY = Math.sqrt(numericData.reduce((a, p) => a + (p.y - meanY) ** 2, 0));
  const r = numerator / (denomX * denomY);

  console.log(`âœ… å›å¸°ç·š: y = ${slope.toFixed(2)}x + ${intercept.toFixed(2)}, r=${r.toFixed(3)}`);

  // --- å›å¸°ç›´ç·šãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ ---
  const linePoints = [
    { x: 0, y: slope * 0 + intercept },
    { x: categories.length - 1, y: slope * (categories.length - 1) + intercept }
  ];

  // --- æç”» ---
  const ctx = document.getElementById("historyScoreChart").getContext("2d");
  historyChartInstance = new Chart(ctx, {
    type: "scatter",
    data: {
      datasets: [
        {
          label: "ãƒ¨ãƒ¼ãƒ¨ãƒ¼æ­´ã¨ã‚¹ã‚³ã‚¢",
          data: numericData.map(p => ({ x: categories[p.x], y: p.y })),
          backgroundColor: "rgba(255, 99, 132, 0.7)",
          borderColor: "rgba(255, 99, 132, 1)",
          pointRadius: 7
        },
        {
          label: `å›å¸°ç·šï¼ˆr=${r.toFixed(3)}ï¼‰`,
          type: "line",
          data: linePoints.map(p => ({ x: categories[p.x], y: p.y })),
          borderColor: "rgba(0, 0, 0, 0.8)",
          borderWidth: 2,
          fill: false,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { boxWidth: 20 } },
        title: {
          display: true,
          text: `ç›¸é–¢ä¿‚æ•° r = ${r.toFixed(3)}ï¼ˆå›å¸°å¼: y = ${slope.toFixed(2)}x + ${intercept.toFixed(2)}ï¼‰`,
          padding: { top: 10, bottom: 10 },
          font: { size: 18 }
        }
      },
      scales: {
        x: {
          type: "category",
          labels: categories,
          title: { display: true, text: "ãƒ¨ãƒ¼ãƒ¨ãƒ¼æ­´ï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ï¼‰" }
        },
        y: {
          title: { display: true, text: "ç·åˆè©•ä¾¡ï¼ˆç‚¹ï¼‰" },
          beginAtZero: true,
          suggestedMax: 100
        }
      }
    }
  });
}

// === å¾—æ„ä¸å¾—æ„ã¨ã‚¹ã‚³ã‚¢ã®æ•£å¸ƒå›³ ===
function drawSkillScoreChart(preSurveys) {
  if (skillChartInstance) skillChartInstance.destroy();

  // --- å…¨è§’â†’åŠè§’ï¼‹æ•´å½¢ ---
  const normalize = (str) =>
    (str || "")
      .replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
      .replace(/[ã€œï½]/g, "ï½")
      .replace(/\s+/g, "")
      .trim();

  const categories = [
    "ã‚¹ãƒªãƒ¼ãƒ—ãŒå¾—æ„",
    "ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ãŒå¾—æ„",
    "ã©ã¡ã‚‰ã‚‚å¾—æ„",
    "ã©ã¡ã‚‰ã‚‚è‹¦æ‰‹",
    "ã‚ã‹ã‚‰ãªã„"
  ];

  const mapSkillToIndex = (skill) => {
    const s = normalize(skill);
    return categories.findIndex(cat => s === cat);
  };

  // --- ãƒ‡ãƒ¼ã‚¿ç‚¹ã‚’æ•°å€¤è»¸ã«å¤‰æ› ---
  const numericData = preSurveys
    .map(s => {
      const idx = mapSkillToIndex(s.skill);
      const score = parseFloat(s.total_score);
      return idx >= 0 && !isNaN(score) ? { x: idx, y: score } : null;
    })
    .filter(Boolean);

  if (!numericData.length) {
    console.warn("âš ï¸ æ•£å¸ƒå›³ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ï¼ˆskillæœªè¨˜å…¥ã¾ãŸã¯å½¢å¼ä¸ä¸€è‡´ï¼‰ã€‚");
    return;
  }

  // --- å›å¸°ç›´ç·šã‚’è¨ˆç®— ---
  const n = numericData.length;
  const meanX = numericData.reduce((a, p) => a + p.x, 0) / n;
  const meanY = numericData.reduce((a, p) => a + p.y, 0) / n;

  let num = 0, den = 0;
  numericData.forEach(p => {
    num += (p.x - meanX) * (p.y - meanY);
    den += (p.x - meanX) ** 2;
  });

  const slope = num / den;
  const intercept = meanY - slope * meanX;

  // --- ç›¸é–¢ä¿‚æ•° r ---
  const numerator = numericData.reduce((a, p) => a + (p.x - meanX) * (p.y - meanY), 0);
  const denomX = Math.sqrt(numericData.reduce((a, p) => a + (p.x - meanX) ** 2, 0));
  const denomY = Math.sqrt(numericData.reduce((a, p) => a + (p.y - meanY) ** 2, 0));
  const r = numerator / (denomX * denomY);

  console.log(`âœ… å¾—æ„ä¸å¾—æ„ å›å¸°ç·š: y=${slope.toFixed(2)}x+${intercept.toFixed(2)}, r=${r.toFixed(3)}`);

  const linePoints = [
    { x: 0, y: slope * 0 + intercept },
    { x: categories.length - 1, y: slope * (categories.length - 1) + intercept }
  ];

  const ctx = document.getElementById("skillScoreChart").getContext("2d");
  skillChartInstance = new Chart(ctx, {
    type: "scatter",
    data: {
      datasets: [
        {
          label: "å¾—æ„ä¸å¾—æ„ã¨ã‚¹ã‚³ã‚¢",
          data: numericData.map(p => ({ x: categories[p.x], y: p.y })),
          backgroundColor: "rgba(75, 192, 192, 0.7)",
          borderColor: "rgba(75, 192, 192, 1)",
          pointRadius: 7
        },
        {
          label: `å›å¸°ç·šï¼ˆr=${r.toFixed(3)}ï¼‰`,
          type: "line",
          data: linePoints.map(p => ({ x: categories[p.x], y: p.y })),
          borderColor: "rgba(0, 0, 0, 0.8)",
          borderWidth: 2,
          fill: false,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { boxWidth: 20 } },
        title: {
          display: true,
          text: `ç›¸é–¢ä¿‚æ•° r = ${r.toFixed(3)}ï¼ˆå›å¸°å¼: y = ${slope.toFixed(2)}x + ${intercept.toFixed(2)}ï¼‰`,
          font: { size: 18 }
        }
      },
      scales: {
        x: {
          type: "category",
          labels: categories,
          title: { display: true, text: "å¾—æ„ä¸å¾—æ„ï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ï¼‰" }
        },
        y: {
          title: { display: true, text: "ç·åˆè©•ä¾¡ï¼ˆç‚¹ï¼‰" },
          beginAtZero: true,
          suggestedMax: 100
        }
      }
    }
  });
}




    loadSurveySummary();
  </script>
</body>
</html>
