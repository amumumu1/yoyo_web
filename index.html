<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>インサイド・ループ技能評価</title>
  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      text-align: center;
    }
    body { font-family: 'Hiragino Sans', sans-serif; padding: 20px; }
    button { margin-right: 10px; padding: 10px; font-size: 25px; }
    #score, #loopSummary, #loopDetails, #proDistance { font-size: 30px; }
    pre { background: #f4f4f4; padding: 10px; max-height: 200px; overflow: auto; }

    /* ローディング＋プログレスバー */
    #loading {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 10000;
      width: 80%;
      max-width: 400px;
    }
    #loadingText {
      font-size: 24px;
      margin-bottom: 8px;
    }
    #progressContainer {
      width: 100%;
      background: #eee;
      border-radius: 4px;
      overflow: hidden;
      height: 16px;
    }
    #progressBar {
      width: 0%;
      height: 100%;
      background: #3498db;
      transition: width 0.3s;
    }

    /* 非表示固定要素 */
    #heatmap, #comparePlot, #CombinedContainer { display: none !important; }
    #loopPlot, #comparePlot {
      display: none;
      margin: 0 auto;
      width: auto;
      max-width: 100%;
      margin-bottom: 40px;
    }

    h2 { font-size: 40px; }
    h3 { font-size: 30px; }
    .heatmap-grid {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
      flex-wrap: nowrap;
      margin: 20px auto;
      max-width: 100%;
    }
    .heatmap-grid div {
      flex: 1;
      max-width: 50%;
      text-align: center;
    }
    .heatmap-grid img {
      width: 100%;
      height: auto;
    }
    #radarChart {
      display: block;
      margin: 0 auto 30px;
      width: 600px;
      max-width: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <button id="btnConnect">接続 &amp; センシング開始</button>
    <input type="file" id="csvFiles" accept=".csv" multiple style="display:none;">
    <button id="btnCsvMode">CSVから解析</button>
    <button id="btnStop" disabled>センシング終了 &amp; 解析</button>
    <button id="btnRi" onclick="location.href='/viewer'">履歴を見る</button>

    <!-- ローディング＋プログレスバー -->
    <div id="loading">
      <p id="loadingText">解析中…</p>
      <div id="progressContainer">
        <div id="progressBar"></div>
      </div>
    </div>

    <!-- リアルタイムグラフ -->
    <h3 id="accTitle" style="display:none;">加速度</h3>
    <canvas id="accChart" width="800" height="150" style="display:none;"></canvas>
    <h3 id="gyroTitle" style="display:none;">角速度</h3>
    <canvas id="gyroChart" width="800" height="150" style="display:none;"></canvas>

    <hr id="hrTitle" style="display:none;border:none;border-top:2px solid black;width:100%;margin:40px 0;" />
    <div id="saveSection" style="display:none;">
      <input type="text" id="resultName" placeholder="結果の名前を入力" style="font-size:16px;padding:5px;width:200px;" />
      <button id="btnSaveResult" style="display:none;">結果を保存する</button>
    </div>

    <h2 id="Title" style="display:none;">解析結果</h2>
    <h3 id="RadarTitle" style="display:none;">総合評価（レーダーチャート）</h3>
    <img id="radarChart" style="display:none;width:600px;max-width:100%;margin-bottom:30px;" />

    <div id="score"></div>
    <div id="proDistance"></div>
    <div id="loopSummary"></div>
    <pre id="loopDetails" style="display:none;"></pre>
    <h3 id="Ken" style="display:none;">ループ検出</h3>
    <img id="loopPlot" style="display:none;width:1200px;max-width:100%;" />
    <h3 id="HeatmapTitle" style="display:none;">ループ類似度</h3>
    <div id="Rui" class="heatmap-grid" style="display:none;">
      <div>
        <h4>自己比較</h4>
        <img id="selfHeatmap" alt="自分 vs 自分ヒートマップ" />
      </div>
      <div>
        <h4>対角成分：プロ比較</h4>
        <img id="proHeatmap" alt="プロ距離ヒートマップ" />
      </div>
    </div>

    <hr id="hrPro" style="display:none;border:none;border-top:2px solid black;width:100%;margin:40px 0;" />
    <div id="proExample" style="display:none;">
      <h2>参考データ（プロ）</h2>
      <h3>平均ループ時間: 0.429 秒</h3>
      <h3>ループ時間の標準偏差: 0.072 秒</h3>
      <h3>プロのループ検出</h3>
      <img src="/pro_segu.png" alt="プロのループ検出図" style="width:100%;max-width:1200px;" />
      <h3>プロのヒートマップ</h3>
      <img src="/pro_heatmap.png" alt="プロのヒートマップ" style="width:100%;max-width:800px;" />
      <h3>プロの実演映像</h3>
      <video controls style="max-width:60%;">
        <source src="/pro.mp4" type="video/mp4" />
        お使いのブラウザは動画に対応していません。
      </video>
    </div>

    <hr id="hrCsv" style="display:none;border:none;border-top:2px solid black;width:100%;margin:40px 0;" />
    <h2 id="csvTitle" style="display:none;">取得データ (CSV形式)</h2>
    <button id="btnSaveCsv" style="display:none;">CSVを保存</button>
    <h3 id="accLabel" style="display:none;">加速度データ</h3>
    <pre id="accOutput" style="display:none;"></pre>
    <h3 id="gyroLabel" style="display:none;">角速度データ</h3>
    <pre id="gyroOutput" style="display:none;"></pre>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // DOM要素取得
    const btnConnect    = document.getElementById('btnConnect');
    const btnCsvMode    = document.getElementById('btnCsvMode');
    const btnStop       = document.getElementById('btnStop');
    const btnRi         = document.getElementById('btnRi');
    const csvInput      = document.getElementById('csvFiles');
    const loadingDiv    = document.getElementById('loading');
    const progBar       = document.getElementById('progressBar');
    const progText      = document.getElementById('loadingText');
    const btnSaveResult = document.getElementById('btnSaveResult');
    const btnSaveCsv    = document.getElementById('btnSaveCsv');
    const scoreDiv      = document.getElementById('score');
    const loopPlotImg   = document.getElementById('loopPlot');
    const accOutput     = document.getElementById('accOutput');
    const gyroOutput    = document.getElementById('gyroOutput');
    const BACKEND = 'https://yoyo-backend.kajilab.dev';

    let lastResult = null;
    let device, dataChar, controlChar;
    let buffer = '';
    const acc = [], gyro = [];

    // Chart.js セットアップ
    const accCtx  = document.getElementById('accChart').getContext('2d');
    const gyroCtx = document.getElementById('gyroChart').getContext('2d');
    const accData = {
      labels: [],
      datasets: [
        { label: 'ax', data: [], borderColor: 'blue',   fill: false, pointRadius: 0 },
        { label: 'ay', data: [], borderColor: 'skyblue',fill: false, pointRadius: 0 },
        { label: 'az', data: [], borderColor: 'navy',   fill: false, pointRadius: 0 }
      ]
    };
    const gyroData = {
      labels: [],
      datasets: [
        { label: 'gx', data: [], borderColor: 'red',    fill: false, pointRadius: 0 },
        { label: 'gy', data: [], borderColor: 'orange', fill: false, pointRadius: 0 },
        { label: 'gz', data: [], borderColor: 'darkred',fill: false, pointRadius: 0 }
      ]
    };
    const accChart  = new Chart(accCtx,  { type: 'line', data: accData,  options: { animation: false, scales: { x:{ display:false } } } });
    const gyroChart = new Chart(gyroCtx, { type: 'line', data: gyroData, options: { animation: false, scales: { x:{ display:false } } } });

    // Bluetooth UUID
    const SERVICE_UUID = '88888888-4abd-ba0d-b7c6-ff0a00200021';
    const CONTROL_UUID = '88888888-4abd-ba0d-b7c6-ff0a00200022';
    const DATA_UUID    = '88888888-4abd-ba0d-b7c6-ff0a00200023';

    // ----------------------------------------------------
    // CSVモード：ファイル選択で解析スタート
    // ----------------------------------------------------
    btnCsvMode.onclick = () => csvInput.click();
    csvInput.onchange = async () => {
      if (csvInput.files.length < 2) {
        alert("加速度CSVと角速度CSVを選択してください");
        return;
      }
      resetUIBeforeMeasure();
      btnConnect.style.display = btnCsvMode.style.display = btnStop.style.display = btnRi.style.display = 'none';
      loadingDiv.style.display = 'block';
      progBar.style.width = '0%';
      progText.textContent = '解析準備中…';

      // CSV読み込み＆JSON変換
      const [text0, text1] = await Promise.all([
        csvInput.files[0].text(),
        csvInput.files[1].text()
      ]);
      const accDataJson  = csvToJson(text0, true);
      const gyroDataJson = csvToJson(text1, false);

      // OK：バックティックで `${BACKEND}` を展開
      const res = await fetch(`${BACKEND}/start_analysis`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ acc: accDataJson, gyro: gyroDataJson })
      });




      // ステータスチェック
      if (!res.ok) {
        alert(`解析サーバーエラー: ${res.status}`);
        return;
      }
      const { task_id } = await res.json();

      // 進捗ポーリング
      pollProgress(task_id);
    };

    // ----------------------------------------------------
    // Bluetoothモード：停止ボタンで解析スタート
    // ----------------------------------------------------
    btnStop.onclick = async () => {
      try {
        await controlChar.writeValue(new Uint8Array([0]));
        await dataChar.stopNotifications();
      } catch (err) {
        console.error('デバイス停止エラー:', err);
      }
      hideMeasureUI();
      resetUIBeforeMeasure();
      btnConnect.style.display = btnCsvMode.style.display = btnStop.style.display = btnRi.style.display = 'none';
      loadingDiv.style.display = 'block';
      progBar.style.width = '0%';
      progText.textContent = '解析準備中…';

      // 非同期タスク起動
     // OK：バックティックで `${BACKEND}` を展開
      const res = await fetch(`${BACKEND}/start_analysis`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ acc: acc, gyro: gyro })
      });
      if (!res.ok) {
        alert(`解析サーバーエラー: ${res.status}`);
        return;
      }

      const { task_id } = await res.json();

      // 進捗ポーリング
      pollProgress(task_id);
    };

    // ----------------------------------------------------
    // CSV→JSON 変換ヘルパー
    // ----------------------------------------------------
    function csvToJson(csvText, isAcc = true) {
      const lines = csvText.trim().split('\n');
      lines.shift();
      return lines.map(line => {
        const cols = line.split(',');
        return isAcc
          ? { t:+cols[0], ax:+cols[1], ay:+cols[2], az:+cols[3] }
          : { t:+cols[0], gx:+cols[1], gy:+cols[2], gz:+cols[3] };
      });
    }

    // ----------------------------------------------------
    // UIリセット（グラフ非表示・配列クリアなど）
    // ----------------------------------------------------
    function resetUIBeforeMeasure() {
      document.getElementById('loopPlot').style.display = 'none';
      scoreDiv.textContent = '';
      document.getElementById('proDistance').textContent = '';
      document.getElementById('loopSummary').textContent = '';
      document.getElementById('loopDetails').style.display = 'none';
      document.getElementById('proExample').style.display = 'none';
      document.getElementById('Title').style.display = 'none';
      document.getElementById('csvTitle').style.display = 'none';
      btnSaveCsv.style.display = 'none';
      document.getElementById('accLabel').style.display = 'none';
      document.getElementById('gyroLabel').style.display = 'none';
      accOutput.style.display = 'none';
      gyroOutput.style.display = 'none';
      document.getElementById('hrPro').style.display = 'none';
      document.getElementById('hrCsv').style.display = 'none';
      document.getElementById('hrTitle').style.display = 'none';
      document.getElementById('Ken').style.display = 'none';
      document.getElementById('HeatmapTitle').style.display = 'none';
      document.getElementById('Rui').style.display = 'none';
      document.getElementById('saveSection').style.display = 'none';
      document.getElementById('radarChart').style.display = 'none';
      document.getElementById('RadarTitle').style.display = 'none';
      acc.length = 0;
      gyro.length = 0;
      accData.labels.length = 0;
      accData.datasets.forEach(ds => ds.data.length = 0);
      gyroData.labels.length = 0;
      gyroData.datasets.forEach(ds => ds.data.length = 0);
      accChart.update();
      gyroChart.update();
    }

    // ----------------------------------------------------
    // 測定UI非表示
    // ----------------------------------------------------
    function hideMeasureUI() {
      document.getElementById('accChart').style.display = 'none';
      document.getElementById('gyroChart').style.display = 'none';
      document.getElementById('accTitle').style.display = 'none';
      document.getElementById('gyroTitle').style.display = 'none';
      document.getElementById('saveSection').style.display = 'none';
    }

    // ----------------------------------------------------
    // 進捗ポーリング
    // ----------------------------------------------------
    async function pollProgress(taskId) {
      const res  = await fetch(`${BACKEND}/progress/${taskId}`);
          if (!res.ok) {
        console.error(`進捗取得エラー: ${res.status}`);
        return;
      }
      const json = await res.json();
      const p    = json.progress ?? 0;
      progBar.style.width       = p + '%';
      progText.textContent      = `解析中… ${p}%`;

      if (json.state === 'SUCCESS') {
        lastResult = json.result;
        renderResult(json.result);
        loadingDiv.style.display = 'none';
      } else {
        setTimeout(() => pollProgress(taskId), 500);
      }
    }

    // ----------------------------------------------------
    // Bluetooth通知ハンドラ
    // ----------------------------------------------------
    function handleNotify(event) {
      buffer += new TextDecoder().decode(event.target.value);
      const lines = buffer.split('\n');
      buffer = lines.pop();
      for (const line of lines) {
        const p = line.trim().split(',').map(Number);
        if (p.length === 7) {
          const [t, ax, ay, az, gx, gy, gz] = p;
          acc.push({ t, ax, ay, az });
          gyro.push({ t, gx, gy, gz });
          accData.labels.push('');
          gyroData.labels.push('');
          accData.datasets[0].data.push(ax);
          accData.datasets[1].data.push(ay);
          accData.datasets[2].data.push(az);
          gyroData.datasets[0].data.push(gx);
          gyroData.datasets[1].data.push(gy);
          gyroData.datasets[2].data.push(gz);
          if (accData.labels.length > 100) {
            accData.labels.shift();
            accData.datasets.forEach(ds => ds.data.shift());
          }
          if (gyroData.labels.length > 100) {
            gyroData.labels.shift();
            gyroData.datasets.forEach(ds => ds.data.shift());
          }
          accChart.update();
          gyroChart.update();
        }
      }
    }

    // ----------------------------------------------------
    // 結果描画
    // ----------------------------------------------------
    function renderResult(json) {
      lastResult = json;
      document.getElementById('Title').style.display     = 'block';
      document.getElementById('csvTitle').style.display  = 'block';
      btnSaveCsv.style.display                           = 'inline-block';
      document.getElementById('accLabel').style.display  = 'block';
      document.getElementById('gyroLabel').style.display = 'block';
      document.getElementById('hrPro').style.display     = 'block';
      document.getElementById('hrCsv').style.display     = 'block';
      document.getElementById('hrTitle').style.display   = 'block';
      document.getElementById('Ken').style.display       = 'block';
      document.getElementById('HeatmapTitle').style.display = 'block';
      document.getElementById('Rui').style.display       = 'flex';
      accOutput.style.display = 'block';
      gyroOutput.style.display = 'block';
      btnSaveResult.style.display = 'inline-block';
      document.getElementById('proExample').style.display = 'block';

      // レーダーチャート
      if (json.radar_chart && typeof json.radar_chart === 'string') {
        const img = document.getElementById('radarChart');
        img.src     = `data:image/png;base64,${json.radar_chart}`;
        img.style.display = 'block';
        const title = document.getElementById('RadarTitle');
        title.textContent = `総合評価: ${json.total_score.toFixed(1)} 点`;
        title.style.display = 'block';
      }

      // ループプロット
      if (json.loop_plot) {
        loopPlotImg.src = `data:image/png;base64,${json.loop_plot}`;
        loopPlotImg.style.display = 'block';
      }

      // ヒートマップ
      if (json.self_heatmap) {
        const el = document.getElementById('selfHeatmap');
        el.src     = `data:image/png;base64,${json.self_heatmap}`;
        el.style.display = 'block';
      }
      if (json.pro_heatmap) {
        const el = document.getElementById('proHeatmap');
        el.src     = `data:image/png;base64,${json.pro_heatmap}`;
        el.style.display = 'block';
      }

      // 統計情報
      scoreDiv.textContent = `類似度スコア: ${json.score.toFixed(1)}　総ループ数: ${json.loop_count}　${
        json.stable_loop !== null
          ? `安定開始ループ: ${json.stable_loop}周目`
          : '安定開始ループ: なし'
      }`;
      const avgEl = document.getElementById('proDistance');
      avgEl.textContent = json.pro_distance_mean
        ? `プロとの平均距離: ${json.pro_distance_mean.toFixed(1)}`
        : 'プロとの平均距離: なし';
      avgEl.style.display = 'block';

      const meanStr = json.loop_mean_duration !== null
        ? `平均ループ時間: ${json.loop_mean_duration.toFixed(3)} 秒`
        : '平均ループ時間: なし';
      const stdStr = json.loop_std_duration !== null
        ? `　ループ時間の標準偏差: ${json.loop_std_duration.toFixed(3)} 秒`
        : '　ループ時間の標準偏差: なし';
      document.getElementById('loopSummary').textContent = `${meanStr}\n${stdStr}`;

      const detailsEl = document.getElementById('loopDetails');
      if (json.loop_duration_list?.length) {
        detailsEl.textContent   = json.loop_duration_list.join('\n');
        detailsEl.style.display = 'block';
      } else {
        detailsEl.textContent   = '';
        detailsEl.style.display = 'none';
      }

      if (json.snap_median !== null && json.snap_std !== null) {
        const sumEl = document.getElementById('loopSummary');
        sumEl.innerHTML += `
          <p>手首を返す強さ（ループごとの中央値）：${json.snap_median.toFixed(2)} m/s²</p>
          <p>手首を返す強さ（ループごとのばらつき）：${json.snap_std.toFixed(2)} m/s²</p>
        `;
      }

      // 保存ボタン表示
      document.getElementById('saveSection').style.display = 'block';
      btnSaveResult.style.display = 'inline-block';
    }

    // ----------------------------------------------------
    // 結果保存
    // ----------------------------------------------------
    async function saveResult() {
      if (!lastResult) {
        alert('保存できる結果がありません');
        return;
      }
      const name = document.getElementById('resultName').value.trim() || '無題';
      const accCsv  = 'time,x,y,z\n' + acc.map(d => `${d.t},${d.ax},${d.ay},${d.az}`).join('\n');
      const gyroCsv = 'time,x,y,z\n' + gyro.map(d => `${d.t},${d.gx},${d.gy},${d.gz}`).join('\n');
      const payload = { ...lastResult, name, acc_csv: accCsv, gyro_csv: gyroCsv };
      const res = await fetch('https://yoyo-backend.kajilab.dev/save_result', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      alert(result.status === 'saved'
        ? `「${name}」として保存しました`
        : '保存に失敗しました'
      );
    }
    btnSaveResult.onclick = saveResult;

    // ----------------------------------------------------
    // CSVダウンロード
    // ----------------------------------------------------
    btnSaveCsv.onclick = () => {
      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const ts = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
      const accCsv  = 'time,x,y,z\n' + acc.map(d => `${d.t},${d.ax},${d.ay},${d.az}`).join('\n');
      const gyroCsv = 'time,x,y,z\n' + gyro.map(d => `${d.t},${d.gx},${d.gy},${d.gz}`).join('\n');
      const saveFile = (content, filename) => {
        const blob = new Blob([content], { type: 'text/csv' });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href     = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      };
      saveFile(accCsv,  `${ts}_acc.csv`);
      saveFile(gyroCsv, `${ts}_gyro.csv`);
    };

    // ----------------------------------------------------
    // Bluetooth接続＆通知開始
    // ----------------------------------------------------
    btnConnect.onclick = async () => {
      resetUIBeforeMeasure();
      try {
        if (!device || !device.gatt.connected) {
          device = await navigator.bluetooth.requestDevice({
            filters: [{ name: 'ArduinoIMU' }],
            optionalServices: [SERVICE_UUID]
          });
        }
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        controlChar = await service.getCharacteristic(CONTROL_UUID);
        dataChar    = await service.getCharacteristic(DATA_UUID);
        await controlChar.writeValue(new Uint8Array([1]));
        await dataChar.startNotifications();
        dataChar.addEventListener('characteristicvaluechanged', handleNotify);

        document.getElementById('accTitle').style.display  = 'block';
        document.getElementById('gyroTitle').style.display = 'block';
        document.getElementById('accChart').style.display  = 'block';
        document.getElementById('gyroChart').style.display = 'block';
        btnConnect.disabled = true;
        btnStop.disabled    = false;
        btnCsvMode.style.display = 'none';
        btnRi.style.display      = 'none';
      } catch (err) {
        alert('接続失敗: ' + err.message);
      }
    };
  </script>
</body>
</html>
