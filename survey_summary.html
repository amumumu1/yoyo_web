<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>アンケート集計結果</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
      overflow-x: hidden;
    }
    table {
      margin: 10px auto;
      border-collapse: collapse;
      font-size: 18px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
    }
    h2 {
      margin-top: 40px;
    }
    canvas {
      margin: 30px auto;
      width: 1000px;
      height: 500px;
      display: block;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>アンケート集計結果</h1>
  <a href="viewer.html" class="button">履歴一覧に戻る</a>

  <br><h1>事前アンケート</h1>
  <h2>年齢分布</h2>
  <canvas id="ageChart"></canvas>

  <h2>1.ヨーヨー歴(どのくらい続けていますか？)</h2>
  <canvas id="historyChart"></canvas> 

  <h2>2.ヨーヨーをする頻度はどのくらいですか？</h2>
  <canvas id="freqChart"></canvas> 

  <h2>3.普段どのようにヨーヨーを練習していますか？（複数回答可）</h2>
  <canvas id="practiceChart"></canvas>


  <h2>4.練習するときに困っていることはありますか？（複数回答可）</h2>
  <canvas id="troubleChart"></canvas>

  <h2>5.ヨーヨーがどのくらい得意ですか？（0 = 不得意 / 5 = 得意）</h2>
  <canvas id="skillDistributionChart"></canvas>

  <br><h1>事後アンケート</h1>
  <br><h1>指輪型センシングデバイスについて</h1>
  <h2>1.デバイスをつけてヨーヨーをすることに違和感はありましたか？</h2>
  <canvas id="discomfortChart"></canvas>

  <h2>2.デバイスの重さや大きさ、装着性は気になりましたか？</h2>
  <canvas id="weightfitChart"></canvas>

  <br><h1>技能評価システムについて</h1>
  <h2>4.評価結果の表示（例：グラフ、評価など）はわかりやすかったですか？</h2>
  <canvas id="resultviewChart"></canvas>

  <h2>5.評価結果（できている点・できていない点など）は、今後の練習の参考になると思いますか？</h2>
  <canvas id="usefulChart"></canvas>


  <h2>6.このシステムを使って、今後も練習したいと思いましたか？</h2>
  <canvas id="continueChart"></canvas>

  <h2>7.今後、このシステムで分析してほしいトリックはありますか？</h2>
  <canvas id="futureTrickChart"></canvas>




  <br><h1>おまけ</h1>

  <h1>点数</h1>
  <div id="scoreSummary"></div>

  <h2>ヨーヨー歴とスコアの関係</h2>
  <canvas id="historyScoreChart"></canvas>

  <h2>得意不得意とスコアの関係</h2>
  <canvas id="skillScoreChart"></canvas>


  <div id="summary"></div>

  <script>
    let historyChartInstance = null;
    let skillChartInstance = null;

    async function loadSurveySummary() {
      const res = await fetch("https://yoyo-backend.kajilab.dev/survey_summary");
      const data = await res.json();
      console.log("🔹 survey_summary:", data);

    //   const container = document.getElementById("summary");
    //   container.innerHTML = `
    //     <h2>事前アンケート</h2>
    //     ${renderSummaryTable(data.pre)}
    //     <h2>事後アンケート</h2>
    //     ${renderSummaryTable(data.post)}
    //   `;

      // 年齢・頻度・ヨーヨー歴グラフ
    if (data.pre?.length) {
    drawAgeChart(data.pre);
    drawFreqChart(data.pre);
    drawHistoryChart(data.pre);
    drawTroubleChart(data.pre); // ← 追加！
    drawPracticeChart(data.pre); // ← 追加！
    drawSkillDistributionChart(data.pre); // ← これ追加！
    }




      // スコア付きの散布図
      if (data.pre?.length) {
    drawHistoryScoreChart(data.pre);
    drawSkillScoreChart(data.pre); // ← これ追加！
    }

    if (data.post?.length) {
    drawDiscomfortChart(data.post);
    drawWeightfitChart(data.post);

    // === デバイスコメント一覧を追加（weightfitChart の直後に挿入） ===
    const htmlDevice = renderDeviceComments(data.post);
    const weightfitSection = document.getElementById("weightfitChart");
    const wrapperDevice = document.createElement("div");
    wrapperDevice.innerHTML = htmlDevice;
    weightfitSection.insertAdjacentElement("afterend", wrapperDevice);

    drawResultviewChart(data.post);
    drawUsefulChart(data.post);
    drawContinueChart(data.post);
    drawFutureTrickChart(data.post);
    }

    if (data.post?.length) {
    // === 総合スコア統計・分布・個別グラフ ===
    const trickSection = document.getElementById("historyScoreChart");
    const container = document.createElement("div");
    container.id = "scoreSummary";

    // 1️⃣ 統計パネル
    container.innerHTML = renderScoreSummary(data.post);

    // 2️⃣ ヒストグラム
    drawScoreHistogram(data.post, container);

    // 3️⃣ ランキング
    drawIndividualScores(data.post, container);

    const historyHeading = [...document.querySelectorAll("h2")]
    .find(h => h.textContent.includes("ヨーヨー歴とスコアの関係"));

    if (historyHeading) {
    // 見出しをスコアサマリーの直後に移動
    container.insertAdjacentElement("beforeend", historyHeading);

    // その見出しの下に散布図を配置
    const trickSection = document.getElementById("historyScoreChart");
    container.insertAdjacentElement("beforeend", trickSection);

    // 最後に container 全体を「得意不得意」グラフの前に配置
    const skillHeading = [...document.querySelectorAll("h2")]
        .find(h => h.textContent.includes("得意不得意とスコアの関係"));
    if (skillHeading) skillHeading.insertAdjacentElement("beforebegin", container);
    }


    }





    // === システムコメント表を「今後分析してほしいトリック」の直後に追加 ===
    if (data.post?.length) {
    const html = renderSystemComments(data.post);
    const trickSection = document.getElementById("futureTrickChart");
    const wrapper = document.createElement("div");
    wrapper.innerHTML = html;
    trickSection.insertAdjacentElement("afterend", wrapper);
    }

    }



    function renderSummaryTable(surveys) {
      if (!surveys?.length) return "<p>データなし</p>";
      const counts = {};
      surveys.forEach(s => {
        for (const [k, v] of Object.entries(s)) {
          const val = Array.isArray(v) ? v.join(", ") : v;
          counts[k] = counts[k] || {};
          counts[k][val] = (counts[k][val] || 0) + 1;
        }
      });
      return `<table>${
        Object.entries(counts)
          .map(([q, vals]) => 
            `<tr><th>${q}</th><td>${Object.entries(vals)
              .map(([ans, num]) => `${ans}: ${num}`).join("<br>")}</td></tr>`)
          .join("")
      }</table>`;
    }

    // === 年齢分布 ===
    function drawAgeChart(preSurveys) {
      const toHalfWidth = (str) => str.replace(/[０-９]/g, s => 
        String.fromCharCode(s.charCodeAt(0) - 0xFEE0)
      );

      const ages = preSurveys
        .map(s => parseInt(toHalfWidth(String(s.age || "")).trim()))
        .filter(n => !isNaN(n) && n > 0 && n < 100);

      const bins = {
        "10歳未満": 0, "10代": 0, "20代": 0, "30代": 0,
        "40代": 0, "50代": 0, "60代": 0, "70代": 0
      };

      ages.forEach(a => {
        if (a < 10) bins["10歳未満"]++;
        else if (a < 20) bins["10代"]++;
        else if (a < 30) bins["20代"]++;
        else if (a < 40) bins["30代"]++;
        else if (a < 50) bins["40代"]++;
        else if (a < 60) bins["50代"]++;
        else if (a < 70) bins["60代"]++;
        else bins["70代"]++;
      });

      const ctx = document.getElementById("ageChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: Object.keys(bins),
          datasets: [{
            label: "年齢分布（10歳刻み）",
            data: Object.values(bins),
            backgroundColor: "rgba(54, 162, 235, 0.6)"
          }]
        },
        options: { responsive: false, scales: { y: { beginAtZero: true } } }
      });
    }

    // === ヨーヨー歴（アンケート回答） ===
function drawHistoryChart(preSurveys) {
  // データを正規化（全角→半角、表記ゆれ統一）
  const normalize = (str) =>
    (str || "")
      .replace(/[Ａ-Ｚａ-ｚ０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
      .replace(/[〜～]/g, "～")
      .replace(/(カ月|ヶ月)/g, "か月")
      .replace(/\s+/g, "")
      .trim();

  const categories = [
    "はじめて",
    "3か月未満",
    "3か月～半年",
    "半年～1年",
    "1～2年",
    "3～4年",
    "5年以上"
  ];

  // 各カテゴリのカウント
  const historyBins = Object.fromEntries(categories.map(c => [c, 0]));

  preSurveys.forEach(s => {
    const h = normalize(s.history);
    if (historyBins.hasOwnProperty(h)) {
      historyBins[h]++;
    }
  });

  const labels = Object.keys(historyBins);
  const values = Object.values(historyBins);

  const ctx = document.getElementById("historyChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "ヨーヨー歴（人数）",
        data: values,
        backgroundColor: [
          "rgba(255, 159, 64, 0.6)",
          "rgba(255, 205, 86, 0.6)",
          "rgba(75, 192, 192, 0.6)",
          "rgba(54, 162, 235, 0.6)",
          "rgba(153, 102, 255, 0.6)",
          "rgba(201, 203, 207, 0.6)",
          "rgba(255, 99, 132, 0.6)"
        ],
        borderColor: "rgba(0, 0, 0, 0.2)",
        borderWidth: 1
      }]
    },
    options: {
      responsive: false,
      plugins: {
        title: {
          display: true,
          text: "ヨーヨー歴",
          font: { size: 18 }
        },
        legend: { display: false }
      },
      scales: {
        x: {
          title: { display: true, text: "ヨーヨー歴" },
          ticks: { font: { size: 14 } }
        },
        y: {
          title: { display: true, text: "人数" },
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });
}


    // === ヨーヨーをする頻度 ===
function drawFreqChart(preSurveys) {
  // freqの回答をカウント
  const freqBins = {
    "ほとんどしない": 0,
    "月に数回": 0,
    "週に1～2回": 0,
    "週に3～4回": 0,
    "ほぼ毎日": 0
  };

  preSurveys.forEach(s => {
    const val = s.freq?.trim();
    if (val && freqBins.hasOwnProperty(val)) freqBins[val]++;
  });

  const labels = Object.keys(freqBins);
  const values = Object.values(freqBins);

  const ctx = document.getElementById("freqChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "ヨーヨーをする頻度",
        data: values,
        backgroundColor: [
          "rgba(255, 159, 64, 0.6)",
          "rgba(75, 192, 192, 0.6)",
          "rgba(54, 162, 235, 0.6)",
          "rgba(153, 102, 255, 0.6)",
          "rgba(255, 99, 132, 0.6)"
        ],
        borderColor: "rgba(0, 0, 0, 0.2)",
        borderWidth: 1
      }]
    },
    options: {
      responsive: false,
      plugins: {
        title: {
          display: true,
          text: "ヨーヨーをする頻度",
          font: { size: 18 }
        },
        legend: { display: false }
      },
      scales: {
        x: { title: { display: true, text: "回答" } },
        y: {
          title: { display: true, text: "人数" },
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });
}

// === 練習方法（複数回答） ===
function drawPracticeChart(preSurveys) {
  // 各選択肢の出現回数をカウント
  const counts = {
    "1人で": 0,
    "友達と": 0,
    "解説動画を見ながら": 0,
    "練習会に参加": 0,
    "その他": 0
  };

  preSurveys.forEach(s => {
    if (!s.practice) return;
    const practices = Array.isArray(s.practice)
      ? s.practice
      : String(s.practice).split(",").map(t => t.trim());
    practices.forEach(p => {
      if (counts[p] !== undefined) counts[p]++;
    });
  });

  const labels = Object.keys(counts);
  const values = Object.values(counts);

  const ctx = document.getElementById("practiceChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "回答人数",
        data: values,
        backgroundColor: "rgba(75, 192, 192, 0.6)"
      }]
    },
    options: {
      indexAxis: "y", // 横棒グラフ
      responsive: false,
      plugins: {
        title: {
          display: true,
          text: "普段どのようにヨーヨーを練習していますか？（複数回答可）",
          font: { size: 18 }
        },
        legend: { display: false }
      },
      scales: {
        x: {
          beginAtZero: true,
          title: { display: true, text: "人数" },
          ticks: { stepSize: 2 }
        },
        y: {
          title: { display: true, text: "練習方法" }
        }
      }
    }
  });
}



// === 困っていること（複数回答） ===
function drawTroubleChart(preSurveys) {
  // 各選択肢の出現回数をカウント
  const counts = {
    "トリックが安定しない": 0,
    "思うように上達しない": 0,
    "できているかどうかわからない": 0,
    "教えてくれる人がいない": 0,
    "その他": 0
  };

  preSurveys.forEach(s => {
    if (!s.trouble) return;
    const troubles = Array.isArray(s.trouble)
      ? s.trouble
      : String(s.trouble).split(",").map(t => t.trim());
    troubles.forEach(t => {
      if (counts[t] !== undefined) counts[t]++;
    });
  });

  const labels = Object.keys(counts);
  const values = Object.values(counts);

  const ctx = document.getElementById("troubleChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "困っている人の数",
        data: values,
        backgroundColor: "rgba(255, 99, 132, 0.6)"
      }]
    },
    options: {
      indexAxis: "y", // ← 横向き棒グラフ
      responsive: false,
      plugins: {
        title: {
          display: true,
          text: "練習で困っていること（複数回答可）",
          font: { size: 18 }
        },
        legend: { display: false }
      },
      scales: {
        x: {
          beginAtZero: true,
          title: { display: true, text: "人数" },
          ticks: { stepSize: 2 }
        },
        y: {
          title: { display: true, text: "困っていること" }
        }
      }
    }
  });
}

// === 得意度（0〜5） ===
function drawSkillDistributionChart(preSurveys) {
  const counts = [0, 0, 0, 0, 0, 0]; // 0〜5のカウント配列

  preSurveys.forEach(s => {
    const num = parseInt(s.skill);
    if (!isNaN(num) && num >= 0 && num <= 5) counts[num]++;
  });

  const ctx = document.getElementById("skillDistributionChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["0", "1", "2", "3", "4", "5"],
      datasets: [{
        label: "回答人数",
        data: counts,
        backgroundColor: "rgba(153, 102, 255, 0.6)"
      }]
    },
    options: {
      responsive: false,
      plugins: {
        title: {
          display: true,
          text: "ヨーヨーの得意度分布（0=不得意, 5=得意）",
          font: { size: 18 }
        },
        legend: { display: false }
      },
      scales: {
        x: {
          title: { display: true, text: "得意度（自己評価）" }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: "人数" },
          ticks: { stepSize: 2 }
        }
      }
    }
  });
}

// === デバイス違和感の分布 ===
function drawDiscomfortChart(postSurveys) {
  // 回答のカウントを初期化
  const bins = {
    "全くなかった": 0,
    "少しあった": 0,
    "かなりあった": 0
  };

  postSurveys.forEach(s => {
    if (s.discomfort && bins.hasOwnProperty(s.discomfort)) {
      bins[s.discomfort]++;
    }
  });

  const ctx = document.getElementById("discomfortChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: Object.keys(bins),
      datasets: [{
        label: "回答人数",
        data: Object.values(bins),
        backgroundColor: [
          "rgba(75, 192, 192, 0.7)", // 全くなかった
          "rgba(255, 205, 86, 0.7)", // 少しあった
          "rgba(255, 99, 132, 0.7)"  // かなりあった
        ]
      }]
    },
    options: {
      indexAxis: "y", // 横棒グラフ
      responsive: false,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: "デバイス装着時の違和感",
          font: { size: 18 }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          title: { display: true, text: "人数" },
          ticks: { stepSize: 5 }
        },
        y: {
          title: { display: true, text: "回答内容" }
        }
      }
    }
  });
}


// === 重さ・装着性に関する評価 ===
function drawWeightfitChart(postSurveys) {
  const bins = {
    "気にならなかった": 0,
    "少し気になった": 0,
    "とても気になった": 0
  };

  postSurveys.forEach(s => {
    if (s.weightfit && bins.hasOwnProperty(s.weightfit)) {
      bins[s.weightfit]++;
    }
  });

  const ctx = document.getElementById("weightfitChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: Object.keys(bins),
      datasets: [{
        label: "回答人数",
        data: Object.values(bins),
        backgroundColor: [
          "rgba(75, 192, 192, 0.7)", // 気にならなかった
          "rgba(255, 205, 86, 0.7)", // 少し気になった
          "rgba(255, 99, 132, 0.7)"  // とても気になった
        ]
      }]
    },
    options: {
      indexAxis: "y", // ← 横棒グラフ
      responsive: false,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: "デバイスの重さ・装着性に関する印象",
          font: { size: 18 }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          title: { display: true, text: "人数" },
          ticks: { stepSize: 5 }
        },
        y: {
          title: { display: true, text: "回答内容" }
        }
      }
    }
  });
}

// === device-comment 一覧表示 ===
function renderDeviceComments(postSurveys) {
  const valid = postSurveys
    .filter(p => p["device-comment"] && p["device-comment"].trim() !== ":");

  if (!valid.length) return "<p>コメントなし</p>";

  const rows = valid.map(p =>
    `<tr><td>${p.name || `ID:${p.id}`}</td><td>${p["device-comment"]}</td></tr>`
  ).join("");

  return `
    <h2>3.デバイスについてよかった点・改善してほしい点を教えてください</h2>
    <table border="1" style="margin:10px auto; border-collapse:collapse; font-size:18px;">
      <tr><th>名前</th><th>コメント内容</th></tr>
      ${rows}
    </table>`;
}


// === 評価結果のわかりやすさ ===
function drawResultviewChart(postSurveys) {
  // すべての選択肢を明示（0件でも表示）
  const bins = {
    "とてもわかりやすい": 0,
    "わかりやすい": 0,
    "少しわかりにくい": 0,
    "わかりにくい": 0
  };

  // 回答をカウント
  postSurveys.forEach(s => {
    if (s.resultview && bins.hasOwnProperty(s.resultview)) {
      bins[s.resultview]++;
    }
  });

  // グラフ描画
  const ctx = document.getElementById("resultviewChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: Object.keys(bins),
      datasets: [{
        label: "回答人数",
        data: Object.values(bins),
        backgroundColor: [
          "rgba(54, 162, 235, 0.7)",  // とてもわかりやすい
          "rgba(75, 192, 192, 0.7)",  // わかりやすい
          "rgba(255, 205, 86, 0.7)",  // 少しわかりにくい
          "rgba(255, 99, 132, 0.7)"   // わかりにくい（0件でもグレーアウト風）
        ]
      }]
    },
    options: {
      indexAxis: "y", // ← 横棒グラフ
      responsive: false,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: "評価結果のわかりやすさ",
          font: { size: 18 }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          title: { display: true, text: "人数" },
          ticks: { stepSize: 5 }
        },
        y: {
          title: { display: true, text: "回答内容" }
        }
      }
    }
  });
}

// === 評価結果の有用性（今後の練習の参考になったか） ===
function drawUsefulChart(postSurveys) {
  // すべての選択肢を明示（0件でも表示）
  const bins = {
    "とても思う": 0,
    "少し思う": 0,
    "あまり思わない": 0,
    "全く思わない": 0
  };

  // 回答をカウント（未回答は無視）
  postSurveys.forEach(s => {
    if (s.useful && bins.hasOwnProperty(s.useful)) {
      bins[s.useful]++;
    }
  });

  // グラフ描画
  const ctx = document.getElementById("usefulChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: Object.keys(bins),
      datasets: [{
        label: "回答人数",
        data: Object.values(bins),
        backgroundColor: [
          "rgba(54, 162, 235, 0.7)",  // とても思う
          "rgba(75, 192, 192, 0.7)",  // 少し思う
          "rgba(255, 205, 86, 0.7)",  // あまり思わない
          "rgba(255, 99, 132, 0.7)"   // 全く思わない
        ]
      }]
    },
    options: {
      indexAxis: "y", // ← 横棒グラフ
      responsive: false,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: "評価結果の有用性（今後の練習の参考になったか）",
          font: { size: 18 }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          title: { display: true, text: "人数" },
          ticks: { stepSize: 5 }
        },
        y: {
          title: { display: true, text: "回答内容" }
        }
      }
    }
  });
}


// === 今後も使いたいか（継続意向） ===
function drawContinueChart(postSurveys) {
  // 全選択肢を初期化（0件でも軸に表示）
  const bins = {
    "ぜひ使いたい": 0,
    "機会があれば使いたい": 0,
    "あまり使いたいと思わない": 0
  };

  // 回答をカウント（未回答は無視）
  postSurveys.forEach(s => {
    if (s.continue && bins.hasOwnProperty(s.continue)) {
      bins[s.continue]++;
    }
  });

  // グラフ描画
  const ctx = document.getElementById("continueChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: Object.keys(bins),
      datasets: [{
        label: "回答人数",
        data: Object.values(bins),
        backgroundColor: [
          "rgba(54, 162, 235, 0.7)",  // ぜひ使いたい
          "rgba(75, 192, 192, 0.7)",  // 機会があれば使いたい
          "rgba(255, 99, 132, 0.7)"   // あまり使いたいと思わない
        ]
      }]
    },
    options: {
      indexAxis: "y", // ← 横棒グラフ
      responsive: false,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: "今後も使いたいか（継続意向）",
          font: { size: 18 }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          title: { display: true, text: "人数" },
          ticks: { stepSize: 5 }
        },
        y: {
          title: { display: true, text: "回答内容" }
        }
      }
    }
  });
}

function drawFutureTrickChart(postSurveys) {
  const labels = [
    "ホップザフェンス", "ダブルループ", "イーライホップ", "フック", "ボヨンボヨン",
    "ジャーブル", "ラセレーション", "トラピーズ", "ストリングトリック",
    "アウトサイドループ", "アラウンドザワールド",
    "シュートザムーン", "オーバーザフェンス", "ローラーコースター",
    "キャンディレイン", "ラップ系トリック", "ブレインツイスターコンボ",
    "ファウンテン", "スリーパー", "プロペラ", "5A", "1A", "L.C.L",
    "ツーハンドトラピーズ", "ソロハム"
  ];

  const counts = {};
  labels.forEach(label => counts[label] = 0);

  postSurveys.forEach(s => {
    const val = (s["future-trick"] || "").trim();
    if (!val || val === ":") return;
    const tricks = val.split(",").map(t => t.trim()).filter(Boolean);
    tricks.forEach(t => {
      if (counts.hasOwnProperty(t)) counts[t]++;
    });
  });

  const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
  const sortedLabels = sorted.map(([k]) => k);
  const values = sorted.map(([, v]) => v);

  // ✅ ラベル数に応じてキャンバス高さを自動調整
  const canvas = document.getElementById("futureTrickChart");
  const barHeight = 35; // 1項目あたりの高さ(px)
  canvas.height = sortedLabels.length * barHeight;

  const ctx = canvas.getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: sortedLabels,
      datasets: [{
        label: "希望人数",
        data: values,
        backgroundColor: "rgba(54, 162, 235, 0.7)"
      }]
    },
    options: {
      indexAxis: "y",
      responsive: false,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: "今後分析してほしいトリック（複数回答含む）",
          font: { size: 18 }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { stepSize: 1 },
          title: { display: true, text: "回答人数" }
        },
        y: {
          title: { display: true, text: "トリック名" }
        }
      }
    }
  });
}

// === system-comment 一覧表示 ===
function renderSystemComments(postSurveys) {
  const valid = postSurveys
    .filter(p => p["system-comment"] && p["system-comment"].trim() !== ":");

  if (!valid.length) {
    return "<p>コメントなし</p>";
  }

  const rows = valid.map(p =>
    `<tr><td>${p.name || `ID:${p.id}`}</td><td>${p["system-comment"]}</td></tr>`
  ).join("");

  return `
    <h2>8.システムについてよかった点・改善してほしい点を教えてください</h2>
    <table border="1" style="margin:10px auto; border-collapse:collapse; font-size:18px;">
      <tr><th>名前</th><th>コメント内容</th></tr>
      ${rows}
    </table>`;
}

// === 総合スコアの統計パネル ===
function renderScoreSummary(data) {
  const scores = data.map(d => parseFloat(d.total_score)).filter(s => !isNaN(s));
  if (!scores.length) return "<p>スコアデータなし</p>";

  const avg = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
  const max = Math.max(...scores).toFixed(1);
  const min = Math.min(...scores).toFixed(1);

  return `
    <div style="margin:40px auto; width:80%; text-align:center;">
      <p style="font-size:22px;">
        平均：<b>${avg}</b> 点　|　
        最高：<b>${max}</b> 点　|　
        最低：<b>${min}</b> 点　|　
        回答数：${scores.length}
      </p>
    </div>
  `;
}


// === スコア分布ヒストグラム ===
function drawScoreHistogram(data, container = document.getElementById("scoreSummary")) {
  const scores = data.map(d => parseFloat(d.total_score)).filter(s => !isNaN(s));
  if (!scores.length) return;

  const bins = Array(10).fill(0);
  scores.forEach(s => {
    const idx = Math.min(9, Math.floor(s / 10));
    bins[idx]++;
  });

  const labels = ["0–10", "10–20", "20–30", "30–40", "40–50", "50–60", "60–70", "70–80", "80–90", "90–100"];

  const canvas = document.createElement("canvas");
  canvas.id = "scoreHistogramChart";
  canvas.width = 1000;
  canvas.height = 400;
  container.appendChild(canvas);

  const ctx = canvas.getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "人数",
        data: bins,
        backgroundColor: "rgba(75, 192, 192, 0.7)",
        borderColor: "rgba(0,0,0,0.2)",
        borderWidth: 1
      }]
    },
    options: {
      responsive: false,
      plugins: {
        title: { display: true, text: "点数分布", font: { size: 18 } },
        legend: { display: false }
      },
      scales: {
        x: { title: { display: true, text: "スコア範囲" } },
        y: { title: { display: true, text: "人数" }, beginAtZero: true }
      }
    }
  });
}




// === 個別スコアランキング（横棒グラフ） ===
function drawIndividualScores(data, container = document.getElementById("scoreSummary")) {
  const sorted = data
    .map(d => ({ name: d.name || `ID:${d.id}`, score: parseFloat(d.total_score) }))
    .filter(d => !isNaN(d.score))
    .sort((a, b) => b.score - a.score);

  const labels = sorted.map(d => d.name);
  const values = sorted.map(d => d.score);

  const canvas = document.createElement("canvas");
  canvas.id = "scoreRankChart";
  canvas.width = 1000;
  canvas.height = labels.length * 30 + 100;
  container.appendChild(canvas);

  const ctx = canvas.getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "総合評価（点）",
        data: values,
        backgroundColor: "rgba(153, 102, 255, 0.7)"
      }]
    },
    options: {
      indexAxis: "y",
      responsive: false,
      plugins: {
        title: { display: true, text: "参加者別点数", font: { size: 18 } },
        legend: { display: false }
      },
      scales: {
        x: { beginAtZero: true, max: 100, title: { display: true, text: "スコア（点）" } },
        y: { title: { display: true, text: "参加者名（ID）" } }
      }
    }
  });
}














    // === 散布図 ===
    function drawHistoryScoreChart(preSurveys) {
  if (historyChartInstance) historyChartInstance.destroy();

  // --- 全角→半角＋整形 ---
  const normalize = (str) =>
    (str || "")
      .replace(/[Ａ-Ｚａ-ｚ０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
      .replace(/[〜～]/g, "～")
      .replace(/(カ月|ヶ月)/g, "か月")
      .replace(/\s+/g, "")
      .trim();

  const categories = [
    "はじめて",
    "3か月未満",
    "3か月～半年",
    "半年～1年",
    "1～2年",
    "3～4年",
    "5年以上"
  ];

  const mapHistoryToIndex = (history) => {
    const h = normalize(history);
    return categories.findIndex(cat => h === cat);
  };

  // --- データ点を数値軸に変換 ---
  const numericData = preSurveys
    .map(s => {
      const idx = mapHistoryToIndex(s.history);
      const score = parseFloat(s.total_score);
      return idx >= 0 && !isNaN(score) ? { x: idx, y: score, id: s.id } : null;
    })
    .filter(Boolean);

  if (!numericData.length) {
    console.warn("⚠️ 散布図データが空です。");
    return;
  }

  // --- 回帰直線を計算（最小二乗法） ---
  const n = numericData.length;
  const meanX = numericData.reduce((a, p) => a + p.x, 0) / n;
  const meanY = numericData.reduce((a, p) => a + p.y, 0) / n;

  let num = 0, den = 0;
  numericData.forEach(p => {
    num += (p.x - meanX) * (p.y - meanY);
    den += (p.x - meanX) ** 2;
  });

  const slope = num / den; // 傾き
  const intercept = meanY - slope * meanX; // 切片

  // --- 相関係数 r ---
  const numerator = numericData.reduce((a, p) => a + (p.x - meanX) * (p.y - meanY), 0);
  const denomX = Math.sqrt(numericData.reduce((a, p) => a + (p.x - meanX) ** 2, 0));
  const denomY = Math.sqrt(numericData.reduce((a, p) => a + (p.y - meanY) ** 2, 0));
  const r = numerator / (denomX * denomY);

  console.log(`✅ 回帰線: y = ${slope.toFixed(2)}x + ${intercept.toFixed(2)}, r=${r.toFixed(3)}`);

  // --- 回帰直線データを生成 ---
  const linePoints = [
    { x: 0, y: slope * 0 + intercept },
    { x: categories.length - 1, y: slope * (categories.length - 1) + intercept }
  ];

  // --- 描画 ---
  const ctx = document.getElementById("historyScoreChart").getContext("2d");
  historyChartInstance = new Chart(ctx, {
    type: "scatter",
    data: {
      datasets: [
        {
          label: "ヨーヨー歴とスコア",
          data: numericData.map(p => ({ x: categories[p.x], y: p.y, id: p.id })),
          backgroundColor: "rgba(255, 99, 132, 0.7)",
          borderColor: "rgba(255, 99, 132, 1)",
          pointRadius: 7
        },
        {
          label: `回帰線（r=${r.toFixed(3)}）`,
          type: "line",
          data: linePoints.map(p => ({ x: categories[p.x], y: p.y })),
          borderColor: "rgba(0, 0, 0, 0.8)",
          borderWidth: 2,
          fill: false,
          pointRadius: 0
        }
      ]
    },
    options: {
      onClick: (evt, elements) => {
        if (elements.length > 0) {
            const idx = elements[0].index;
            const dataset = historyChartInstance.data.datasets[elements[0].datasetIndex];
            const point = dataset.data[idx];
            const id = point.id;
            if (id) {
            window.open(`viewer.html?id=${id}`, "_blank");
            }
        }
        },

      responsive: false,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { boxWidth: 20 } },
        title: {
          display: true,
          text: `相関係数 r = ${r.toFixed(3)}（回帰式: y = ${slope.toFixed(2)}x + ${intercept.toFixed(2)}）`,
          padding: { top: 10, bottom: 10 },
          font: { size: 18 }
        }
      },
      scales: {
        x: {
          type: "category",
          labels: categories,
          title: { display: true, text: "ヨーヨー歴（アンケート回答）" }
        },
        y: {
          title: { display: true, text: "総合評価（点）" },
          beginAtZero: true,
          suggestedMax: 100
        }
      }
    }
  });
}

// === 得意不得意とスコアの散布図 ===
// === 得意不得意とスコアの散布図（0〜5スケール対応） ===
function drawSkillScoreChart(preSurveys) {
  if (skillChartInstance) skillChartInstance.destroy();

  

  const categories = ["0", "1", "2", "3", "4", "5"]; // 軸ラベル用

  // --- skillを数値スケールとして扱う ---
  const numericData = preSurveys
    .map(s => {
      const skillNum = parseFloat(s.skill);
      const score = parseFloat(s.total_score);
      return !isNaN(skillNum) && !isNaN(score)
        ? { x: skillNum, y: score, id: s.id } // ← idを保持！
        : null;
    })
    .filter(Boolean);

  if (!numericData.length) {
    console.warn("⚠️ 散布図データが空です（skill未記入または数値変換エラー）。");
    return;
  }

  // --- 回帰直線を計算（最小二乗法） ---
  const n = numericData.length;
  const meanX = numericData.reduce((a, p) => a + p.x, 0) / n;
  const meanY = numericData.reduce((a, p) => a + p.y, 0) / n;

  let num = 0, den = 0;
  numericData.forEach(p => {
    num += (p.x - meanX) * (p.y - meanY);
    den += (p.x - meanX) ** 2;
  });
  const slope = num / den;
  const intercept = meanY - slope * meanX;

  // --- 相関係数 r ---
  const numerator = numericData.reduce((a, p) => a + (p.x - meanX) * (p.y - meanY), 0);
  const denomX = Math.sqrt(numericData.reduce((a, p) => a + (p.x - meanX) ** 2, 0));
  const denomY = Math.sqrt(numericData.reduce((a, p) => a + (p.y - meanY) ** 2, 0));
  const r = numerator / (denomX * denomY);

  console.log(`✅ skill 回帰線: y = ${slope.toFixed(2)}x + ${intercept.toFixed(2)}, r = ${r.toFixed(3)}`);

  // --- 回帰線データ ---
  const linePoints = [
    { x: 0, y: slope * 0 + intercept },
    { x: 5, y: slope * 5 + intercept }
  ];

  // --- 描画 ---
  const ctx = document.getElementById("skillScoreChart").getContext("2d");
  skillChartInstance = new Chart(ctx, {
    type: "scatter",
    data: {
      datasets: [
        {
          label: "得意不得意とスコア",
          data: numericData,
          backgroundColor: "rgba(75, 192, 192, 0.7)",
          borderColor: "rgba(75, 192, 192, 1)",
          pointRadius: 7
        },
        {
          label: `回帰線（r=${r.toFixed(3)}）`,
          type: "line",
          data: linePoints,
          borderColor: "rgba(0, 0, 0, 0.8)",
          borderWidth: 2,
          fill: false,
          pointRadius: 0
        }
      ]
    },
    options: {
      onClick: (evt, elements) => {
        if (elements.length > 0) {
          const idx = elements[0].index;
          const dataset = skillChartInstance.data.datasets[elements[0].datasetIndex];
          const point = dataset.data[idx];
          const id = point.id;
          if (id) {
            // viewer.html にジャンプしてその履歴を開く
            window.open(`viewer.html?id=${id}`, "_blank");
          }
        }
      },
      responsive: false,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { boxWidth: 20 } },
        title: {
          display: true,
          text: `相関係数 r = ${r.toFixed(3)}（回帰式: y = ${slope.toFixed(2)}x + ${intercept.toFixed(2)}）`,
          font: { size: 18 }
        }
      },
      scales: {
        x: {
            type: "linear",
            min: -0.3,
            max: 5.3,
            ticks: {
            stepSize: 1,
            callback: (value) => {
                // 整数だけ表示（0,1,2,3,4,5）
                return Number.isInteger(value) ? value.toString() : "";
            }
            },
            title: {
            display: true,
            text: "得意不得意（0=苦手, 5=得意）"
            }
        },
        y: {
            title: { display: true, text: "総合評価（点）" },
            beginAtZero: true,
            suggestedMax: 100
        }
        }

    }
  });
}





    loadSurveySummary();
  </script>
</body>
</html>
