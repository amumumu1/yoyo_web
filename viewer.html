<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å±¥æ­´ä¸€è¦§</title>
  <style>
    body { text-align:center; font-family:Arial,sans-serif; }
    img { max-width:100%; display:block; margin:10px auto; }
    button,.button{
      margin:5px;padding:8px 16px;font-size:25px;background:#f0f0f0;
      border:1px solid #ccc;border-radius:4px;cursor:pointer;text-decoration:none;color:#333;
    }
    button:hover,.button:hover{ background:#ddd; }
    .result{margin:20px auto;border-bottom:2px solid #000;padding-bottom:10px;max-width:100%;}
    p{font-size:30px;margin:5px 0;} h1{font-size:40px;}
    .heatmap-row{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin:20px auto;}
    .heatmap-row div{text-align:center;}
    .heatmap-row img{max-width:100%;height:auto;}
    .heatmap-row h4{min-height:3.5em;font-size:18px;}
  </style>
</head>

<body>
<h1>å±¥æ­´ä¸€è¦§</h1>
<a href="index.html" class="button">æˆ»ã‚‹</a>
<a href="survey_summary.html" class="button" target="_blank">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé›†è¨ˆ</a>

<div id="history"></div>


<script>
//==============================
//  ğŸ”¥ å±¥æ­´å–å¾—
//==============================
async function fetchHistory(user){
  const res = await fetch(`https://yoyo-backend.kajilab.dev/results_user?uid=${user.uid}&email=${user.email}`);
  const data = await res.json();
  const box=document.getElementById("history");
  box.innerHTML="";

  if(!data.length) return box.innerHTML="<p>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";

  for(const item of data){
    box.innerHTML+=`
      <div class="result">
        <p>${item.timestamp}</p>
        <p id="name-${item.id}">${item.name??"ç„¡é¡Œ"}</p>
        <p>ç·åˆè©•ä¾¡: ${item.total_score!=null?item.total_score.toFixed(1)+"ç‚¹":"ãªã—"}</p>
        <button onclick="toggleDetail(${item.id})" id="toggle-btn-${item.id}">è©³ç´°ã‚’è¦‹ã‚‹</button>
        <button onclick="renameResult(${item.id})">åå‰å¤‰æ›´</button>
        <div id="detail-${item.id}" style="display:none;"></div>
      </div>`;
  }
}


//==============================
//  ğŸ”¥ 1ä»¶è©³ç´°å±•é–‹ / é–‰ã˜ã‚‹
//==============================
async function toggleDetail(id){
  const box=document.getElementById(`detail-${id}`);
  const btn=document.getElementById(`toggle-btn-${id}`);

  if(box.style.display==='none'){
    const res=await fetch(`https://yoyo-backend.kajilab.dev/results/${id}`);
    const d=await res.json();

    box.innerHTML=`
      <p>ç·åˆè©•ä¾¡: ${d.total_score!=null?d.total_score.toFixed(1)+"ç‚¹":"ãªã—"}</p>
      ${d.radar_chart?`<img src="data:image/png;base64,${d.radar_chart}">`:""}
      <p>é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢:${d.score!=null?d.score.toFixed(1):"0.0"}</p>
      <p>ãƒ—ãƒ­è·é›¢å¹³å‡:${d.pro_distance_mean??"ãªã—"}</p>
      <p>ãƒ«ãƒ¼ãƒ—æ•°:${d.loop_count??"ãªã—"}</p>
      <p>å®‰å®š:${d.stable_loop!=null?d.stable_loop+"å‘¨ç›®":"ãªã—"}</p>
      <pre style="white-space:pre-wrap;font-size:30px;">${Array.isArray(d.loop_duration_list)?d.loop_duration_list.join("\n"):""}</pre>
      ${d.loop_plot?`<img src="data:image/png;base64,${d.loop_plot}">`:""}
      <div class="heatmap-row">
        ${d.self_heatmap?`<div><h4>è‡ªå·±æ¯”è¼ƒ</h4><img src="data:image/png;base64,${d.self_heatmap}"></div>`:""}
        ${d.pro_heatmap?`<div><h4>ãƒ—ãƒ­æ¯”è¼ƒ</h4><img src="data:image/png;base64,${d.pro_heatmap}"></div>`:""}
      </div>
      <button onclick="toggleDetail(${id})">é–‰ã˜ã‚‹</button>
      <button onclick="downloadCSV(${id})">CSV</button>
      <button onclick="deleteResult(${id})" style="background:#f66;color:white;">å‰Šé™¤</button>
    `;

    box.style.display="block";
    btn.textContent="é–‰ã˜ã‚‹";
  }else{
    box.style.display="none";
    box.innerHTML="";
    btn.textContent="è©³ç´°ã‚’è¦‹ã‚‹";
  }
}


//==============================
//  ğŸ”¥ CSV
//==============================
function downloadCSV(id){
  location.href=`https://yoyo-backend.kajilab.dev/results/${id}/csv`;
}


//==============================
//  ğŸ”¥ åå‰å¤‰æ›´
//==============================
async function renameResult(id){
  const now=document.getElementById(`name-${id}`).innerText;
  const name=prompt("æ–°ã—ã„åå‰:",now);
  if(!name) return;

  const r=await fetch(`https://yoyo-backend.kajilab.dev/results/${id}`,{
    method:"PUT",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name})
  });

  if(r.ok){
    document.getElementById(`name-${id}`).innerText=name;
    alert("å¤‰æ›´å®Œäº†");
  }else alert("å¤±æ•—");
}


//==============================
//  ğŸ”¥ å‰Šé™¤ï¼ˆâ€»å¾Œã§ç®¡ç†è€…ã®ã¿åˆ¶å¾¡å¯¾å¿œå¯èƒ½ï¼‰
//==============================
async function deleteResult(id){
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return;
  const r=await fetch(`https://yoyo-backend.kajilab.dev/results/${id}`,{method:"DELETE"});
  const j=await r.json();
  if(j.status==="deleted") location.reload();
  else alert("å‰Šé™¤å¤±æ•—");
}


//==============================
//  ğŸ”¥ Firebaseãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆ
//==============================
document.addEventListener("DOMContentLoaded",()=>{
  firebase.auth().onAuthStateChanged(async user=>{
    if(!user){ location.href="login.html"; return; }

    const id=new URLSearchParams(location.search).get("id");
    await fetchHistory(user);           // â† èªè¨¼å¾Œã®ã¿å±¥æ­´èª­ã¿è¾¼ã¿

    if(id){                             // â† idæŒ‡å®šæ™‚ã®ã¿è‡ªå‹•å±•é–‹
      setTimeout(()=>{
        toggleDetail(id);
        document.getElementById(`name-${id}`)?.scrollIntoView({behavior:"smooth"});
      },600);
    }
  });
});
</script>

</body>
</html>
