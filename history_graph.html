<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æŠ€èƒ½æ¨ç§»</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<style>
body{
    text-align:center;
    font-family:sans-serif;
    margin:0;
    padding-top:15px;
}
canvas{
    width:90vw !important;
    height:calc(100vh - 200px) !important;
    margin:0 auto;
}
select{
    font-size:22px;
    padding:6px 12px;
    margin:10px;
}
.back-btn{
    position:fixed;
    top:40px;
    right:40px;
    padding:10px 18px;
    background:#eee;
    border-radius:5px;
    border:1px solid #aaa;
    font-size:20px;
    text-decoration:none;
    color:#333;
}
</style>
</head>

<body>

<h1>ğŸ“ˆ æŠ€èƒ½æ¨ç§»ã‚°ãƒ©ãƒ•</h1>

<select id="user-filter" style="display:none;">
  <option value="">ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
</select>

<select id="metric-select">
  <option value="total_score">ç·åˆè©•ä¾¡</option>
  <option value="raw_self_distance">è‡ªå·±é¡ä¼¼åº¦ï¼ˆè·é›¢ï¼‰</option>
  <option value="pro_distance_mean">ãƒ—ãƒ­é¡ä¼¼åº¦ï¼ˆè·é›¢ï¼‰</option>
  <option value="loop_mean_duration">å¹³å‡ãƒ«ãƒ¼ãƒ—æ™‚é–“</option>
  <option value="loop_std_duration">ãƒ«ãƒ¼ãƒ—ã°ã‚‰ã¤ã</option>
  <option value="stable_loop">å®‰å®šé–‹å§‹ãƒ«ãƒ¼ãƒ—</option>
  <option value="snap_median">æ‰‹é¦–ã‚’è¿”ã™å¼·ã•</option>
  <option value="snap_std">æ‰‹é¦–ã‚’è¿”ã™å¼·ã•ã®ã°ã‚‰ã¤ã</option>
</select>

<a href="viewer.html" class="back-btn">å±¥æ­´ã«æˆ»ã‚‹</a>

<canvas id="graph"></canvas>

<script>
/* ================= Firebase ================= */
firebase.initializeApp({
    apiKey:"AIzaSyCIoMI9P-shqBz6RF38L_V9PG3bl5J7Pbc",
    authDomain:"yoyo-sensing.firebaseapp.com",
    projectId:"yoyo-sensing",
    storageBucket:"yoyo-sensing.firebasestorage.app",
    messagingSenderId:"129908163482",
    appId:"1:129908163482:web:8cb1c024e25b2c9a96f023"
});

const ADMIN_EMAIL = "prj.yoyo@gmail.com";

/* ================= ãƒ—ãƒ­åŸºæº–å€¤ ================= */
const PRO_REFERENCE = {
    loop_mean_duration: 0.429,
    loop_std_duration: 0.072,
    snap_median: 91.45,
    snap_std: 25.80
};

let chart = null;
let currentMetric = "total_score";
let userFilterInitialized = false;

/* ================= ãƒ—ãƒ­æ°´å¹³ç·š ================= */
function createProLine(labels, value){
    return {
        label: "ãƒ—ãƒ­",
        data: labels.map(() => value),
        borderWidth: 3,
        borderDash: [8, 6],      
        borderColor: undefined,  
        pointRadius: 0,
        pointStyle: 'line',    
        fill: false
    };
}


/* ================= å…±é€šæç”» ================= */
function renderChart(
    labels,
    datasets,
    yLabel,
    xLabel,
    yMin = null,
    yMax = null,
    showLegend = false,
    forceIntegerY = false
){
    if(chart) chart.destroy();

    const yScale = {
        title:{ display:true, text:yLabel, font:{size:20} },
        ticks:{
            font:{ size:20 },
            stepSize: forceIntegerY ? 1 : undefined,
            callback: forceIntegerY
                ? (v) => Number.isInteger(v) ? v : ""
                : undefined
        }
    };
    if (yMin !== null) yScale.min = yMin;
    if (yMax !== null) yScale.max = yMax;

    chart = new Chart(document.getElementById("graph"),{
        type:"line",
        data:{ labels, datasets },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{ 
                legend:{ 
                    display:showLegend,
                    labels: {
                        generateLabels(chart) {
                            const labels =
                            Chart.defaults.plugins.legend.labels.generateLabels(chart);

                            return labels.map(l => ({
                            ...l,
                            pointStyle: 'line',  // â† å‡¡ä¾‹ã ã‘ç·š
                            lineWidth: 3
                            }));
                        }
                    }
                } 
            },
            scales:{
                x:{
                    title:{ display:true, text:xLabel, font:{size:20} },
                    ticks:{ font:{ size:20 } }
                },
                y: yScale
            }
        }
    });
}

/* ================= å€‹äºº ================= */
function drawSingleUser(data, metric, yLabel, yAxisRule, isStableLoop){

    if (!data.length) return;

    const userLabel =
        data[0].user_name ||
        data[0].email ||
        "ãƒ¦ãƒ¼ã‚¶ãƒ¼";
    
    const labels = data.map(d=>{
        const dt=new Date(d.timestamp.replace(/-/g,"/"));
        return `${dt.getMonth()+1}/${dt.getDate()} ${dt.getHours()}:${String(dt.getMinutes()).padStart(2,"0")}`;
    });

    const datasets = [{
        label: userLabel,
        data:data.map(d=>d[metric]),
        borderWidth:4,
        pointRadius:6,
        pointHoverRadius:8        
    }];

    if(PRO_REFERENCE[metric] !== undefined){
        datasets.push(createProLine(labels, PRO_REFERENCE[metric]));
    }

    renderChart(
        labels,
        datasets,
        yLabel,
        "æ—¥æ™‚",
        yAxisRule.min,
        yAxisRule.max,
        true,
        isStableLoop
    );
}

/* ================= å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ ================= */
function drawAllUsers(data, metric, yLabel, yAxisRule, isStableLoop){
    const grouped = {};
    data.forEach(d=>{
        if(!d.user_name) return;
        if(d.user_name==="ãƒ¨ãƒ¼ãƒ¨ãƒ¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ") return;
        if(!grouped[d.user_id]){
            grouped[d.user_id]={name:d.user_name,values:[]};
        }
        grouped[d.user_id].values.push(d[metric]);
    });

    const users = Object.values(grouped);
    if(users.length===0){
        if(chart) chart.destroy();
        return;
    }

    const maxLen=Math.max(...users.map(u=>u.values.length));
    const labels=Array.from({length:maxLen},(_,i)=>i+1);

    const datasets = users.map(u=>({
        label:u.name,
        data:u.values,
        borderWidth:4,
        pointRadius:6,
        pointHoverRadius:7,
        fill:false,
        isStableLoop
    }));

    if(PRO_REFERENCE[metric] !== undefined){
        datasets.push(createProLine(labels, PRO_REFERENCE[metric]));
    }

    renderChart(
        labels,
        datasets,
        yLabel,
        "å±¥æ­´ç•ªå·",
        yAxisRule.min,
        yAxisRule.max,
        true,
        isStableLoop
    );
}

/* ================= ãƒ¡ã‚¤ãƒ³ ================= */
async function drawGraph(){
    const user=firebase.auth().currentUser;
    if(!user) return;

    const metric=currentMetric;
    const filterUid=document.getElementById("user-filter").value;

    const isStableLoop = (metric === "stable_loop");


    const yAxisRule = {
        total_score:{min:0,max:100},
        stable_loop:{min:1,max:null},
        raw_self_distance:{min:0,max:null},
        pro_distance_mean:{min:0,max:null},
        loop_mean_duration:{min:0,max:null},
        loop_std_duration:{min:0,max:null},
        snap_median:{min:0,max:null},
        snap_std:{min:0,max:null}
    }[metric];

    let url=`https://yoyo-backend.kajilab.dev/results_user_graph?uid=${user.uid}&email=${user.email}`;
    if(filterUid) url+=`&filter_uid=${filterUid}`;

    const data=await (await fetch(url)).json();

    if(user.email===ADMIN_EMAIL && !userFilterInitialized){
        buildUserFilter(data);
        userFilterInitialized=true;
    }

    const yLabel={
        total_score:"ç·åˆè©•ä¾¡ï¼ˆç‚¹ï¼‰",
        raw_self_distance:"è‡ªå·±é¡ä¼¼åº¦ï¼ˆè·é›¢ï¼‰â€»å°ã•ã„ã»ã©ã‚ˆã„",
        pro_distance_mean:"ãƒ—ãƒ­é¡ä¼¼åº¦ï¼ˆè·é›¢ï¼‰â€»å°ã•ã„ã»ã©ã‚ˆã„",
        loop_mean_duration:"å¹³å‡ãƒ«ãƒ¼ãƒ—æ™‚é–“ï¼ˆç§’ï¼‰â€»ãƒ—ãƒ­ã¯ 0.429 ç§’",
        loop_std_duration:"ãƒ«ãƒ¼ãƒ—ã°ã‚‰ã¤ãï¼ˆç§’ï¼‰â€»å°ã•ã„ã»ã©ã‚ˆã„",
        stable_loop:"å®‰å®šé–‹å§‹ãƒ«ãƒ¼ãƒ—ï¼ˆå‘¨ç›®ï¼‰â€»å°ã•ã„ã»ã©ã‚ˆã„",
        snap_median:"ã‚¹ãƒŠãƒƒãƒ—ä¸­å¤®å€¤ (m/sÂ²) â€»ãƒ—ãƒ­ã¯ 91.45 m/sÂ²",
        snap_std:"ã‚¹ãƒŠãƒƒãƒ—ã°ã‚‰ã¤ãï¼ˆm/sÂ²ï¼‰â€»å°ã•ã„ã»ã©ã‚ˆã„"
    }[metric];

    if(user.email===ADMIN_EMAIL && filterUid===""){
        drawAllUsers(data,metric,yLabel,yAxisRule, isStableLoop);
    }else{
        drawSingleUser(data,metric,yLabel,yAxisRule, isStableLoop);
    }
}

/* ================= ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆ ================= */
function buildUserFilter(data){
    const select=document.getElementById("user-filter");
    select.innerHTML='<option value="">ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>';

    const map={};
    data.forEach(d=>{
        if(d.user_id) map[d.user_id]=d.user_name||d.email;
    });

    Object.entries(map).forEach(([uid,name])=>{
        const o=document.createElement("option");
        o.value=uid;
        o.textContent=name;
        select.appendChild(o);
    });

    select.style.display="inline-block";
    select.onchange=drawGraph;
}

/* ================= åˆæœŸåŒ– ================= */
document.getElementById("metric-select").onchange=e=>{
    currentMetric=e.target.value;
    drawGraph();
};

firebase.auth().onAuthStateChanged(u=>{
    if(!u) location.href="login.html";
    drawGraph();
});
</script>

</body>
</html>
