<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å±¥æ­´ä¸€è¦§</title>
  <style>
    body {
      text-align: center;
      font-family: Arial, sans-serif;
    }
    img { 
      max-width: 100%;
      display: block;
      margin: 10px auto;
    }
    button, .button {
      margin: 5px;
      padding: 8px 16px;
      font-size: 25px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      color: #333;
      display: inline-block;
    }
    button:hover, .button:hover {
      background-color: #ddd;
    }
    .result { 
      margin: 20px auto; 
      border-bottom: 2px solid #000; 
      padding-bottom: 10px;
      max-width: 100%;
    }
    p {
      font-size: 30px;
      margin: 5px 0;
    }

    h1 {
      font-size: 40px;
    }

    .heatmap-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px auto;
      flex-wrap: wrap;
    }
    .heatmap-row div {
      text-align: center;
    }
    .heatmap-row img {
      max-width: 100%;
      height: auto;
    }
    .heatmap-row h4 {
      min-height: 3.5em;
      font-size: 18px;
      line-height: 1.3;
    }
    .result {
      margin: 25px auto;
      padding: 20px 24px;
      max-width: 900px;

      background: #ffffff;
      border-radius: 14px;

      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);

      text-align: center;
    }

    .result p {
      margin: 6px 0;
    }

    .result h2 {
      margin: 4px 0;
      font-size: 28px;
      font-weight: bold;
    }

    .result .meta {
      font-size: 18px;
      color: #666;
    }

    .result .score {
      font-size: 26px;
      font-weight: bold;
      color: #333;
      margin-top: 10px;
    }

    .result-buttons {
      margin-top: 15px;
      display: flex;
      justify-content: center;   /* â† ä¸­å¤®å¯„ã› */
      align-items: center;
    }

    .result-buttons button {
      margin: 0 auto;   /* â† ä¸­å¤®æƒãˆ */
      display: block;   /* â† ãƒœã‚¿ãƒ³ã‚’ãƒ–ãƒ­ãƒƒã‚¯åŒ–ã—ã¦ä¸­å¤®ã¸ */
    }

    .toggle-btn {
        width: 80%;           /* â† å°‘ã—å°ã•ã‚ï¼ˆå¥½ã¿ã«ã‚ˆã‚Š70ã€œ90%ã§èª¿æ•´å¯ï¼‰ */
        max-width: 260px;     /* â† è¦‹ãŸç›®ãŒâ€œã¡ã‚‡ã†ã©ã„ã„â€ã‚µã‚¤ã‚º */
        margin: 15px auto 5px;

        padding: 10px 16px;   /* â† é«˜ã•å°‘ã—å°ã•ã */
        font-size: 18px;      /* â† æ–‡å­—å°‘ã—å°ã•ã */
        font-weight: 600;

        background: #ffffff;
        border: 2px solid #0078ff;
        border-radius: 10px;
        cursor: pointer;

        color: #0078ff;
        transition: 0.25s;
        box-shadow: 0 3px 8px rgba(0,0,0,0.08);

        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .toggle-btn .icon {
        font-size: 20px;   /* â† ã‚¢ã‚¤ã‚³ãƒ³ã‚‚å°ã•ã */
      }


    .toggle-btn:hover {
      background: #0078ff;
      color: white;
    }

   


  </style>
</head>
<body>
  <h1>å±¥æ­´ä¸€è¦§</h1>
  <a href="index.html" class="button">æˆ»ã‚‹</a>
  <a href="history_graph.html" class="button">æŠ€èƒ½æ¨ç§»ã‚’è¦‹ã‚‹</a>
  <a href="survey_summary.html" class="button" target="_blank">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®é›†è¨ˆçµæœã‚’è¦‹ã‚‹</a>


  <div id="history"></div>
  <script>
  async function fetchHistory(user){
    // â† ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒ adminåˆ¤å®šã—ã¦ãã‚Œã‚‹ã®ã§ãã®ã¾ã¾é€ã‚‹ã ã‘
    const res = await fetch(
        `https://yoyo-backend.kajilab.dev/results_user?uid=${user.uid}&email=${user.email}`
    );
    const data = await res.json();
    const box=document.getElementById("history");
    box.innerHTML="";

    if(!data.length) return box.innerHTML="<p>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";

    // ğŸ”¥ ç®¡ç†è€…åˆ¤å®šï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨åŒä¸€å€¤ï¼‰
    const ADMIN_EMAIL = "prj.yoyo@gmail.com";
    const isAdmin = user.email === ADMIN_EMAIL;
    const googleName = user.displayName || user.email;


    for(const item of data){
        box.innerHTML += `
        <div class="result">

          <!-- æ—¥ä»˜ -->
          <p class="meta">${item.timestamp}</p>

          <!-- ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆåå‰ï¼‰-->
          <h2 id="name-${item.id}">${item.name ?? "ç„¡é¡Œ"}</h2>

          <!-- ç®¡ç†è€…ã ã‘ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º -->
          ${isAdmin ? `<p class="meta">ğŸ‘¤ ${item.user_name ?? "(no name)"} </p>` : ""}

          <!-- ç·åˆè©•ä¾¡ -->
          <p class="score">â­ ç·åˆè©•ä¾¡ï¼š ${item.total_score != null ? item.total_score.toFixed(1) : "ãªã—"}ç‚¹</p>

          <!-- ãƒœã‚¿ãƒ³ -->
          <div class="result-buttons">
              <button onclick="toggleDetail(${item.id})" id="toggle-btn-${item.id}" class="toggle-btn">
                  <span class="icon">â–¼</span> è©³ç´°ã‚’é–‹ã
              </button>
          </div>


          <!-- è©³ç´°ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
          <div id="detail-${item.id}" style="display:none;"></div>

        </div>
        `;

    }
}


  // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ id ã‚’å–å¾—ã—ã¦è‡ªå‹•ã§é–‹ãå‡¦ç†
document.addEventListener("DOMContentLoaded",()=>{
  const params=new URLSearchParams(window.location.search);
  const targetId=params.get("id");
  firebase.auth().onAuthStateChanged(async user=>{
    if(!user){ location.href="index.html"; return; }

    if(targetId){
      fetchHistory(user).then(()=>{
        setTimeout(()=>{
          toggleDetail(targetId);
          document.getElementById(`name-${targetId}`)?.scrollIntoView({behavior:"smooth",block:"center"});
        },500);
      });
    } else {
      fetchHistory(user);
    }
  });
});




  async function renameResult(id) {
    const currentName = document.getElementById(`name-${id}`).innerText;
    const newName = prompt("æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", currentName);
    if (newName === null || newName.trim() === "") return;

    const res = await fetch(`https://yoyo-backend.kajilab.dev/results/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: newName })
    });

    if (res.ok) {
      document.getElementById(`name-${id}`).innerText = newName;
      alert("åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
    } else {
      const errText = await res.text();
      console.error("åå‰å¤‰æ›´ã‚¨ãƒ©ãƒ¼:", res.status, errText);
      alert("åå‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: " + res.status);
    }
  }

  async function deleteResult(id) {
    if (!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

    const res = await fetch(`https://yoyo-backend.kajilab.dev/results/${id}`, {
      method: "DELETE"
    });
    const result = await res.json();
    if (result.status === "deleted") {
      alert("å‰Šé™¤ã—ã¾ã—ãŸ");
      const u = firebase.auth().currentUser;
      fetchHistory(u);      // â† ä¿®æ­£å¾Œ
    } else {
      alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  }

  async function toggleDetail(id) {
  const container = document.getElementById(`detail-${id}`);
  const button = document.getElementById(`toggle-btn-${id}`);

  const isClosed = container.style.display === 'none';

  // --- ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒœã‚¿ãƒ³æ–‡è¨€åˆ‡ã‚Šæ›¿ãˆ ---
  if (isClosed) {
    button.innerHTML = `<span class="icon">â–²</span> é–‰ã˜ã‚‹`;
  } else {
    button.innerHTML = `<span class="icon">â–¼</span> è©³ç´°ã‚’é–‹ã`;
  }

  // --- é–‰ã˜ã‚‹å‡¦ç† ---
  if (!isClosed) {
    container.style.display = 'none';
    container.innerHTML = ""; // ä¸­èº«ã‚’æ¶ˆã™
    return;
  }

  // --- é–‹ãå‡¦ç†ï¼ˆã“ã“ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼‰ ---
  const res = await fetch(`https://yoyo-backend.kajilab.dev/results/${id}`);
  const detail = await res.json();

  container.innerHTML = `
    <p>ç·åˆè©•ä¾¡: ${detail.total_score != null ? detail.total_score.toFixed(1) + 'ç‚¹' : 'ãªã—'}</p>
    ${detail.radar_chart ? `<img src="data:image/png;base64,${detail.radar_chart}" alt="ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ" style="max-width:800px; display:block; margin:10px auto;">` : ""}
    <p>é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢: ${detail.score != null ? detail.score.toFixed(1) : 0.0}</p>
    <p>ãƒ—ãƒ­ã¨ã®å¹³å‡è·é›¢: ${detail.pro_distance_mean != null ? detail.pro_distance_mean.toFixed(1) : 'ãªã—'}</p>
    <p>ãƒ«ãƒ¼ãƒ—æ•°: ${detail.loop_count ?? 'ãªã—'}</p>
    <p>å®‰å®šé–‹å§‹ãƒ«ãƒ¼ãƒ—: ${detail.stable_loop != null ? detail.stable_loop + 'å‘¨ç›®' : 'ãªã—'}</p>
    <p>å¹³å‡ãƒ«ãƒ¼ãƒ—æ™‚é–“: ${detail.loop_mean_duration != null ? detail.loop_mean_duration.toFixed(3) : '-'} ç§’</p>
    <p>ãƒ«ãƒ¼ãƒ—æ™‚é–“ã®æ¨™æº–åå·®: ${detail.loop_std_duration != null ? detail.loop_std_duration.toFixed(3) : '-'} ç§’</p>
    <p>æ‰‹é¦–ã‚’è¿”ã™å¼·ã•ï¼ˆä¸­å¤®å€¤ï¼‰: ${detail.snap_median != null ? detail.snap_median.toFixed(3) : '-'} ç§’</p>
    <p>æ‰‹é¦–ã‚’è¿”ã™å¼·ã•ï¼ˆã°ã‚‰ã¤ãï¼‰: ${detail.snap_std != null ? detail.snap_std.toFixed(3) : '-'} ç§’</p>
    <pre id="loopDetails-${id}" style="font-size: 30px; white-space: pre-wrap;"></pre>
    <img src="data:image/png;base64,${detail.loop_plot}" alt="ãƒ«ãƒ¼ãƒ—æ¤œå‡º">
    <div class="heatmap-row">
      ${detail.self_heatmap ? `<div><h4>è‡ªå·±æ¯”è¼ƒ</h4><img src="data:image/png;base64,${detail.self_heatmap}"></div>` : ""}
      ${detail.pro_heatmap ? `<div><h4>ãƒ—ãƒ­æ¯”è¼ƒ</h4><img src="data:image/png;base64,${detail.pro_heatmap}"></div>` : ""}
    </div>
  `;

  // --- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè¡¨ç¤º ---
  if (detail.pre_survey) container.innerHTML += renderSurveyTable("äº‹å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœ", detail.pre_survey);
  if (detail.post_survey) container.innerHTML += renderSurveyTable("äº‹å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœ", detail.post_survey);

  // --- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒœã‚¿ãƒ³ ---
  container.innerHTML += `
    <button onclick="openSurvey(${id}, 'pre')">${detail.pre_survey ? "äº‹å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ç·¨é›†" : "äº‹å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’å…¥åŠ›"}</button>
    <button onclick="openSurvey(${id}, 'post')">${detail.post_survey ? "äº‹å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ç·¨é›†" : "äº‹å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’å…¥åŠ›"}</button><br>
    <button onclick="renameResult(${id})">åå‰å¤‰æ›´</button>
    <button onclick="uploadVideo(${id})">å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button><br>
  `;

  // --- å…±é€šæ“ä½œãƒœã‚¿ãƒ³ ---
  container.innerHTML += `
    <button onclick="toggleDetail(${id})">é–‰ã˜ã‚‹</button>
    <button onclick="window.location.href='https://yoyo-backend.kajilab.dev/results/${id}/csv'">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <button onclick="deleteResult(${id})" style="background-color:#f88; color:white;">ã“ã®çµæœã‚’å‰Šé™¤</button>
  `;

  container.style.display = 'block';
}


  function openSurvey(id, type) {
    const width = 600, height = 700;
    const left = (window.screen.width - width) / 2;
    const top = (window.screen.height - height) / 2;

    const popup = window.open("", "surveyWindow",
      `width=${width},height=${height},left=${left},top=${top}`);

    popup.document.write(`
      <html lang="ja">
      <head><meta charset="UTF-8"><title>${type === "pre" ? "äº‹å‰" : "äº‹å¾Œ"}ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</title></head>
      <body style="font-family:sans-serif; padding:10px;">
        <h2>${type === "pre" ? "äº‹å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ" : "äº‹å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ"}</h2>
        <form id="surveyForm">
          ${renderSurveyForm(id, type)}
          <button type="button" onclick="window.opener.saveSurvey(${id}, '${type}', window)">ä¿å­˜</button>
        </form>
      </body>
      </html>
    `);
  }

  function renderSurveyForm(id, type) {
  if (type === "pre") {
    return `
      <p>å¹´é½¢</p>
      <input type="text" id="age-${id}" placeholder="å¹´é½¢ã‚’å…¥åŠ›"> æ­³<br><br>

      <p>ãƒ¨ãƒ¼ãƒ¨ãƒ¼æ­´ï¼ˆã©ã®ãã‚‰ã„ç¶šã‘ã¦ã„ã¾ã™ã‹ï¼Ÿï¼‰</p>
      <label><input type="radio" name="history-${id}" value="ã¯ã˜ã‚ã¦">ã¯ã˜ã‚ã¦ï¼ˆçµŒé¨“ãªã—ï¼‰</label><br>
      <label><input type="radio" name="history-${id}" value="3ã‹æœˆæœªæº€">3ã‹æœˆæœªæº€</label><br>
      <label><input type="radio" name="history-${id}" value="3ã‹æœˆï½åŠå¹´">3ã‹æœˆï½åŠå¹´</label><br>
      <label><input type="radio" name="history-${id}" value="åŠå¹´ï½1å¹´">åŠå¹´ï½1å¹´</label><br>
      <label><input type="radio" name="history-${id}" value="1ï½2å¹´">1ï½2å¹´</label><br>
      <label><input type="radio" name="history-${id}" value="3ï½4å¹´">3ï½4å¹´</label><br>
      <label><input type="radio" name="history-${id}" value="5å¹´ä»¥ä¸Š">5å¹´ä»¥ä¸Š</label><br><br>

      <p>ãƒ¨ãƒ¼ãƒ¨ãƒ¼ã‚’ã™ã‚‹é »åº¦</p>
      <label><input type="radio" name="freq-${id}" value="ã»ã¨ã‚“ã©ã—ãªã„">ã»ã¨ã‚“ã©ã—ãªã„</label><br>
      <label><input type="radio" name="freq-${id}" value="æœˆã«æ•°å›">æœˆã«æ•°å›</label><br>
      <label><input type="radio" name="freq-${id}" value="é€±ã«1ï½2å›">é€±ã«1ï½2å›</label><br>
      <label><input type="radio" name="freq-${id}" value="é€±ã«3ï½4å›">é€±ã«3ï½4å›</label><br>
      <label><input type="radio" name="freq-${id}" value="ã»ã¼æ¯æ—¥">ã»ã¼æ¯æ—¥</label><br><br>

      <p>JYYFãƒ¨ãƒ¼ãƒ¨ãƒ¼æ¤œå®šã‚’å—ã‘ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ</p>
      <label><input type="radio" name="exam-${id}" value="å—é¨“çµŒé¨“ãªã—">å—é¨“çµŒé¨“ãªã—</label><br>
      <label><input type="radio" name="exam-${id}" value="å—é¨“çµŒé¨“ã‚ã‚Š">å—é¨“çµŒé¨“ã‚ã‚Šï¼ˆæœ€é«˜ä½ï¼š
        <input type="text" id="exam-rank-${id}" placeholder="ä¾‹: 3ç´š">ï¼‰
      </label><br><br>

      <p>æ™®æ®µã©ã®ã‚ˆã†ã«ãƒ¨ãƒ¼ãƒ¨ãƒ¼ã‚’ç·´ç¿’ã—ã¦ã„ã¾ã™ã‹ï¼Ÿï¼ˆè¤‡æ•°ãƒã‚§ãƒƒã‚¯å¯ï¼‰</p>
      <label><input type="checkbox" name="practice-${id}" value="1äººã§">1äººã§</label><br>
      <label><input type="checkbox" name="practice-${id}" value="å‹é”ã¨">å‹é”ã¨</label><br>
      <label><input type="checkbox" name="practice-${id}" value="è§£èª¬å‹•ç”»ã‚’è¦‹ãªãŒã‚‰">è§£èª¬å‹•ç”»ã‚’è¦‹ãªãŒã‚‰</label><br>
      <label><input type="checkbox" name="practice-${id}" value="ç·´ç¿’ä¼šã«å‚åŠ ">ç·´ç¿’ä¼šã«å‚åŠ </label><br>
      <label><input type="checkbox" name="practice-${id}" value="ãã®ä»–">ãã®ä»–ï¼š
        <input type="text" id="practice-other-${id}">
      </label><br><br>

      <p>ç·´ç¿’ã™ã‚‹ã¨ãã«å›°ã£ã¦ã„ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿï¼ˆè¤‡æ•°ãƒã‚§ãƒƒã‚¯å¯ï¼‰</p>
      <label><input type="checkbox" name="trouble-${id}" value="ãƒˆãƒªãƒƒã‚¯ãŒå®‰å®šã—ãªã„">ãƒˆãƒªãƒƒã‚¯ãŒå®‰å®šã—ãªã„</label><br>
      <label><input type="checkbox" name="trouble-${id}" value="æ€ã†ã‚ˆã†ã«ä¸Šé”ã—ãªã„">æ€ã†ã‚ˆã†ã«ä¸Šé”ã—ãªã„</label><br>
      <label><input type="checkbox" name="trouble-${id}" value="æ•™ãˆã¦ãã‚Œã‚‹äººãŒã„ãªã„">æ•™ãˆã¦ãã‚Œã‚‹äººãŒã„ãªã„</label><br>
      <label><input type="checkbox" name="trouble-${id}" value="ã§ãã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚ã‹ã‚‰ãªã„">ã§ãã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚ã‹ã‚‰ãªã„</label><br>
      <label><input type="checkbox" name="trouble-${id}" value="ãã®ä»–">ãã®ä»–ï¼š
        <input type="text" id="trouble-other-${id}">
      </label><br><br>

      <p>ãƒ¨ãƒ¼ãƒ¨ãƒ¼ãŒã©ã®ãã‚‰ã„å¾—æ„ã§ã™ã‹ï¼Ÿï¼ˆ0 = ä¸å¾—æ„ ï¼ 5 = ã¨ã¦ã‚‚å¾—æ„ï¼‰</p>
      <label><input type="radio" name="skill-${id}" value="0">0</label>
      <label><input type="radio" name="skill-${id}" value="1">1</label>
      <label><input type="radio" name="skill-${id}" value="2">2</label>
      <label><input type="radio" name="skill-${id}" value="3">3</label>
      <label><input type="radio" name="skill-${id}" value="4">4</label>
      <label><input type="radio" name="skill-${id}" value="5">5</label>
      <br><br>
    `;
  }

  if (type === "post") {
    return `
      <p>1. ãƒ‡ãƒã‚¤ã‚¹ã‚’ã¤ã‘ã¦ãƒ¨ãƒ¼ãƒ¨ãƒ¼ã‚’ã™ã‚‹ã“ã¨ã«é•å’Œæ„Ÿã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ</p>
      <label><input type="radio" name="discomfort-${id}" value="å…¨ããªã‹ã£ãŸ">å…¨ããªã‹ã£ãŸ</label><br>
      <label><input type="radio" name="discomfort-${id}" value="å°‘ã—ã‚ã£ãŸ">å°‘ã—ã‚ã£ãŸ</label><br>
      <label><input type="radio" name="discomfort-${id}" value="ã‹ãªã‚Šã‚ã£ãŸ">ã‹ãªã‚Šã‚ã£ãŸ</label><br><br>

      <p>2. ãƒ‡ãƒã‚¤ã‚¹ã®é‡ã•ã‚„å¤§ãã•ã€è£…ç€æ€§ã¯æ°—ã«ãªã‚Šã¾ã—ãŸã‹ï¼Ÿ</p>
      <label><input type="radio" name="weightfit-${id}" value="æ°—ã«ãªã‚‰ãªã‹ã£ãŸ">æ°—ã«ãªã‚‰ãªã‹ã£ãŸ</label><br>
      <label><input type="radio" name="weightfit-${id}" value="å°‘ã—æ°—ã«ãªã£ãŸ">å°‘ã—æ°—ã«ãªã£ãŸ</label><br>
      <label><input type="radio" name="weightfit-${id}" value="ã¨ã¦ã‚‚æ°—ã«ãªã£ãŸ">ã¨ã¦ã‚‚æ°—ã«ãªã£ãŸ</label><br><br>

      <p>3. ãƒ‡ãƒã‚¤ã‚¹ã«ã¤ã„ã¦è‰¯ã‹ã£ãŸç‚¹ãƒ»æ”¹å–„ã—ã¦ã»ã—ã„ç‚¹ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚</p>
      <textarea id="device-comment-${id}" rows="3" cols="50"></textarea><br><br>

      <p>4. è©•ä¾¡çµæœã®è¡¨ç¤ºï¼ˆä¾‹ï¼šã‚°ãƒ©ãƒ•ã€è©•ä¾¡ãªã©ï¼‰ã¯ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã‹ï¼Ÿ</p>
      <label><input type="radio" name="resultview-${id}" value="ã¨ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„">ã¨ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„</label><br>
      <label><input type="radio" name="resultview-${id}" value="ã‚ã‹ã‚Šã‚„ã™ã„">ã‚ã‹ã‚Šã‚„ã™ã„</label><br>
      <label><input type="radio" name="resultview-${id}" value="å°‘ã—ã‚ã‹ã‚Šã«ãã„">å°‘ã—ã‚ã‹ã‚Šã«ãã„</label><br>
      <label><input type="radio" name="resultview-${id}" value="ã‚ã‹ã‚Šã«ãã„">ã‚ã‹ã‚Šã«ãã„</label><br><br>

      <p>5. è©•ä¾¡çµæœï¼ˆã§ãã¦ã„ã‚‹ç‚¹ãƒ»ã§ãã¦ã„ãªã„ç‚¹ãªã©ï¼‰ã¯ã€ä»Šå¾Œã®ç·´ç¿’ã®å‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ</p>
      <label><input type="radio" name="useful-${id}" value="ã¨ã¦ã‚‚æ€ã†">ã¨ã¦ã‚‚æ€ã†</label><br>
      <label><input type="radio" name="useful-${id}" value="å°‘ã—æ€ã†">å°‘ã—æ€ã†</label><br>
      <label><input type="radio" name="useful-${id}" value="ã‚ã¾ã‚Šæ€ã‚ãªã„">ã‚ã¾ã‚Šæ€ã‚ãªã„</label><br>
      <label><input type="radio" name="useful-${id}" value="å…¨ãæ€ã‚ãªã„">å…¨ãæ€ã‚ãªã„</label><br><br>

      <p>6. ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ã£ã¦ã€ä»Šå¾Œã‚‚ç·´ç¿’ã—ãŸã„ã¨æ€ã„ã¾ã—ãŸã‹ï¼Ÿ</p>
      <label><input type="radio" name="continue-${id}" value="ãœã²ä½¿ã„ãŸã„">ãœã²ä½¿ã„ãŸã„</label><br>
      <label><input type="radio" name="continue-${id}" value="æ©Ÿä¼šãŒã‚ã‚Œã°ä½¿ã„ãŸã„">æ©Ÿä¼šãŒã‚ã‚Œã°ä½¿ã„ãŸã„</label><br>
      <label><input type="radio" name="continue-${id}" value="ã‚ã¾ã‚Šä½¿ã„ãŸã„ã¨æ€ã‚ãªã„">ã‚ã¾ã‚Šä½¿ã„ãŸã„ã¨æ€ã‚ãªã„</label><br><br>

      <p>7. ä»Šå¾Œã€ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã§åˆ†æã—ã¦ã»ã—ã„ãƒˆãƒªãƒƒã‚¯ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</p>
      <textarea id="future-trick-${id}" rows="3" cols="50"></textarea><br><br>

      <p>8. ã‚·ã‚¹ãƒ†ãƒ ã«ã¤ã„ã¦è‰¯ã‹ã£ãŸç‚¹ãƒ»æ”¹å–„ã—ã¦ã»ã—ã„ç‚¹ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚</p>
      <textarea id="system-comment-${id}" rows="3" cols="50"></textarea><br><br>
    `;
  }

}


  async function saveSurvey(id, type, popupWin) {
    let answers = {};

    if (type === "pre") {
      answers.age = popupWin.document.getElementById(`age-${id}`)?.value || "";
      answers.history = popupWin.document.querySelector(`input[name="history-${id}"]:checked`)?.value || "";
      answers.freq = popupWin.document.querySelector(`input[name="freq-${id}"]:checked`)?.value || "";
      answers.exam = popupWin.document.querySelector(`input[name="exam-${id}"]:checked`)?.value || "";
      answers.exam_rank = popupWin.document.getElementById(`exam-rank-${id}`)?.value || "";

      // è¤‡æ•°é¸æŠã«å¯¾å¿œ
      answers.practice = Array.from(popupWin.document.querySelectorAll(`input[name="practice-${id}"]:checked`)).map(el => el.value);
      answers.practice_other = popupWin.document.getElementById(`practice-other-${id}`)?.value || "";

      answers.trouble = Array.from(popupWin.document.querySelectorAll(`input[name="trouble-${id}"]:checked`)).map(el => el.value);
      answers.trouble_other = popupWin.document.getElementById(`trouble-other-${id}`)?.value || "";

      answers.skill = popupWin.document.querySelector(`input[name="skill-${id}"]:checked`)?.value || "";
    }


    if (type === "post") {
      answers.discomfort   = popupWin.document.querySelector(`input[name="discomfort-${id}"]:checked`)?.value || "";
      answers.weightfit    = popupWin.document.querySelector(`input[name="weightfit-${id}"]:checked`)?.value || "";
      answers["device-comment"] = popupWin.document.getElementById(`device-comment-${id}`)?.value || "";
      answers.resultview   = popupWin.document.querySelector(`input[name="resultview-${id}"]:checked`)?.value || "";
      answers.useful       = popupWin.document.querySelector(`input[name="useful-${id}"]:checked`)?.value || "";
      answers.continue     = popupWin.document.querySelector(`input[name="continue-${id}"]:checked`)?.value || "";
      answers["future-trick"]   = popupWin.document.getElementById(`future-trick-${id}`)?.value || "";
      answers["system-comment"] = popupWin.document.getElementById(`system-comment-${id}`)?.value || "";
    }


    const res = await fetch(`https://yoyo-backend.kajilab.dev/results/${id}/survey`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ survey_type: type, answers })
    });

    if (res.ok) {
      alert(type === "pre" ? "äº‹å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ" : "äº‹å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ");
      popupWin.close();
      location.reload();
      document.getElementById(`${type}-btn-${id}`).innerText =
        type === "pre" ? "äº‹å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ç·¨é›†" : "äº‹å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ç·¨é›†";
    } else {
      const errText = await res.text();
      console.error("ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:", res.status, errText);
      alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + res.status);
    }
  }

  function renderSurveyTable(title, survey) {
    if (!survey) return "";

    const labels = {
      // äº‹å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã¨åŒã˜é †åºãƒ»æ–‡è¨€ã«æƒãˆã‚‹ï¼‰

      age: "1. å¹´é½¢",
      history: "2. ãƒ¨ãƒ¼ãƒ¨ãƒ¼æ­´ï¼ˆã©ã®ãã‚‰ã„ç¶šã‘ã¦ã„ã¾ã™ã‹ï¼Ÿï¼‰",
      freq: "3. ãƒ¨ãƒ¼ãƒ¨ãƒ¼ã‚’ã™ã‚‹é »åº¦",
      exam: "4. JYYFãƒ¨ãƒ¼ãƒ¨ãƒ¼æ¤œå®šã‚’å—ã‘ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
      exam_rank: "4-è£œè¶³. æ¤œå®šã®æœ€é«˜ä½",
      practice: "5. æ™®æ®µã©ã®ã‚ˆã†ã«ãƒ¨ãƒ¼ãƒ¨ãƒ¼ã‚’ç·´ç¿’ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",
      practice_other: "5-è£œè¶³. ç·´ç¿’æ–¹æ³•ï¼ˆãã®ä»–ï¼‰",
      trouble: "6. ç·´ç¿’ã™ã‚‹ã¨ãã«å›°ã£ã¦ã„ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
      trouble_other: "6-è£œè¶³. å›°ã‚Šã”ã¨ï¼ˆãã®ä»–ï¼‰",
      skill: "7. ãƒ¨ãƒ¼ãƒ¨ãƒ¼ãŒã©ã®ãã‚‰ã„å¾—æ„ã§ã™ã‹ï¼Ÿï¼ˆ0 = ä¸å¾—æ„ ï¼ 5 = ã¨ã¦ã‚‚å¾—æ„ï¼‰",



      // äº‹å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ
      discomfort: "1. ãƒ‡ãƒã‚¤ã‚¹ã‚’ã¤ã‘ã¦ãƒ¨ãƒ¼ãƒ¨ãƒ¼ã‚’ã™ã‚‹ã“ã¨ã«é•å’Œæ„Ÿã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ",
      weightfit: "2. ãƒ‡ãƒã‚¤ã‚¹ã®é‡ã•ã‚„å¤§ãã•ã€è£…ç€æ€§ã¯æ°—ã«ãªã‚Šã¾ã—ãŸã‹ï¼Ÿ",
      "device-comment": "3. ãƒ‡ãƒã‚¤ã‚¹ã«ã¤ã„ã¦è‰¯ã‹ã£ãŸç‚¹ãƒ»æ”¹å–„ã—ã¦ã»ã—ã„ç‚¹ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
      resultview: "4. è©•ä¾¡çµæœã®è¡¨ç¤ºï¼ˆä¾‹ï¼šã‚°ãƒ©ãƒ•ã€è©•ä¾¡ãªã©ï¼‰ã¯ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã‹ï¼Ÿ",
      useful: "5. è©•ä¾¡çµæœï¼ˆã§ãã¦ã„ã‚‹ç‚¹ãƒ»ã§ãã¦ã„ãªã„ç‚¹ãªã©ï¼‰ã¯ã€ä»Šå¾Œã®ç·´ç¿’ã®å‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
      continue: "6. ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ã£ã¦ã€ä»Šå¾Œã‚‚ç·´ç¿’ã—ãŸã„ã¨æ€ã„ã¾ã—ãŸã‹ï¼Ÿ",
      "future-trick": "7. ä»Šå¾Œã€ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã§åˆ†æã—ã¦ã»ã—ã„ãƒˆãƒªãƒƒã‚¯ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
      "system-comment": "8. ã‚·ã‚¹ãƒ†ãƒ ã«ã¤ã„ã¦è‰¯ã‹ã£ãŸç‚¹ãƒ»æ”¹å–„ã—ã¦ã»ã—ã„ç‚¹ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚"
    };

    // è¡¨ç¤ºé †ã‚’å›ºå®šã™ã‚‹ãƒªã‚¹ãƒˆ
    const order_pre = [
      "age",                // 1. å¹´é½¢
      "history",            // 2. ãƒ¨ãƒ¼ãƒ¨ãƒ¼æ­´
      "freq",               // 3. ãƒ¨ãƒ¼ãƒ¨ãƒ¼ã‚’ã™ã‚‹é »åº¦
      "exam",               // 4. ãƒ¨ãƒ¼ãƒ¨ãƒ¼æ¤œå®š
      "exam_rank",          // 4-è£œè¶³. æ¤œå®šã®æœ€é«˜ä½
      "practice",           // 5. æ™®æ®µã®ç·´ç¿’æ–¹æ³•
      "practice_other",     // 5-è£œè¶³. ç·´ç¿’æ–¹æ³•ï¼ˆãã®ä»–ï¼‰
      "trouble",            // 6. ç·´ç¿’ã§å›°ã£ã¦ã„ã‚‹ã“ã¨
      "trouble_other",      // 6-è£œè¶³. å›°ã‚Šã”ã¨ï¼ˆãã®ä»–ï¼‰
      "skill"               // 7. ãƒ¨ãƒ¼ãƒ¨ãƒ¼ã®å¾—æ„åº¦
    ];

    const order_post = [
      "discomfort", "weightfit", "device-comment",
      "resultview", "useful", "continue",
      "future-trick", "system-comment"
    ];

    // ã‚¿ã‚¤ãƒˆãƒ«ã§ã©ã¡ã‚‰ã‹åˆ¤å®š
    const order = title.includes("äº‹å‰") ? order_pre : order_post;

    let rows = "";
    for (const key of order) {
      if (survey.hasOwnProperty(key)) {
        let a = survey[key];
        let answerText = Array.isArray(a) ? a.join(", ") : a;
        if (!answerText) answerText = "ï¼ˆæœªå›ç­”ï¼‰";
        rows += `<tr>
                  <th style="text-align:left; padding:5px;">${labels[key] ?? key}</th>
                  <td style="padding:5px;">${answerText}</td>
                </tr>`;
      }
    }

    return `
      <h3>${title}</h3>
      <table border="1" style="margin:10px auto; border-collapse:collapse; font-size:20px;">
        ${rows}
      </table>
    `;
  }

  function openSurveySummary() {
    const width = 800, height = 600;
    const left = (window.screen.width - width) / 2;
    const top = (window.screen.height - height) / 2;

    const popup = window.open("", "surveySummary",
      `width=${width},height=${height},left=${left},top=${top}`);

    fetch("https://yoyo-backend.kajilab.dev/survey_summary")
      .then(res => res.json())
      .then(data => {
        let html = `
          <html lang="ja">
          <head><meta charset="UTF-8"><title>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé›†è¨ˆçµæœ</title></head>
          <body style="font-family:sans-serif; padding:10px;">
            <h2>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé›†è¨ˆçµæœ</h2>
            <h3>äº‹å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h3>
            ${renderSummaryTable(data.pre)}
            <h3>äº‹å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h3>
            ${renderSummaryTable(data.post)}
          </body>
          </html>
        `;
        popup.document.write();
      });
  }

  function renderSummaryTable(surveys) {
    if (!surveys.length) return "<p>ãƒ‡ãƒ¼ã‚¿ãªã—</p>";

    // é›†è¨ˆä¾‹ï¼šé¸æŠè‚¢ã®å‡ºç¾å›æ•°ã‚«ã‚¦ãƒ³ãƒˆ
    let counts = {};
    surveys.forEach(s => {
      for (const [k, v] of Object.entries(s)) {
        const val = Array.isArray(v) ? v.join(",") : v;
        counts[k] = counts[k] || {};
        counts[k][val] = (counts[k][val] || 0) + 1;
      }
    });

    let rows = "";
    for (const [q, values] of Object.entries(counts)) {
      rows += `<tr><th>${q}</th><td>${Object.entries(values)
        .map(([ans, num]) => `${ans}: ${num}`).join("<br>")}</td></tr>`;
    }

    return `<table border="1" style="margin:10px auto; border-collapse:collapse; font-size:18px;">${rows}</table>`;
  }

  
  window.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

 // idä»˜ãã§ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆ â†’ ãã®å±¥æ­´ã ã‘ã‚’å…¨ç”»é¢è¡¨ç¤º
if (id) {
  const container = document.getElementById("history");
  container.innerHTML = "<p>èª­ã¿è¾¼ã¿ä¸­...</p>";

  try {
    const res = await fetch(`https://yoyo-backend.kajilab.dev/results/${id}`);
    if (!res.ok) throw new Error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—");
    const detail = await res.json();

    // --- YouTube ID æŠ½å‡ºç”¨é–¢æ•° ---
    const extractYouTubeId = (url) => {
      const regExp = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S*?v=|v\/|embed\/|shorts\/|watch\?v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
      const match = url?.match(regExp);
      return match ? match[1] : null;
    };

    // --- å‹•ç”»åŸ‹ã‚è¾¼ã¿HTML ---
    let videoHTML = "";
    if (detail.video_url) {
      const youtubeId = extractYouTubeId(detail.video_url);
      if (youtubeId) {
        videoHTML = `
          <div style="margin-top:20px;">
            <h3>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå‹•ç”»</h3>
            <iframe width="800" height="500"
              src="https://www.youtube.com/embed/${youtubeId}"
              title="YouTube video player"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen></iframe>
          </div>
        `;
      }
    }

    // --- è©³ç´°ã®ã¿è¡¨ç¤º ---
    container.innerHTML = `
      <div class="result">
        <p>${detail.timestamp ?? ""}</p>
        <p>${detail.name ?? "ç„¡é¡Œ"}</p>
        <p>ç·åˆè©•ä¾¡: ${detail.total_score != null ? detail.total_score.toFixed(1) + "ç‚¹" : "ãªã—"}</p>

        ${detail.radar_chart ? `<img src="data:image/png;base64,${detail.radar_chart}" alt="ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ" style="max-width:800px; display:block; margin:10px auto;">` : ""}
        <p>é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢: ${detail.score != null ? detail.score.toFixed(1) : 0.0}</p>
        <p>ãƒ—ãƒ­ã¨ã®å¹³å‡è·é›¢: ${detail.pro_distance_mean != null ? detail.pro_distance_mean.toFixed(1) : "ãªã—"}</p>
        <p>ãƒ«ãƒ¼ãƒ—æ•°: ${detail.loop_count ?? "ãªã—"}</p>
        <p>å®‰å®šé–‹å§‹ãƒ«ãƒ¼ãƒ—: ${detail.stable_loop != null ? detail.stable_loop + "å‘¨ç›®" : "ãªã—"}</p>
        <p>å¹³å‡ãƒ«ãƒ¼ãƒ—æ™‚é–“: ${detail.loop_mean_duration != null ? detail.loop_mean_duration.toFixed(3) : "-"} ç§’</p>
        <p>ãƒ«ãƒ¼ãƒ—æ™‚é–“ã®æ¨™æº–åå·®: ${detail.loop_std_duration != null ? detail.loop_std_duration.toFixed(3) : "-"} ç§’</p>
        <p>æ‰‹é¦–ã‚’è¿”ã™å¼·ã•ï¼ˆä¸­å¤®å€¤ï¼‰: ${detail.snap_median != null ? detail.snap_median.toFixed(3) : "-"} ç§’</p>
        <p>æ‰‹é¦–ã‚’è¿”ã™å¼·ã•ï¼ˆã°ã‚‰ã¤ãï¼‰: ${detail.snap_std != null ? detail.snap_std.toFixed(3) : "-"} ç§’</p>
        <pre style="font-size: 30px; white-space: pre-wrap;">${Array.isArray(detail.loop_duration_list) ? detail.loop_duration_list.join("\n") : ""}</pre>
        ${detail.loop_plot ? `<img src="data:image/png;base64,${detail.loop_plot}" alt="ãƒ«ãƒ¼ãƒ—æ¤œå‡º">` : ""}
        <div class="heatmap-row">
          ${detail.self_heatmap ? `<div><h4>è‡ªå·±æ¯”è¼ƒ</h4><img src="data:image/png;base64,${detail.self_heatmap}"></div>` : ""}
          ${detail.pro_heatmap ? `<div><h4>ãƒ—ãƒ­æ¯”è¼ƒ</h4><img src="data:image/png;base64,${detail.pro_heatmap}"></div>` : ""}
        </div>

        ${detail.pre_survey ? renderSurveyTable("äº‹å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœ", detail.pre_survey) : ""}
        ${detail.post_survey ? renderSurveyTable("äº‹å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœ", detail.post_survey) : ""}

        ${videoHTML}  <!-- ğŸ‘ˆ ã“ã“ã§å‹•ç”»ã‚’åŸ‹ã‚è¾¼ã¿è¡¨ç¤º -->

        <button onclick="window.location.href='viewer.html'">ä¸€è¦§ã«æˆ»ã‚‹</button>
        <button onclick="window.location.href='https://yoyo-backend.kajilab.dev/results/${id}/csv'">CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button onclick="deleteResult(${id})" style="background-color:#f88; color:white;">ã“ã®çµæœã‚’å‰Šé™¤</button>
      </div>
    `;
  } catch (e) {
    console.error(e);
    container.innerHTML = "<p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
  }
} else {
  // â–¼ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†å¾Œã«ä¸€è¦§ã‚’è¡¨ç¤º
  firebase.auth().onAuthStateChanged(user =>{
    if(!user) {
      location.href="index.html";
      return;
    }
    fetchHistory(user);
  });
}

});

function extractYouTubeId(url) {
  const regExp = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S*?v=|v\/|embed\/|shorts\/|watch\?v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
  const match = url.match(regExp);
  return match ? match[1] : null;
}

async function uploadVideo(id) {
  const url = prompt("YouTubeã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: https://youtu.be/xxxxï¼‰ï¼š");
  if (!url) return;

  const youtubeId = extractYouTubeId(url);
  if (!youtubeId) {
    alert("æ­£ã—ã„YouTubeã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const res = await fetch(`https://yoyo-backend.kajilab.dev/results/${id}/video`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ video_url: url })
  });

  if (res.ok) {
    alert("å‹•ç”»URLã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
    const preview = document.getElementById(`video-preview-${id}`);
    if (preview) preview.remove(); // æ—¢å­˜ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰Šé™¤
    const container = document.getElementById(`detail-${id}`);
    container.innerHTML += `
      <div id="video-preview-${id}" style="margin-top:20px;">
        <h3>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå‹•ç”»</h3>
        <iframe width="800" height="500"
          src="https://www.youtube.com/embed/${youtubeId}"
          title="YouTube video player"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen></iframe>
      </div>
    `;
  } else {
    const err = await res.text();
    console.error("å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", res.status, err);
    alert("å‹•ç”»URLã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}


  </script>

  <!-- ğŸ”¥ Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
// === ã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š ===
firebase.initializeApp({
  apiKey: "AIzaSyCIoMI9P-shqBz6RF38L_V9PG3bl5J7Pbc",
  authDomain: "yoyo-sensing.firebaseapp.com",
  projectId: "yoyo-sensing",
  storageBucket: "yoyo-sensing.firebasestorage.app",
  messagingSenderId: "129908163482",
  appId: "1:129908163482:web:8cb1c024e25b2c9a96f023",
});
</script>

</body>
</html>
