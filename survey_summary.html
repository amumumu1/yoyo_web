<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé›†è¨ˆçµæœ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    table {
      margin: 10px auto;
      border-collapse: collapse;
      font-size: 18px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
    }
    h2, h3 {
      margin-top: 30px;
    }
    canvas {
    margin: 30px auto;
    width: 1000px;   /* â† æ¨ªå¹…ã‚’åºƒãã™ã‚‹ */
    height: 500px;   /* â† é«˜ã•ã‚‚èª¿æ•´å¯èƒ½ */
    display: block;
    }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé›†è¨ˆçµæœ</h1>
  <a href="viewer.html" class="button">å±¥æ­´ä¸€è¦§ã«æˆ»ã‚‹</a>

  <canvas id="ageChart"></canvas>

  <h2>ãƒ¨ãƒ¼ãƒ¨ãƒ¼æ­´ã¨ã‚¹ã‚³ã‚¢ã®é–¢ä¿‚</h2>
  <canvas id="historyScoreChart"></canvas> <!-- ğŸ”¹ æ•£å¸ƒå›³ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ -->

  <div id="summary"></div>

  

  <script>
    async function loadSurveySummary() {
      const res = await fetch("https://yoyo-backend.kajilab.dev/survey_summary");
      const data = await res.json();

      const container = document.getElementById("summary");
      container.innerHTML = `
        <h2>äº‹å‰ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h2>
        ${renderSummaryTable(data.pre)}
        <h2>äº‹å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h2>
        ${renderSummaryTable(data.post)}
      `;

      if (data.pre && data.pre.length > 0) {
        drawAgeChart(data.pre);
      }

      // ğŸ”¹ ãƒ¨ãƒ¼ãƒ¨ãƒ¼æ­´ã¨ã‚¹ã‚³ã‚¢ã®æ•£å¸ƒå›³ã‚’æç”»
      if (data.pre && data.pre.length > 0 && data.scores) {
        drawHistoryScoreChart(data.pre);
      }
    }

    function renderSummaryTable(surveys) {
      if (!surveys || !surveys.length) return "<p>ãƒ‡ãƒ¼ã‚¿ãªã—</p>";

      let counts = {};
      surveys.forEach(s => {
        for (const [k, v] of Object.entries(s)) {
          const val = Array.isArray(v) ? v.join(", ") : v;
          counts[k] = counts[k] || {};
          counts[k][val] = (counts[k][val] || 0) + 1;
        }
      });

      let rows = "";
      for (const [q, values] of Object.entries(counts)) {
        const cell = Object.entries(values)
          .map(([ans, num]) => `${ans}: ${num}`)
          .join("<br>");
        rows += `<tr><th>${q}</th><td>${cell}</td></tr>`;
      }

      return `<table>${rows}</table>`;
    }

    // === å¹´é½¢åˆ†å¸ƒã‚°ãƒ©ãƒ• ===
    function drawAgeChart(preSurveys) {
      // ğŸ”¹ å…¨è§’â†’åŠè§’å¤‰æ›é–¢æ•°
      const toHalfWidth = (str) => {
        return str.replace(/[ï¼-ï¼™]/g, (s) =>
          String.fromCharCode(s.charCodeAt(0) - 0xFEE0)
        );
      };

      // å¹´é½¢ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      const ages = preSurveys
        .map(s => {
          if (!s.age) return null;
          const normalized = toHalfWidth(String(s.age)).trim();
          return parseInt(normalized);
        })
        .filter(n => !isNaN(n) && n > 0 && n < 100); // æœ‰åŠ¹ãªå¹´é½¢ã ã‘æ®‹ã™

      const bins = {
        "10æ­³æœªæº€": 0,
        "10ä»£": 0,
        "20ä»£": 0,
        "30ä»£": 0,
        "40ä»£": 0,
        "50ä»£": 0,
        "60ä»£": 0,
        "70ä»£": 0
      };

      for (const a of ages) {
        if (a < 10) bins["10æ­³æœªæº€"]++;
        else if (a < 20) bins["10ä»£"]++;
        else if (a < 30) bins["20ä»£"]++;
        else if (a < 40) bins["30ä»£"]++;
        else if (a < 50) bins["40ä»£"]++;
        else if (a < 60) bins["50ä»£"]++;
        else if (a < 70) bins["60ä»£"]++;
        else if (a < 80) bins["70ä»£"]++;
      }

      const labels = Object.keys(bins);
      const values = Object.values(bins);

      const ctx = document.getElementById("ageChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "å¹´é½¢åˆ†å¸ƒï¼ˆ10æ­³åˆ»ã¿ï¼‰",
            data: values,
            backgroundColor: "rgba(54, 162, 235, 0.6)",
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }

    // === ãƒ¨ãƒ¼ãƒ¨ãƒ¼æ­´ã¨ã‚¹ã‚³ã‚¢ã®æ•£å¸ƒå›³ ===
    function drawHistoryScoreChart(preSurveys, scoreData) {
      // ğŸ”¹ çµŒé¨“å¹´æ•°ã‚’æ•°å€¤åŒ–ã™ã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°
      const mapHistoryToYears = (history) => {
        if (!history) return null;
        if (history.includes("ã¯ã˜ã‚ã¦")) return 0;
        if (history.includes("3ã‹æœˆæœªæº€")) return 0.25;
        if (history.includes("3ã‹æœˆï½åŠå¹´")) return 0.5;
        if (history.includes("åŠå¹´ï½1å¹´")) return 1;
        if (history.includes("1ï½2å¹´")) return 1.5;
        if (history.includes("3ï½4å¹´")) return 3.5;
        if (history.includes("5å¹´ä»¥ä¸Š")) return 6;
        return null;
      };

      // ğŸ”¹ preã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¨ã‚¹ã‚³ã‚¢ã‚’ç´ã¥ã‘
      const points = [];
      preSurveys.forEach((s, i) => {
        const years = mapHistoryToYears(s.history);
        const score = scoreData[i]?.total_score;
        if (years != null && score != null) {
          points.push({ x: years, y: score });
        }
      });

      if (points.length === 0) return;

      const ctx = document.getElementById("historyScoreChart").getContext("2d");
      new Chart(ctx, {
        type: "scatter",
        data: {
          datasets: [{
            label: "ãƒ¨ãƒ¼ãƒ¨ãƒ¼æ­´ã¨ã‚¹ã‚³ã‚¢ã®é–¢ä¿‚",
            data: points,
            backgroundColor: "rgba(255, 99, 132, 0.7)",
            borderColor: "rgba(255, 99, 132, 1)",
            pointRadius: 8
          }]
        },
        options: {
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: "ãƒ¨ãƒ¼ãƒ¨ãƒ¼æ­´ï¼ˆå¹´æ›ç®—ï¼‰" },
              ticks: { stepSize: 1 }
            },
            y: {
              title: { display: true, text: "ç·åˆè©•ä¾¡ï¼ˆç‚¹ï¼‰" },
              beginAtZero: true,
              suggestedMax: 100
            }
          }
        }
      });
    }

    loadSurveySummary();
  </script>
</body>
</html>
