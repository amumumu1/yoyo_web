<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æˆé•·ã‚°ãƒ©ãƒ•</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<style>
    body {
        text-align:center;
        font-family:sans-serif;
        margin:0;                 /* â† ä½™ç™½ã‚¼ãƒ­ */
        padding-top:15px;         /* å°‘ã—ã®ã¿ä½™ç™½ */
    }

    canvas{
        width:100vw !important;
        height:calc(100vh - 200px) !important;  /* â† ã»ã¼ç”»é¢å…¨ä½“ */
        max-width:none !important;
        display:block;
        margin:0 auto;
    }

    select{
        font-size:22px;
        padding:6px 12px;
        margin:10px;
    }

    .button{
        padding:10px 16px;
        background:#eee;
        border-radius:5px;
        border:1px solid #aaa;
        font-size:20px;
        text-decoration:none;
        color:#333;
    }
</style>


<script>
const firebaseConfig={
apiKey:"AIzaSyCIoMI9P-shqBz6RF38L_V9PG3bl5J7Pbc",
authDomain:"yoyo-sensing.firebaseapp.com",
projectId:"yoyo-sensing",
storageBucket:"yoyo-sensing.firebasestorage.app",
messagingSenderId:"129908163482",
appId:"1:129908163482:web:8cb1c024e25b2c9a96f023"
};
firebase.initializeApp(firebaseConfig);

let chart=null;

//------------------ ã‚°ãƒ©ãƒ•æç”» ------------------
async function drawGraph(type){
    const user=firebase.auth().currentUser;
    if(!user) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");

    const res=await fetch(`https://yoyo-backend.kajilab.dev/results_user_graph?uid=${user.uid}&email=${user.email}`);
    const data=await res.json();

    const labels = data.map(d => {
        // "2025-02-14 18:22:40" â†’ "2/14 18:22" ã«çŸ­ç¸®
        const dt = new Date(d.timestamp.replace(/-/g,'/')); 
        return `${dt.getMonth()+1}/${dt.getDate()} ${dt.getHours()}:${String(dt.getMinutes()).padStart(2,"0")}`;
    });

    const values=data.map(d=>d[type]);

    if(chart) chart.destroy();

    chart=new Chart(document.getElementById("graph"),{
        type:"line",
        data:{
            labels,
            datasets:[{
                label:type,
                data:values,
                borderWidth:3,
                pointRadius:5,
                fill:false
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,

            scales:{
                x:{
                    title:{display:true,text:"æ—¥æ™‚"},
                    ticks:{
                        maxRotation:45,
                        minRotation:30,
                        autoSkip:true,        // â† ãƒ©ãƒ™ãƒ«é–“å¼•ã
                        autoSkipPadding:10
                    }
                },
                y:{ title:{display:true,text:type} }
            }
        }

    });
}

document.addEventListener("DOMContentLoaded",()=>{
    firebase.auth().onAuthStateChanged(u=>{
        if(!u) return location.href="login.html";
        drawGraph("total_score");
    });
});
</script>
</head>

<body>

<h1>ğŸ“ˆ ç·´ç¿’æˆé•·ã‚°ãƒ©ãƒ•</h1>

<select onchange="drawGraph(this.value)">
    <option value="total_score">ç·åˆè©•ä¾¡</option>
    <option value="score">è‡ªå·±æ¯”è¼ƒã‚¹ã‚³ã‚¢</option>
    <option value="loop_mean_duration">å¹³å‡ãƒ«ãƒ¼ãƒ—æ™‚é–“</option>
    <option value="loop_std_duration">ãƒ«ãƒ¼ãƒ—ã°ã‚‰ã¤ã</option>
    <option value="stable_loop">å®‰å®šé–‹å§‹ãƒ«ãƒ¼ãƒ—</option>
    <option value="pro_distance_mean">ãƒ—ãƒ­è·é›¢å¹³å‡</option>
</select>

<br>
<a href="viewer.html" class="button">â† å±¥æ­´ã«æˆ»ã‚‹</a>

<canvas id="graph"></canvas>

</body>
</html>
