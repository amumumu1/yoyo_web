<!DOCTYPE html>
<html lang="ja">
<head>
  <script src="./three.min.js"></script>
  <script src="./STLLoader.js"></script>







  <meta charset="UTF-8" />
  <title>ã‚¤ãƒ³ã‚µã‚¤ãƒ‰ãƒ»ãƒ«ãƒ¼ãƒ—æŠ€èƒ½è©•ä¾¡</title>
  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      text-align: center;
    }
    #heatmap,
    #comparePlot,
    #CombinedContainer {
      display: none !important;
    }

    body { font-family: 'Hiragino Sans', sans-serif; padding: 20px; }
    button { margin-right: 10px; padding: 10px; font-size: 25px; }
    #score, #loopSummary, #loopDetails, #proDistance { font-size: 30px;}
    pre { background: #f4f4f4; padding: 10px; max-height: 200px; overflow: auto; }

    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ç”¨ */
    #loading {
      /* è¦ªè¦ç´ ã‚’å›ºå®šå¹…ã« */
      display: none;      /* ã“ã“ã§åˆæœŸéè¡¨ç¤ºã«å›ºå®š */
      width: 1000px;       
      max-width: 90%;
      box-sizing: border-box;
      text-align: left;
      position: fixed;    /* æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ«ã‚‚ãã®ã¾ã¾ */
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px 40px;
      border-radius: 10px;
      z-index: 9999;  
    }

    #loading .progress-container {
      /* è¦ªè¦ç´ ã„ã£ã±ã„ã«åºƒãŒã‚‹ */
      width: 100%;
      background: #ddd;
      border-radius: 5px;
      height: 30px;
      margin: auto;
      overflow: hidden;
    }

    #loading .progress-bar {
      width: 0%;
      height: 100%;
      background: #3498db;
      transition: width 0.3s;
    }

    #loading #progressText {
      font-size: 50px;
      margin-top: 15px;
      text-align: center;
    }

    #loopPlot, #comparePlot {
      display: none;
      margin: 0 auto;
      width: auto;
      max-width: 100%;
      margin-bottom: 40px;
    }
    h2 { font-size: 40px; }
    h3 { font-size: 30px; }
    h4 { font-size: 30px; }
    h5 { font-size: 50px; }

    #appTitle {
      font-size: 50px;
      margin: 20px 0;   /* â† 83px â†’ 20px ã«ç¸®ã‚ã‚‹ */
      padding: 10px 0;  /* â† èƒŒæ™¯ã«ä½™ç™½ãŒã‚ã‚‹ãªã‚‰ã“ã“ã§èª¿æ•´ */
    }



    .heatmap-grid {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
      flex-wrap: nowrap;
      margin: 20px auto;
      max-width: 100%;
    }
    .heatmap-grid div {
      flex: 1;
      max-width: 50%;
      text-align: center;
    }
    .heatmap-grid img {
      width: 100%;
      height: auto;
    }
    #radarChart {
      display: block;
      margin: 0 auto;
      width: 600px;
      max-width: 100%;
      margin-bottom: 30px;
    }
    .heatmap-grid h4 {
      min-height: 3em;
      text-align: center;
    }
    /* â”€â”€ ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆç”¨ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— â”€â”€ */
    .radar-wrap {
      position: relative;
      display: inline-block;
    }
    .radar-tip {
      position: absolute;
      width: 220px;   /* æ¨ªå¹…ã‚’åºƒã’ã‚‹ï¼ˆä¾‹: 2å€ï¼‰ */
      height: 60px; 
      /* â†“ ãƒ‡ãƒãƒƒã‚°ç”¨å¯è¦–åŒ– â†“ */
      /* background: rgba(0, 128, 255, 0.2); åŠé€æ˜ãƒ–ãƒ«ãƒ¼ */
      /* outline: 1px dashed rgba(0, 128, 255, 0.8); æ ç·š */
    }
   .radar-tip .hotspot {
      width: 100%;         /* æ¨ªå¹…ã‚’æ‹¡å¤§ï¼ˆ10% â†’ 16%ï¼‰ */
      height: 48px;       /* é«˜ã•ã¯å›ºå®šå€¤ã§ç¶­æŒ */
      border-radius: 50%; /* ä¸¸ã¿ã‚’ç¶­æŒã™ã‚‹ãªã‚‰50% */
      pointer-events: auto;
    }
    .radar-tip .tooltip {
      position: absolute;
      top: -12px; /* ä½ç½®ã¯å„tipã§ä¸Šæ›¸ãå¯ */
      left: 50%;
      transform: translate(-50%, -100%);
      background: #ACC7DF;
      color: black;
      font-size: 25px;
      line-height: 1.4;
      padding: 8px 10px;
      border-radius: 8px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease;
      z-index: 1;
      max-width: 70vw;
    }
    .radar-tip:hover .tooltip {
      opacity: 1;
    }
    

    /* ãƒ¬ãƒ¼ãƒ€ãƒ¼ã®é‡ãªã‚Šé †ã‚’æœ€å‰é¢ã« */
    .radar-wrap { position: relative; z-index: 10; overflow: visible; }
    .radar-tip { position: absolute; transform: translate(-50%, -50%); z-index: 15; }
    .radar-tip .hotspot { 
      width: 12%;
      /* /* ã‚‚ã— Chrome/Safari ã§ hover ã—ã«ãã„å ´åˆã¯ã€ä¸‹ã® min-height ã‚’æœ‰åŠ¹åŒ– */
      min-height: 60px;  
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      pointer-events: auto;
    }
    

    /* ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ä¸€å¸¯ã¯æ¨ªæ›¸ãã§å›ºå®šï¼ˆå¼·ã‚ã®ç‰¹ç•°æ€§ + !importantï¼‰ */
    #Rui .hm-wrap > .hm-tip,
    #Rui .hm-wrap > .hm-tip .tooltip,
    #Rui .hm-wrap > .hm-tip .tooltip * {
      writing-mode: horizontal-tb !important;
      text-orientation: mixed !important;
      direction: ltr !important;
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®å®Ÿã‚µã‚¤ã‚ºã‚’è¦ª(28px)ã«ä¾å­˜ã•ã›ãªã„ */
    #Rui .hm-wrap > .hm-tip .tooltip{
      position: absolute;
      bottom: calc(100% + 10px);
      left: 0%;
      /* transform: translateX(-50%); */

      display: block !important;          /* shrink-to-fitå›é¿ */
      width: clamp(360px, 60vw, 800px) !important;
      min-width: 500px !important;
      max-height: 70vh;
      overflow: auto;

      /* æ—¥æœ¬èªã®è‡ªç„¶ãªæŠ˜è¿”ã— */
      white-space: normal !important;
      word-break: normal !important;
      overflow-wrap: break-word !important;
      line-break: loose;

      background: #ACC7DF;
      color: black;
      font-size: 30px;
      padding: 10px 12px;
      border-radius: 8px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease;
      text-align: center;
      z-index: 3;
    }
    #Rui .hm-wrap > .hm-tip:hover .tooltip,
    #Rui .hm-wrap > .hm-tip:focus .tooltip { opacity: 1; }

    #Rui .hm-wrap > .hm-tip .tooltip::after{
      content: "";
      position: absolute;
      top: 100%;
      left: 0%;
      /* transform: translateX(-50%); */
      border: 6px solid transparent;
      border-top-color: gray;
    }

    /* ç”»åƒï¼‹â“˜ ã®åŒ…ã¿ã‚’çµ¶å¯¾é…ç½®ã®åŸºæº–ã«ã™ã‚‹ */
    #Rui .hm-wrap{
      position: relative;            /* â†ã“ã‚ŒãŒå¿…é ˆ */
      display: inline-block;
      max-width: 100%;
      text-align: initial;           /* è¦ªã® center ã®å½±éŸ¿ã‚’å—ã‘ãªã„ä¿é™º */
    }
    #Rui .hm-wrap img{ display:block; height:auto; }

    /* â“˜ ãƒœã‚¿ãƒ³ã‚’ç”»åƒã®å³ä¸Šã«é‡ã­ã‚‹ */
    #Rui .hm-wrap .hm-tip{
      position: absolute;            /* â† ã“ã“ã§é‡ã­ã‚‹ */
      top: 8px;
      left: 8px;
      width: 28px; height: 28px; border-radius: 50%;
      background: gray; color: white; font-weight: bold;
      display: flex; align-items: center; justify-content: center;
      z-index: 2;
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã¯ i ã®ã‚µã‚¤ã‚ºã«ä¾å­˜ã•ã›ãšå›ºå®šå¹…ã§ */
    #Rui .hm-wrap .hm-tip .tooltip{
      position: absolute;
      bottom: calc(100% + 10px);
      left: 0%;
      /* transform: translateX(-50%); */

      width: clamp(360px, 60vw, 800px);  /* ã—ã£ã‹ã‚Šæ¨ªå¹…ã‚’ç¢ºä¿ */
      max-height: 70vh; overflow: auto;

      white-space: normal;
      word-break: normal;
      overflow-wrap: break-word;
      line-break: loose;

      background: #ACC7DF; color: black;
      font-size: 20px; 
      padding: 10px 12px; border-radius: 8px;
      opacity: 0; pointer-events: none; transition: opacity .15s;
      text-align: center; z-index: 3;
      font-weight: normal; /* å¤ªå­—è§£é™¤ */
    }
    #Rui .hm-wrap .hm-tip:hover .tooltip,
    #Rui .hm-wrap .hm-tip:focus .tooltip{ opacity: 1; }

    #Rui .hm-wrap .hm-tip .tooltip::after{
      content: ""; position: absolute; top: 100%;
      left: 0%; 
      /* transform: translateX(-50%); */
      border: 6px solid transparent; border-top-color: gray;
    }
    /* â”€â”€ ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ•°å€¤ã«ä»˜ã‘ã‚‹ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— â”€â”€ */
    .inline-tip {
      position: relative;
      cursor: help;
      border-bottom: 2px dotted rgba(0,0,0,.35); /* ä¸‹ç·šã§ãƒ’ãƒ³ãƒˆæ„Ÿ */
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—æœ¬ä½“ï¼ˆå­è¦ç´ ï¼‰ */
    .inline-tip .bubble {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      /* â˜…ã“ã“ã‚’å¯å¤‰ã« */
      display: inline-block;
      width: fit-content;               /* ä¸­èº«ã®å¹…ã«ãƒ•ã‚£ãƒƒãƒˆ */
      max-width: 1000%;      /* ç”»é¢ã‚„å¯èª­æ€§ã®ä¸Šé™ã ã‘æ®‹ã™ */
      /* 1è¡Œã«åã‚ãŸã„ãªã‚‰ â†“ ã‚’ normal â†’ nowrap ã« */
      white-space: nowrap;

      max-height: 60vh;
      overflow: auto;

      background: #ACC7DF;
      color: #000;
      font-size: 25px;
      line-height: 1.6;
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 4px 18px rgba(0,0,0,.15);
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease;
      z-index: 30;

      /* å¿µã®ãŸã‚ï¼šç¸¦æ›¸ãæ±šæŸ“ã‚’é®æ–­ */
      writing-mode: horizontal-tb !important;
      text-orientation: mixed !important;
      font-weight: normal; /* å¤ªå­—ç¶™æ‰¿ã‚’é®æ–­ */
      text-align: center;
      white-space: nowrap;
      word-break: normal;
      overflow-wrap: break-word;
    }

    /* å¹ãå‡ºã—ä¸‰è§’ */
    .inline-tip .bubble::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #ACC7DF;
    }

    .inline-tip:hover .bubble,
    .inline-tip:focus-within .bubble {
      opacity: 1;
    }

        /* ãƒ©ãƒ™ãƒ«å´ã§ã‚‚å¿…ãšæ¨ªæ›¸ãï¼†å¤ªå­—ç¶™æ‰¿ã‚’é®æ–­ */
    .inline-tip,
    .inline-tip * {
      writing-mode: horizontal-tb !important;
      text-orientation: mixed !important;
      font-weight: inherit;
    }

    .inline-tip {
      position: relative;
      display: inline-block;      /* ç›¸å¯¾åŸºæº– & hoverã—ã‚„ã™ã„ */
      cursor: help;
      border-bottom: 2px dotted rgba(0,0,0,.35); /* ãƒ©ãƒ™ãƒ«ã«ã‚‚ä¸‹ç·š */
    }

    .metric-line { margin: 8px 0 4px; }
    .metric-line .inline-tip { margin-right: 1.2em; }

    .num-red {
      color: red;
      font-weight: bold; /* å¿…è¦ãªã‚‰å‰Šé™¤å¯ */
    }

    .video-wrap{
      width: min(100%, 960px);
      aspect-ratio: 16 / 9;
      margin: 0 auto 24px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 24px rgba(0,0,0,.12);
    }
    .video-wrap iframe{ width:100%; height:100%; border:0; display:block; }

    /* â–¼ ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã®ç„¡åŠ¹çŠ¶æ…‹ï¼ˆdisabledï¼‰ã‚’çµ±ä¸€ãƒ‡ã‚¶ã‚¤ãƒ³ã«ã™ã‚‹ */
    button:disabled {
      background: #eaeaea !important;   /* ã‚°ãƒ¬ãƒ¼ã‚’çµ±ä¸€ */
      color: #b5b5b5 !important;        /* æ–‡å­—è‰²ã‚‚åŒã˜ãè–„ã */
      border: 1px solid #dcdcdc !important;
      opacity: 1 !important;            /* â† ã“ã‚ŒãŒã¨ã¦ã‚‚é‡è¦ï¼ */
      cursor: not-allowed;
    }

    #commentSection h3 {
      color: #333;
      font-weight: bold;
    }
    #commentSection .blockTitle {
      font-weight: bold;
      margin-bottom: 4px;
      text-align: center;
    }
    #typeLabel {
      text-align: center !important;
    }
    /* ===== ã‚³ãƒ¡ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰å…¨ä½“ ===== */
    .comment-card {
      background: #ffffff;
      padding: 20px 30px;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.10);
      margin-top: 25px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
      text-align: center;   /* ä¸­å¤®æƒãˆ */
    }

    /* è¦‹å‡ºã—ï¼ˆå¼·ã¿ãƒ»å¼±ã¿ãƒ»æ”¹å–„æ¡ˆï¼‰ */
    .comment-card .blockTitle {
      font-size: 30px;
      margin-bottom: 8px;
      font-weight: bold;
      text-align: center;
    }

    /* ãƒªã‚¹ãƒˆã¯å·¦å¯„ã›ã«ã™ã‚‹ */
    .comment-card ul {
      text-align: left;
      margin: 0 auto;
      display: inline-block;
      font-size: 26px;
      line-height: 1.6;
    }

    /* ===== ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆç·ãƒ«ãƒ¼ãƒ—æ•°ã€œã‚¹ãƒŠãƒƒãƒ—ï¼‰ã‚«ãƒ¼ãƒ‰ ===== */
    .metric-card {
      background: #ffffff;
      padding: 25px 30px;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.10);
      margin-top: 25px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
      text-align: center;
      font-size: 30px;
    }

    .metric-card .metric-line {
      margin: 14px 0;
    }

    .metric-card .inline-tip {
      font-size: 30px;
    }

   
    #proExample {
        text-align: center !important;
    }

    #proExample h2,
    #proExample h3 {
        text-align: center !important;
        width: 100%;
    }

    #proExample img,
    #proExample video {
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    /* â–¼ CSVã‚¨ãƒªã‚¢ã‚’å®Œå…¨ã«ä¸­å¤®æƒãˆã«ã™ã‚‹ */
    #csvTitle,
    #accLabel,
    #gyroLabel,
    #accOutput,
    #gyroOutput {
        text-align: center !important;
        margin-left: auto !important;
        margin-right: auto !important; 
    }

    /* preï¼ˆCSVä¸­èº«ï¼‰ã¯å¹…ãŒåºƒã„ã®ã§ä¸­å¤®ã«å¯„ã›ã‚‹ */
    #accOutput,
    #gyroOutput {
        max-width: 500px;
        font-size: 18px;
        text-align: center !important;  /* å†…å®¹ã¯å·¦å¯„ã›ç¶­æŒ */
        margin-left: auto;
        margin-right: auto;
    }

    #btnSaveCsv {
        display: block;
        margin: 0 auto;
        text-align: center;
    }

    /* ===== ãŠçŸ¥ã‚‰ã›æ¬„ ===== */
    #newsBox {
      max-width: 900px;
      margin: 40px auto 30px;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      padding: 18px 24px;
      text-align: center;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼å®Œå…¨ä¸­å¤® */
    .news-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    /* è¦‹å‡ºã— */
    .news-title {
      font-size: 32px;
      font-weight: bold;
    }

    .news-sub {
      font-size: 18px;
      color: #888;
    }

    /* ãƒªã‚¹ãƒˆæœ¬ä½“ */
    .news-list {
      list-style: none;
      padding: 0;
      margin: 0 auto;
      max-height: 160px;
      overflow-y: auto;
    }

    /* å„è¡Œï¼šæ¨ªãƒ»ç¸¦ã¨ã‚‚ã«ä¸­å¤® */
    .news-list li {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 22px;
      text-align: center;      /* â† å¿µã®ãŸã‚ */
    }

    /* æœ€çµ‚è¡Œã®ä¸‹ç·šå‰Šé™¤ */
    .news-list li:last-child {
      border-bottom: none;
    }

    /* æ—¥ä»˜ */
    .news-date {
      font-size: 18px;
      color: #666;
      white-space: nowrap;
      text-align: center;
    }

    /* æœ¬æ–‡ */
    .news-text {
      writing-mode: horizontal-tb !important;
      text-orientation: mixed !important;
    }

    /* NEW ãƒãƒƒã‚¸ */
    .news-badge {
      font-size: 16px;
      padding: 2px 8px;
      border-radius: 6px;
      font-weight: bold;
    }

    .news-badge.new {
      background: #e74c3c;
      color: white;
    }

    #newsBox,
    #newsBox * {
      writing-mode: horizontal-tb !important;
      text-orientation: mixed !important;
    }




















  </style>
  <!-- ============================
  ğŸ”¥ Firebase èªè¨¼èª­ã¿è¾¼ã¿
  =============================== -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script>
  // ===== Firebase è¨­å®š =====
  const firebaseConfig = {
    apiKey: "AIzaSyCIoMI9P-shqBz6RF38L_V9PG3bl5J7Pbc",
    authDomain: "yoyo-sensing.firebaseapp.com",
    projectId: "yoyo-sensing",
    storageBucket: "yoyo-sensing.firebasestorage.app",
    messagingSenderId: "129908163482",
    appId: "1:129908163482:web:8cb1c024e25b2c9a96f023",
  };
  firebase.initializeApp(firebaseConfig);


  // ============================
  // ğŸ”¥ indexç”»é¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½çµ±åˆ
  // ============================
  function googleLogin(){
    const provider=new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithPopup(provider)
      .then(()=>location.reload())   // â†ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«å³ç”»é¢åæ˜ 
      .catch(err=>alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: "+err));
  }

  function googleLogin(){
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" }); // â†ã“ã‚ŒãŒæœ€é‡è¦ï¼

    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION).then(()=>{
      return firebase.auth().signInWithPopup(provider);
    })
    .then(()=>location.reload())
    .catch(err=>alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: "+err));
  }


  function logout(){
    firebase.auth().signOut().then(()=>{
      // ã“ã“ã§å®Œå…¨ã«è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã‚’ç„¡åŠ¹åŒ–
      sessionStorage.clear();
      localStorage.clear();
      location.reload();
    });
  }


  // ===========================================
  // ğŸ”¥ DOMãƒ­ãƒ¼ãƒ‰å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§è¡¨ç¤ºã‚’åˆ‡æ›¿
  // ===========================================
  document.addEventListener("DOMContentLoaded",()=>{
    firebase.auth().onAuthStateChanged(user=>{
      
      const loginArea = document.getElementById("login-area");
      const btnRi     = document.getElementById("btnRi");

      if(!user){
        btnRi.disabled = true;
        btnRi.style.opacity = "0.4";
        btnRi.style.pointerEvents = "none"; // â†æŠ¼ã›ãªã„ç¢ºå®š
        btnRi.innerText = "å±¥æ­´ã‚’è¦‹ã‚‹ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¿…è¦ï¼‰"; // è¡¨ç¤ºæ–‡ã‚’å¤‰ãˆã‚‹

        // â˜… ã“ã“ã‚’è¿½åŠ ï¼šæœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ã€Œã‚ãªãŸã€
        currentUserName = 'ã‚ãªãŸ';

        // -------- æœªãƒ­ã‚°ã‚¤ãƒ³è¡¨ç¤º --------
        loginArea.innerHTML = `
          <div style="display:flex; justify-content:center; margin-top:5px; margin-bottom:10px;">
            <button onclick="googleLogin()" 
              style="
                font-size:25px;
                padding:12px 24px;
                background:#4285F4;
                color:#fff;
                border:none;
                border-radius:6px;
                cursor:pointer;
                display:flex;
                align-items:center;
                gap:8px;
              ">
              <img src="https://developers.google.com/identity/images/g-logo.png" 
                  style="width:24px;height:24px;">
              Googleã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
          </div>
        `;

      }else{
        btnRi.disabled = false;
        btnRi.style.opacity = "1";
        btnRi.style.pointerEvents = "auto";
        btnRi.innerText = "å±¥æ­´ã‚’è¦‹ã‚‹"; // é€šå¸¸åã«æˆ»ã™

        currentUserName = user.displayName || user.email || 'ã‚ãªãŸ';
        // -------- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹è¡¨ç¤º --------
        loginArea.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-top:5px; margin-bottom:10px;">
            <span style="font-size:25px; color:#333;"> <img src="https://developers.google.com/identity/images/g-logo.png" 
                  style="width:24px;height:24px;"> ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š <b>${user.email}</b></span>
            
            <button onclick="logout()"
              style="
                font-size:25px;
                padding:8px 18px;
                background:#e74c3c;
                color:white;
                border:none;
                border-radius:6px;
                cursor:pointer;
              ">
              ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
          </div>
        `;
      }
      
    });
  });
  </script>

</head>
<body>
  <div class="container">

    <div style="text-align:right; margin-bottom: 8px">
      <label for="langSelect" style="font-size:14px; margin-right:6px;">Language:</label>
      <select id="langSelect">
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="en">English</option>
      </select>
    </div>


    <h5 id="appTitle">ã‚¤ãƒ³ã‚µã‚¤ãƒ‰ãƒ»ãƒ«ãƒ¼ãƒ—æŠ€èƒ½è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ <br></h5>

    <div id="login-area" style="margin-top:20px;"></div>
    
    <button id="btnConnect">æ¥ç¶š &amp; ã‚»ãƒ³ã‚·ãƒ³ã‚°é–‹å§‹</button>
    <input type="file" id="csvFiles" accept=".csv" multiple style="display:none;">
    <button id="btnCsvMode">CSVã‹ã‚‰è§£æ</button>
    <button id="btnRestart" style="display:none;">ã‚„ã‚Šç›´ã™</button>
    <button id="btnStop" disabled>ã‚»ãƒ³ã‚·ãƒ³ã‚°çµ‚äº†</button>
    <button id="btnCancel"  style="display:none;">ä¸­æ­¢</button>
    <button id="btnRi"  onclick="location.href='/viewer'">å±¥æ­´ã‚’è¦‹ã‚‹</button>


    <!-- ===== æ›´æ–°æƒ…å ± / ãŠçŸ¥ã‚‰ã› ===== -->
    <div id="newsBox">
    <div class="news-header">
      <span class="news-title" id="newsTitle">ãŠçŸ¥ã‚‰ã›</span>
      <span class="news-sub">News / Update</span>
    </div>

    <ul class="news-list">
      <li>
        <span class="news-date">2025/12/29</span>
        <span class="news-badge new">NEW</span>
        <span class="news-text">ãƒ—ãƒ­é¡ä¼¼åº¦ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’ï¼‘æ¬¡å…ƒã«å¤‰æ›´ã—ã¾ã—ãŸ</span>
      </li>
      <li>
        <span class="news-date">2025/12/23</span>
        <span class="news-text">ãƒ—ãƒ­é¡ä¼¼åº¦ã®è©•ä¾¡åŸºæº–ã‚’èª¿æ•´ã—ã¾ã—ãŸ</span>
      </li>
    </ul>
  </div>


    

    <h2 id="demoHeading"><br>ãƒ‡ãƒ¢å‹•ç”»</h2>


    <div id="introVideo" class="video-wrap" aria-label="å‚è€ƒå‹•ç”»">
      <iframe
        src="https://www.youtube.com/embed/x0VCf-ClRmM?si=aH6Zstq-lA3qtXoO"
        title="YouTube video player"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        referrerpolicy="strict-origin-when-cross-origin"
        allowfullscreen
        loading="lazy">
      </iframe>
    </div>

    <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
    <div id="loading">
      <div class="progress-container">
        <div id="progressBar" class="progress-bar"></div>
      </div>
      <div id="progressText">è§£ææº–å‚™ä¸­â€¦</div>
    </div>

    <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚°ãƒ©ãƒ• -->
    <h3 style="display:none;" id="accTitle">åŠ é€Ÿåº¦</h3>
    <canvas id="accChart" width="800" height="150" style="display: none;"></canvas>
    <h3 style="display:none;" id="gyroTitle">è§’é€Ÿåº¦</h3>
    <canvas id="gyroChart" width="800" height="150" style="display: none;"></canvas>

    <!-- è§£æçµæœã‚¨ãƒªã‚¢ -->
    <hr id="hrTitle" style="display: none; border: none; border-top: 2px solid black; width: 100%; margin: 40px 0;" />
    <br>
    <div id="saveSection" style="display: none;">
      <input type="text" id="resultName" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" style="font-size:16px; padding:5px; width:340px;" />
      <button id="btnSaveResult" style="display:none;">çµæœã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <h2 id="Title" style="display: none;">è§£æçµæœ</h2>
    <h3 id="RadarTitle" style="display: none;">ç·åˆè©•ä¾¡ï¼ˆãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆï¼‰</h3>
    <!-- <img id="radarChart" style="display: none; width: 600px; max-width: 100%; margin-bottom: 30px;" /> -->
    <!-- ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆï¼ˆç”»åƒï¼‹ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆï¼‰ -->
    <div id="radarWrap" class="radar-wrap" style="display:none; width: 600px; max-width: 100%;">
      <img id="radarChart" style="width: 100%; height: auto; display:block; margin-bottom: 30px;" />

      <div class="radar-tip" style="left: 49%; top: 2%;">
        <div class="hotspot" title="è‡ªèº«ã®é¡ä¼¼åº¦"></div>
        <div class="tooltip" id="tipSelfSim"></div>
      </div>

      <div class="radar-tip" style="left: 88%; top: 36%;">
        <div class="hotspot" title="å¹³å‡ãƒ«ãƒ¼ãƒ—æ™‚é–“"></div>
        <div class="tooltip" id="tipMeanLoopTime"></div>
      </div>

      <div class="radar-tip" style="left: 73%; top: 91%;">
        <div class="hotspot" title="ãƒ«ãƒ¼ãƒ—æ™‚é–“ã®ã°ã‚‰ã¤ã"></div>
        <div class="tooltip" id="tipLoopVar"></div>
      </div>

      <div class="radar-tip" style="left: 23%; top: 91%;">
        <div class="hotspot" title="å®‰å®šé–‹å§‹ãƒ«ãƒ¼ãƒ—"></div>
        <div class="tooltip" id="tipStableStart"></div>
      </div>

      <div class="radar-tip" style="left: 9%; top: 36%;">
        <div class="hotspot" title="ãƒ—ãƒ­é¡ä¼¼åº¦"></div>
        <div class="tooltip" id="tipProSim"></div>
      </div>
    </div>

    <!-- â–¼ è‡ªå‹•ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã‚¿ã‚¤ãƒ—ãƒ»å¼·ã¿ãƒ»å¼±ã¿ãƒ»æ”¹å–„æ¡ˆï¼‰ -->
    <div id="commentSection" style="display:none;">
      <h3 id="typeLabel" style="font-size:35px; margin-bottom:20px;"></h3>

      <div class="comment-card">
        <div id="strengths"></div>
        <div id="weaknesses"></div>
        <div id="suggestions"></div>
      </div>
    </div>




    <div id="score"></div><br>
    <div id="proDistance"></div><br>
    <div id="loopSummary"></div>
    <pre id="loopDetails" style="display: none;"></pre>
    <h3 id="Ken" style="display: none;">ãƒ«ãƒ¼ãƒ—æ¤œå‡º</h3>
    <img id="loopPlot" style="display: none; width: 1200px; height: auto;" />
    <h3 id="HeatmapTitle" style="display: none;">ãƒ«ãƒ¼ãƒ—é¡ä¼¼åº¦</h3>
    <div id="Rui" style="display: none;" class="heatmap-grid">
      <!-- è‡ªå·±æ¯”è¼ƒ -->
      <div class="hm-wrap">
        <img id="selfHeatmap" alt="è‡ªåˆ† vs è‡ªåˆ†ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—" style="max-width: 100%;" />
        <div class="hm-tip" tabindex="0" aria-label="è‡ªå·±æ¯”è¼ƒã®èª¬æ˜">i
          <div class="tooltip" id="tipSelfHeatmap"></div>
        </div>
      </div>

      <!-- ãƒ—ãƒ­æ¯”è¼ƒ -->
      <div class="hm-wrap">
        <img id="proHeatmap" alt="ãƒ—ãƒ­è·é›¢ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—" style="max-width: 100%;" />
        <div class="hm-tip" tabindex="0" aria-label="ãƒ—ãƒ­æ¯”è¼ƒã®èª¬æ˜">i
          <div class="tooltip" id="tipProHeatmap"></div>
        </div>
      </div>
    </div>
    <br><h3 id="orientationTitle" style="display:none;">æŒ‡å‹•ä½œã®å†ç¾ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆÎ²ç‰ˆï¼‰</h3>
    <div id="orientation3d" style="width: 700px; height: 600px; margin: 0 auto; display:none;"></div>


    
    </div>

    <hr id="hrCsv" style="display:none; border:none; border-top:2px solid black; width:100%; margin:40px 0;" />

    <div id="proExample" style="display: none;">
      <h2 id="proTitle"></h2>
      <h3 id="proMean"></h3>
      <h3 id="proStd"></h3>
      <h3 id="proSnap"></h3>
      <h3 id="proSnapStd"></h3>
      <h3 id="proSegTitle"></h3>
      <img src="/pro_segu.png" alt="ãƒ—ãƒ­ã®ãƒ«ãƒ¼ãƒ—æ¤œå‡ºå›³" style="width: 100%; max-width: 1200px;" />
      <h3 id="proHmTitle"></h3>
      <img src="/pro_heatmap.png" alt="ãƒ—ãƒ­ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—" style="width: 100%; max-width: 800px;" />
      <h3 id="proVideoTitle"></h3>
      <video controls style="max-width: 60%;">
        <source src="/pro.mp4" type="video/mp4" />
        ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
      </video>
      <h3 id="proAnimeTitle"></h3>
      <video controls style="max-width: 60%;">
        <source src="/proanime.mp4" type="video/mp4" />
        ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
      </video>
    </div>



    <hr id="hrCsv" style="display: none; border: none; border-top: 2px solid black; width: 100%; margin: 40px 0;" />
    <h2 id="csvTitle" style="display: none;">å–å¾—ãƒ‡ãƒ¼ã‚¿ (CSVå½¢å¼)</h2>
    <button id="btnSaveCsv" style="display: none;">CSVã‚’ä¿å­˜</button>
    <h3 id="accLabel" style="display: none;">åŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿</h3>
    <pre id="accOutput" style="display: none;"></pre>
    <h3 id="gyroLabel" style="display: none;">è§’é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿</h3>
    <pre id="gyroOutput" style="display: none;"></pre>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // â–¼ Firebase SDK èª­ã¿è¾¼ã¿å¾Œã«å¿…ãšè²¼ã‚‹ï¼ â–¼
      firebase.auth().onAuthStateChanged((user) => {
        if (!user) {
          console.log("æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ indexå†…ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹");
          return;
         }
      });

    </script>

    <script>
      // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ™ãƒ¼ã‚¹URL
      const API_ROOT = 'https://yoyo-backend.kajilab.dev';

      // DOMè¦ç´ å–å¾—
      const btnConnect   = document.getElementById('btnConnect');
      const btnStop      = document.getElementById('btnStop');
      const btnCsvMode   = document.getElementById('btnCsvMode');
      const csvInput     = document.getElementById('csvFiles');
      const btnRi        = document.getElementById('btnRi');
      const btnSaveResult= document.getElementById('btnSaveResult');
      const loadingDiv   = document.getElementById('loading');
      const progressBar  = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const scoreDiv     = document.getElementById('score');
      const loopPlotImg  = document.getElementById('loopPlot');
      const accOutput    = document.getElementById('accOutput');
      const gyroOutput   = document.getElementById('gyroOutput');
      const btnCancel   = document.getElementById('btnCancel');
      const btnRestart  = document.getElementById('btnRestart');
      const demoHeading  = document.getElementById('demoHeading');
      const appTitle  = document.getElementById('appTitle');
      const newsBox       = document.getElementById('newsBox');
      // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äººã®åå‰ï¼ˆãªã‘ã‚Œã°ã€Œã‚ãªãŸã€ï¼‰
      let currentUserName = 'ã‚ãªãŸ';


      // ===== i18n =====
      let lang = localStorage.getItem('lang') || 'ja';
      let lastResult = null;
      const PRO_MEAN_S = 0.429;
      const PRO_STD_S  = 0.072;

      let q0 = null;        // åˆæœŸå§¿å‹¢
      let q0_inv = null;    // é€†ã‚¯ã‚©ãƒ¼ã‚¿ãƒ‹ã‚ªãƒ³


      const i18n = {
        ja: {
          appTitle: 'ã‚¤ãƒ³ã‚µã‚¤ãƒ‰ãƒ»ãƒ«ãƒ¼ãƒ—æŠ€èƒ½è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ ',
          demoHeading: 'ãƒ‡ãƒ¢å‹•ç”»',
          newsBox: 'ãŠã—ã‚‰ã› / æ›´æ–°æƒ…å ±',
          btnConnectStart: 'æ¥ç¶š & ã‚»ãƒ³ã‚·ãƒ³ã‚°é–‹å§‹',
          btnConnectAgain: 'ã‚‚ã†ä¸€åº¦ã‚»ãƒ³ã‚·ãƒ³ã‚°',
          btnCsvMode: 'CSVã‹ã‚‰è§£æ',
          btnRestart: 'ã‚„ã‚Šç›´ã™',
          btnStop: 'ã‚»ãƒ³ã‚·ãƒ³ã‚°çµ‚äº†',
          btnCancel: 'ä¸­æ­¢',
          btnRi: 'å±¥æ­´ã‚’è¦‹ã‚‹',
          csvTitle: 'å–å¾—ãƒ‡ãƒ¼ã‚¿ (CSVå½¢å¼)',
          accTitle: 'åŠ é€Ÿåº¦',
          gyroTitle: 'è§’é€Ÿåº¦',
          titleResult: 'è§£æçµæœ',
          heatmapTitle: 'ãƒ«ãƒ¼ãƒ—é¡ä¼¼åº¦',
          overallScore: 'ç·åˆè©•ä¾¡',
          points: 'ç‚¹',

          // Radar tooltips
          tipSelfSim: 'è‡ªèº«ã®é¡ä¼¼åº¦ï¼š<br>å„ãƒ«ãƒ¼ãƒ—ã®ç¹°ã‚Šè¿”ã—ã®ä¸€è‡´åº¦ã€‚é«˜ã„ã»ã©å®‰å®šã€‚<br>é¡ä¼¼åº¦ãŒé«˜ã„ã»ã©é«˜è©•ä¾¡',
          tipMeanLoopTime: 'ã‚¹ãƒŠãƒƒãƒ—ã®å¼·ã•ã®ã°ã‚‰ã¤ãï¼š<br>å„ãƒ«ãƒ¼ãƒ—ã®æŒ‡ã‚’è¿”ã™ã¨ãï¼ˆã‚¹ãƒŠãƒƒãƒ—ï¼‰ã®å¼·ã•ã®æ¨™æº–åå·®ã€‚å°ã•ã„ã»ã©ä¸€å®šã®å¼·ã•ã§ãƒ«ãƒ¼ãƒ—ãŒã§ãã¦ã„ã‚‹ã€‚<br>å°ã•ã„ã»ã©é«˜è©•ä¾¡',
          tipLoopVar: 'ãƒ«ãƒ¼ãƒ—æ™‚é–“ã®ã°ã‚‰ã¤ãï¼š<br>å„ãƒ«ãƒ¼ãƒ—æ™‚é–“ã®æ¨™æº–åå·®ã€‚å°ã•ã„ã»ã©ãƒªã‚ºãƒ ãŒä¸€å®šã€‚<br>å°ã•ã„ã»ã©é«˜è©•ä¾¡',
          tipStableStart: 'å®‰å®šé–‹å§‹ãƒ«ãƒ¼ãƒ—ï¼š<br>å®‰å®šã—å§‹ã‚ã‚‹ã¾ã§ã«è¦ã—ãŸå‘¨å›æ•°ã€‚<br>å°ã•ã„ã»ã©é«˜è©•ä¾¡',
          tipProSim: 'ãƒ—ãƒ­é¡ä¼¼åº¦ï¼š<br>ãƒ—ãƒ­ã®å‹•ãã¨ã®ä¸€è‡´åº¦ã€‚é«˜ã„ã»ã©è¿‘ã„ã€‚<br>é«˜ã„ã»ã©é«˜è©•ä¾¡',

          // Heatmap tooltips
          tipSelfHeatmap: 'ãƒ«ãƒ¼ãƒ—é¡ä¼¼åº¦ï¼ˆè‡ªå·±æ¯”è¼ƒï¼‰ï¼š<br>iå‘¨ç›®ã¨jå‘¨ç›®ã®é¡ä¼¼åº¦ã€‚<br>é’=é«˜ã„ / èµ¤=ä½ã„',
          tipProHeatmap: 'ãƒ«ãƒ¼ãƒ—é¡ä¼¼åº¦ï¼ˆãƒ—ãƒ­æ¯”è¼ƒï¼‰ï¼š<br>å„ãƒ«ãƒ¼ãƒ—ã¨ãƒ—ãƒ­ã®é¡ä¼¼åº¦ã€‚<br>å¯¾è§’ãŒé’ã„ã»ã©ä¸€è‡´',

          // Metric labels
          m_totalLoops: 'ç·ãƒ«ãƒ¼ãƒ—æ•°',
          m_totalLoops_help: 'è¨ˆæ¸¬ä¸­ã«å®Ÿæ–½ã—ãŸã‚¤ãƒ³ã‚µã‚¤ãƒ‰ãƒ»ãƒ«ãƒ¼ãƒ—ã®åˆè¨ˆå›æ•°',
          m_stableStart: 'å®‰å®šé–‹å§‹',
          m_stableStart_help: 'ãƒ«ãƒ¼ãƒ—ãŒå®‰å®šã—å§‹ã‚ã‚‹ã¾ã§ã«ã‹ã‹ã£ãŸãƒ«ãƒ¼ãƒ—æ•°',
          m_selfScore: 'é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢',
          m_selfScore_help: 'è‡ªèº«ã®å„ãƒ«ãƒ¼ãƒ—ã®ç¹°ã‚Šè¿”ã—ä¸€è‡´åº¦ï¼ˆå®‰å®šæ€§ï¼‰',
          m_proScore: 'ãƒ—ãƒ­é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢',
          m_proScore_help: 'ãƒ—ãƒ­ã®ãƒ«ãƒ¼ãƒ—ã¨ã®ä¸€è‡´åº¦',
          m_loopTime: 'ãƒ«ãƒ¼ãƒ—æ™‚é–“',
          m_loopTime_help: 'ãƒ«ãƒ¼ãƒ—æ™‚é–“ã®å¹³å‡ã¨ã°ã‚‰ã¤ãï¼ˆæ¨™æº–åå·®ï¼‰',
          m_avg: 'å¹³å‡',
          m_var: 'ã°ã‚‰ã¤ã',
          m_snap: 'æ‰‹é¦–ã‚’è¿”ã™å¼·ã•',
          m_snap_help: 'å„ãƒ«ãƒ¼ãƒ—ã®ã‚¹ãƒŠãƒƒãƒ—æœ€å¤§å€¤ã®ä¸­å¤®å€¤ã¨ã°ã‚‰ã¤ã',
          unit_sec: 'ç§’',
          unit_ms2: 'm/sÂ²',

          // è¿½åŠ åˆ†ï¼ˆjaï¼‰
          analysisPreparing: 'è§£ææº–å‚™ä¸­â€¦',
          selectTwoCsv: 'åŠ é€Ÿåº¦CSVã¨è§’é€Ÿåº¦CSVã®2ã¤ã‚’é¸ã‚“ã§ãã ã•ã„',
          btnSaveCsvLabel: 'CSVã‚’ä¿å­˜',
          placeholderTitle: 'ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ï¼ˆãƒ¡ãƒ¢ä»£ã‚ã‚Šã«ä½¿ã£ã¦ãã ã•ã„ï¼‰',
          untitled: 'ç„¡é¡Œ',
          btnSaveResult: 'çµæœã‚’ä¿å­˜ã™ã‚‹',
          proTitle: 'å‚è€ƒãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ—ãƒ­ï¼‰',
          proMean: 'å¹³å‡ãƒ«ãƒ¼ãƒ—æ™‚é–“',
          proStd: 'ãƒ«ãƒ¼ãƒ—æ™‚é–“ã®æ¨™æº–åå·®',
          proSnap: 'æ‰‹é¦–ã‚’è¿”ã™å¼·ã•',
          proSnapStd: 'æ‰‹é¦–ã‚’è¿”ã™å¼·ã•ã®æ¨™æº–åå·®',
          proSegTitle: 'ãƒ—ãƒ­ã®ãƒ«ãƒ¼ãƒ—æ¤œå‡º',
          proHmTitle: 'ãƒ—ãƒ­ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—',
          proVideoTitle: 'ãƒ—ãƒ­ã®å®Ÿæ¼”æ˜ åƒ',
          proAnimeTitle: 'ãƒ—ãƒ­ã®æŒ‡ã®å‹•ã',

          // Misc / alerts
          analysisStarting: 'è§£æé–‹å§‹â€¦',
          analysisDone: 'è§£æå®Œäº†ï¼',
          connectFailed: 'æ¥ç¶šå¤±æ•—',
          analysisFailed: 'è§£æå¤±æ•—',
          cancelFailed: 'ä¸­æ­¢ã«å¤±æ•—',
          noResultToSave: 'ä¿å­˜ã§ãã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“',
          savedOk: (name)=> `ã€Œ${name}ã€ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ`,
          savedNg: 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'
        },
        en: {
          appTitle: 'Inside Loop Skill Evaluation',
          demoHeading: 'Demo Video',
          newsBox: 'News', 
          btnConnectStart: 'Connect & Start Sensing',
          btnConnectAgain: 'Sense Again',
          btnCsvMode: 'Analyze from CSV',
          btnRestart: 'Restart',
          btnStop: 'Stop Sensing',
          btnCancel: 'Cancel',
          btnRi: 'View History',
          csvTitle: 'Captured Data (CSV)',
          accTitle: 'Acceleration',
          gyroTitle: 'Angular Velocity',
          titleResult: 'Analysis Results',
          heatmapTitle: 'Loop Similarity',
          overallScore: 'Overall Score',
          points: 'pt',

          analysisPreparing: 'Preparingâ€¦',
          selectTwoCsv: 'Please select two CSV files: acceleration and gyroscope.',
          btnSaveCsvLabel: 'Save CSV',
          placeholderTitle: 'Enter a title',
          untitled: 'Untitled',
          btnSaveResult: 'Save Result',
          proTitle: 'Reference Data (Pro)',
          proMean: 'Mean Loop Time',
          proStd: 'Loop Time Std. Dev.',
          proSnap: 'Snap Strength',
          proSnapStd: 'Snap Std. Dev.',
          proSegTitle: 'Pro: Loop Detection',
          proHmTitle: 'Pro: Heatmap',
          proVideoTitle: 'Pro: Demo Video',
          proAnimeTitle: 'Pro: Animation',

          // Radar tooltips
          tipSelfSim: 'Self Similarity:<br>How consistently each loop repeats the same motion.<br>Higher = more stable.',
          tipMeanLoopTime: 'Mean Loop Time:<br>Average time per loop (pros â‰ˆ 0.4s).<br>Shorter = better.',
          tipLoopVar: 'Loop Time Variation:<br>Std. dev. of loop times (rhythm stability).<br>Smaller = better.',
          tipStableStart: 'Stable Start Loop:<br>Loops needed until stabilized.<br>Smaller = better.',
          tipProSim: 'Pro Similarity:<br>Similarity to the proâ€™s motion.<br>Higher = better.',

          // Heatmap tooltips
          tipSelfHeatmap: 'Loop Similarity (Self vs Self):<br>Similarity between loop i and j.<br>Blue=high / Red=low.',
          tipProHeatmap: 'Loop Similarity (vs Pro):<br>Similarity between your loops and the pro.<br>Bluer diagonal = closer.',

          // Metric labels
          m_totalLoops: 'Total Loops',
          m_totalLoops_help: 'Total number of inside loops during measurement.',
          m_stableStart: 'Stable Start',
          m_stableStart_help: 'Number of loops until becoming stable.',
          m_selfScore: 'Self Similarity Score',
          m_selfScore_help: 'How consistently your loops repeat (stability).',
          m_proScore: 'Pro Similarity Score',
          m_proScore_help: 'Similarity to the proâ€™s loops.',
          m_loopTime: 'Loop Time',
          m_loopTime_help: 'Mean loop time and variation (std. dev.).',
          m_avg: 'avg',
          m_var: 'stdev',
          m_snap: 'Snap Strength',
          m_snap_help: 'Median of per-loop max snap and its variation.',
          unit_sec: 's',
          unit_ms2: 'm/sÂ²',

          // Misc / alerts
          analysisStarting: 'Starting analysisâ€¦',
          analysisDone: 'Analysis complete!',
          connectFailed: 'Connection failed',
          analysisFailed: 'Analysis failed',
          cancelFailed: 'Cancel failed',
          noResultToSave: 'No result to save',
          savedOk: (name)=> `Saved as â€œ${name}â€`,
          savedNg: 'Save failed'
        }
      };

      const t = (k)=> {
        const v = i18n[lang][k];
        return typeof v === 'string' ? v : (v ?? i18n.ja[k] ?? k);
      };
      const tf = (k, ...args)=> {
        const v = i18n[lang][k];
        return typeof v === 'function' ? v(...args) : t(k);
      };

      function setText(id, text){ const el = document.getElementById(id); if(el) el.textContent = text; }
      function setHTML(id, html){ const el = document.getElementById(id); if(el) el.innerHTML = html; }

      function applyI18nStatic(){
        // è¦‹å‡ºã—ãƒ»ãƒœã‚¿ãƒ³
        setText('appTitle', t('appTitle'));
        setText('demoHeading', t('demoHeading'));
        setText('newsTitle', t('newsBox'));
        setText('btnConnect', t('btnConnectStart'));
        setText('btnCsvMode', t('btnCsvMode'));
        setText('btnRestart', t('btnRestart'));
        setText('btnStop', t('btnStop'));
        setText('btnCancel', t('btnCancel'));
        setText('btnRi', t('btnRi'));
        setText('csvTitle', t('csvTitle'));
        setText('accTitle', t('accTitle'));
        setText('gyroTitle', t('gyroTitle'));
        setText('Title', t('titleResult'));
        setText('HeatmapTitle', t('heatmapTitle'));
        // ä¿å­˜ãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«
        setText('btnSaveResult', t('btnSaveResult'));

        // ãƒ—ãƒ­å‚è€ƒãƒ‡ãƒ¼ã‚¿
        setText('proTitle', t('proTitle'));
        setText('proSegTitle', t('proSegTitle'));
        setText('proHmTitle', t('proHmTitle'));
        setText('proVideoTitle', t('proVideoTitle'));
        setText('proAnimeTitle', t('proAnimeTitle'));
        setText('proMean', `${t('proMean')}: ${PRO_MEAN_S} ${t('unit_sec')}`);
        setText('proStd',  `${t('proStd')}: ${PRO_STD_S} ${t('unit_sec')}`);
        setText('proSnap', `${t('proSnap')}: 91.45 ${t('unit_ms2')}`);
        setText('proSnapStd', `${t('proSnapStd')}: 25.80 ${t('unit_ms2')}`);



        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
        setHTML('tipSelfSim', t('tipSelfSim'));
        setHTML('tipMeanLoopTime', t('tipMeanLoopTime'));
        setHTML('tipLoopVar', t('tipLoopVar'));
        setHTML('tipStableStart', t('tipStableStart'));
        setHTML('tipProSim', t('tipProSim'));
        setHTML('tipSelfHeatmap', t('tipSelfHeatmap'));
        setHTML('tipProHeatmap', t('tipProHeatmap'));

        setText('btnSaveCsv', t('btnSaveCsvLabel'));
        setText('csvTitle', t('csvTitle'));
        setText('accLabel', t('accTitle'));
        setText('gyroLabel', t('gyroTitle'));

        // é€²æ—åˆæœŸæ–‡è¨€
        setText('progressText', t('analysisPreparing'));

        // ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
        const rn = document.getElementById('resultName');
        if (rn) rn.placeholder = t('placeholderTitle');


        // html[lang] ã‚’æ›´æ–°ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å‘ã‘ï¼‰
        document.documentElement.lang = lang;
      }

      showNews(true);


      // è¨€èªã‚»ãƒ¬ã‚¯ã‚¿åˆæœŸåŒ–
      const langSel = document.getElementById('langSelect');
      if (langSel){
        langSel.value = lang;
        langSel.addEventListener('change', (e)=>{
          lang = e.target.value || 'ja';
          localStorage.setItem('lang', lang);
          applyI18nStatic();
           // è§£æçµæœãŒã‚ã‚‹ãªã‚‰å‹•çš„éƒ¨åˆ†ã‚‚å†æç”»
          if (lastResult) {
            // ãƒ¬ãƒ¼ãƒ€ãƒ¼è¦‹å‡ºã—ï¼ˆç‚¹æ•°ã®å˜ä½ãªã©ï¼‰
            document.getElementById('RadarTitle').innerHTML =
              `<span class="num-red">${t('overallScore')}: ${lastResult.total_score.toFixed(1)} ${t('points')}</span>`;
            // æŒ‡æ¨™ã‚¨ãƒªã‚¢
            const scoreDiv = document.getElementById('score');
            scoreDiv.innerHTML = buildMetricsHTML(lastResult);
          }
        });
      }
      // åˆæœŸé©ç”¨
      applyI18nStatic();

      // å‹•çš„UIç”¨ãƒ˜ãƒ«ãƒ‘ï¼ˆçŠ¶æ…‹ã§ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«ã‚’åˆ‡æ›¿ï¼‰
      function setConnectButtonInitial(){
        setText('btnConnect', t('btnConnectStart'));
      }
      function setConnectButtonAgain(){
        setText('btnConnect', t('btnConnectAgain'));
      }


      // ä¾¿åˆ©é–¢æ•°
      function showIntroVideo(show=true){
        const v = document.getElementById('introVideo');
        if (v) v.style.display = show ? 'block' : 'none';
        if (demoHeading) demoHeading.style.display = show ? 'block' : 'none';
        if (appTitle) appTitle.style.display = show ? 'block' : 'none';
      }


      // ã‚»ãƒ³ã‚·ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨
      let device, controlChar, dataChar, buffer = '';
      const acc  = [], gyro = [];
      let isCsvMode = false;   

      // Chart.js åˆæœŸåŒ–
      const accCtx  = document.getElementById('accChart').getContext('2d');
      const gyroCtx = document.getElementById('gyroChart').getContext('2d');
      const accData  = { labels: [], datasets: [
        { label: 'ax', data: [], borderColor: 'blue',    fill:false, pointRadius:0 },
        { label: 'ay', data: [], borderColor: 'skyblue', fill:false, pointRadius:0 },
        { label: 'az', data: [], borderColor: 'navy',    fill:false, pointRadius:0 }
      ]};
      const gyroData = { labels: [], datasets: [
        { label: 'gx', data: [], borderColor: 'red',     fill:false, pointRadius:0 },
        { label: 'gy', data: [], borderColor: 'orange',  fill:false, pointRadius:0 },
        { label: 'gz', data: [], borderColor: 'darkred', fill:false, pointRadius:0 }
      ]};
      const accChart  = new Chart(accCtx,  { type:'line', data:accData,  options:{animation:false,scales:{x:{display:false}}}});
      const gyroChart = new Chart(gyroCtx, { type:'line', data:gyroData, options:{animation:false,scales:{x:{display:false}}}});

      const SERVICE_UUID = '88888888-4abd-ba0d-b7c6-ff0a00200021';
      const CONTROL_UUID = '88888888-4abd-ba0d-b7c6-ff0a00200022';
      const DATA_UUID    = '88888888-4abd-ba0d-b7c6-ff0a00200023';

      // æ±ç”¨ï¼šCSVâ†’JSON
      function csvToJson(text, isAcc=true) {
        const lines = text.trim().split('\n');
        lines.shift();
        return lines.map(l => {
          const c = l.split(',');
          return isAcc
            ? { t:+c[0], ax:+c[1], ay:+c[2], az:+c[3] }
            : { t:+c[0], gx:+c[1], gy:+c[2], gz:+c[3] };
        });
      }

      function showNews(show = true) {
        if (newsBox) {
          newsBox.style.display = show ? 'block' : 'none';
        }
      }


      // UIãƒªã‚»ãƒƒãƒˆ
      function resetUIBeforeMeasure() {
        document.getElementById('commentSection').style.display = 'none';
        document.getElementById('radarWrap').style.display = 'none';
        document.getElementById('Title').style.display = 'none';
        document.getElementById('RadarTitle').style.display = 'none';
        document.getElementById('radarChart').style.display = 'none';
        document.getElementById('loopPlot').style.display = 'none';
        document.getElementById('selfHeatmap').style.display = 'none';
        document.getElementById('proHeatmap').style.display = 'none';
        document.getElementById('proExample').style.display = 'none';
        document.getElementById('saveSection').style.display = 'none';
        document.getElementById('csvTitle').style.display = 'none';
        document.getElementById('btnSaveCsv').style.display = 'none';
        document.getElementById('accLabel').style.display = 'none';
        document.getElementById('gyroLabel').style.display = 'none';
        document.getElementById('accOutput').style.display = 'none';
        document.getElementById('gyroOutput').style.display = 'none';
        // document.getElementById('hrPro').style.display = 'none';
        document.getElementById('hrCsv').style.display = 'none';
        document.getElementById('hrTitle').style.display = 'none';
        document.getElementById('Ken').style.display = 'none';
        document.getElementById('HeatmapTitle').style.display = 'none';
        document.getElementById('Rui').style.display = 'none';
        document.getElementById('score').textContent           = '';
        document.getElementById('proDistance').textContent     = '';
        document.getElementById('loopSummary').textContent     = '';
        document.getElementById('loopSummary').innerHTML       = '';
        document.getElementById('orientationTitle').style.display = 'none';
        document.getElementById('orientation3d').style.display = 'none';
        const loopDetails = document.getElementById('loopDetails');
        loopDetails.textContent                               = '';
        loopDetails.style.display                             = 'none';
        acc.length = 0; gyro.length = 0;
        accData.labels.length = 0; accData.datasets.forEach(d=>d.data.length=0);
        gyroData.labels.length = 0; gyroData.datasets.forEach(d=>d.data.length=0);
        accChart.update(); gyroChart.update();
      }
      function hideMeasureUI() {
        document.getElementById('accChart').style.display = 'none';
        document.getElementById('gyroChart').style.display = 'none';
        document.getElementById('accTitle').style.display = 'none';
        document.getElementById('gyroTitle').style.display = 'none';
      }

      // è§£æç”¨ãƒ©ãƒƒãƒ‘ãƒ¼
      async function runAnalysis(payload) {
        showIntroVideo(false); 
        showNews(false);
        // ã‚¿ã‚¹ã‚¯é–‹å§‹
        const startRes = await fetch(`${API_ROOT}/start_analysis?lang=${lang}`, { method:'POST' });
        const { task_id } = await startRes.json();
        loadingDiv.style.display = 'block';
        progressBar.style.width = '0%';
        progressText.textContent = t('analysisStarting');

        // ãƒãƒ¼ãƒªãƒ³ã‚°
        const poll = setInterval(async ()=>{
          const res = await fetch(`${API_ROOT}/progress/${task_id}`);
          if(!res.ok) return;
          const info = await res.json();
          progressBar.style.width  = `${info.progress}%`;
          progressText.textContent  = info.message;
          if(info.progress>=100) clearInterval(poll);
        },300);

        // æœ¬è§£æ
        const analyzeRes = await fetch(`${API_ROOT}/analyze?task_id=${task_id}&lang=${lang}`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ ...payload, lang })
        });
        const json = await analyzeRes.json();


        // å®Œäº†
        clearInterval(poll);
        progressBar.style.width  = '100%';
        progressText.textContent = t('analysisDone');
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
        await new Promise(resolve => setTimeout(resolve, 1000));
        loadingDiv.style.display = 'none';

        return json;
      }

      // CSV è§£æ
      btnCsvMode.onclick  = ()=> csvInput.click();
      csvInput.onchange    = async ()=>{
        showNews(false); 
        showIntroVideo(false);
        if(csvInput.files.length<2){
          alert(t('selectTwoCsv'));
          return;
        }

        isCsvMode = true; 

        // â–¼ ã“ã“ã‚’è¿½åŠ ï¼šCSVè§£æä¸­ã¯ãƒœã‚¿ãƒ³éè¡¨ç¤º
        document.getElementById("login-area").style.display="none";
        btnConnect.style.display  = 'none';
        btnCsvMode.style.display  = 'none';
        btnRi.style.display       = 'none';
        btnStop.style.display    = 'none';
        showIntroVideo(false);

        

        const accJson  = csvToJson(await csvInput.files[0].text(),true);
        const gyroJson = csvToJson(await csvInput.files[1].text(),false);
        resetUIBeforeMeasure();
        try {
          const result = await runAnalysis({ acc:accJson, gyro:gyroJson });
          lastResult = result;
          renderResult(result);
        } catch(err) {
          // è§£æå¤±æ•—
          alert(t('analysisFailed') + ': ' + err.message);
        }
      };

      // ã‚»ãƒ³ã‚·ãƒ³ã‚°é–‹å§‹
      btnConnect.onclick = async ()=>{
        showIntroVideo(false);
        showNews(false);
        isCsvMode = false;
        resetUIBeforeMeasure();
        try {
          if (!device || !device.gatt.connected) {
            device = await navigator.bluetooth.requestDevice({
              filters: [
                { name: 'ã‚†ã³ã›ã‚“1å·' },
                { name: 'ã‚†ã³ã›ã‚“2å·' },
                { name: 'ã‚†ã³ã›ã‚“3å·' },
                { name: 'ã‚†ã³ã›ã‚“4å·' },
                { name: 'ã‚†ã³ã›ã‚“5å·' },
                { name: 'ã‚†ã³ã›ã‚“6å·' },
                { name: 'ã‚†ã³ã›ã‚“7å·' }
              ],
              optionalServices: [SERVICE_UUID]
            });
          }

          const server = await device.gatt.connect();
          const svc    = await server.getPrimaryService(SERVICE_UUID);
          controlChar  = await svc.getCharacteristic(CONTROL_UUID);
          dataChar     = await svc.getCharacteristic(DATA_UUID);
          await controlChar.writeValue(new Uint8Array([1]));
          await dataChar.startNotifications();
          dataChar.addEventListener('characteristicvaluechanged',handleNotify);
          document.getElementById('accTitle').style.display='block';
          document.getElementById('gyroTitle').style.display='block';
          document.getElementById('accChart').style.display='block';
          document.getElementById('gyroChart').style.display='block';
          
           // ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
          btnConnect.style.display   = 'none';               // â† å®Œå…¨ã«éš ã™
          btnStop.style.display      = 'inline-block';       // â† ã‚»ãƒ³ã‚·ãƒ³ã‚°çµ‚äº†ãƒœã‚¿ãƒ³ã‚’å‡ºã™
          btnStop.disabled           = false;
          btnCsvMode.style.display   = 'none';
          btnRi.style.display        = 'none';
          btnCancel.style.display   = 'inline-block';
          btnRestart.style.display  = 'inline-block';
          showIntroVideo(false);
        } catch(err) {
          // æ¥ç¶šå¤±æ•—
          alert(t('connectFailed') + ': ' + err.message);
        }
      };

      btnCancel.onclick = async () => {
        try {
          // ã‚»ãƒ³ã‚µãƒ¼åœæ­¢
          try { await controlChar?.writeValue(new Uint8Array([0])); } catch(e){}
          try { 
            await dataChar?.stopNotifications(); 
            dataChar?.removeEventListener('characteristicvaluechanged', handleNotify);
          } catch(e){}

          // UIã‚¯ãƒªã‚¢
          hideMeasureUI();
          resetUIBeforeMeasure();

          // ãƒœã‚¿ãƒ³å¾©å¸°ï¼ˆåˆæœŸçŠ¶æ…‹ã¸ï¼‰
          showIntroVideo(true);
          showNews(true);
          btnConnect.style.display   = 'inline-block';
          btnConnect.disabled        = false;
          // åˆæœŸçŠ¶æ…‹ã¸æˆ»ã™ã¨ã
          setConnectButtonInitial();
          btnCsvMode.style.display   = 'inline-block';
          btnRi.style.display        = 'inline-block';
          btnStop.style.display      = 'none';
          btnCancel.style.display    = 'none';
          btnRestart.style.display   = 'none';
          document.getElementById("login-area").style.display="block";
        } catch (err) {
          // ä¸­æ­¢å¤±æ•—
          alert(t('cancelFailed') + ': ' + err.message);
        }
      };

      async function safeStopMeasure() {
        try { await controlChar?.writeValue(new Uint8Array([0])); } catch(e){}
        try { 
          await dataChar?.stopNotifications(); 
          dataChar?.removeEventListener('characteristicvaluechanged', handleNotify);
        } catch(e){}
        hideMeasureUI();
      }

      btnRestart.onclick = async () => {
        // ã„ã¾ã®è¨ˆæ¸¬ã‚’ç¢ºå®Ÿã«åœæ­¢
        await safeStopMeasure();

        // å–å¾—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãƒ»å‰å›çµæœãªã©ã‚’å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
        resetUIBeforeMeasure();


        // ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™ï¼ˆè¡¨ç¤ºã¾ã‚ã‚Šã¯ãŠå¥½ã¿ã§ï¼‰
        btnConnect.style.display = 'inline-block';
        btnConnect.disabled      = false;
        btnCsvMode.style.display = 'inline-block';
        btnRi.style.display      = 'inline-block'
        btnStop.style.display    = 'none';
        btnCancel.style.display  = 'none';
        btnRestart.style.display = 'none';
        showIntroVideo(true);
        showNews(true);

        // ç›´ã¡ã«ã€Œæ¥ç¶š & ã‚»ãƒ³ã‚·ãƒ³ã‚°é–‹å§‹ã€ã‚’å®Ÿè¡Œï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯å†…ãªã®ã§è¨±å¯ã•ã‚Œã‚‹ï¼‰
        btnConnect.click();
      
      };





      // ã‚»ãƒ³ã‚·ãƒ³ã‚°çµ‚äº†â†’è§£æ
      btnStop.onclick = async ()=>{
        try {
          btnConnect.style.display='none';
          btnCsvMode.style.display='none';
          btnStop.style.display='none';
          btnRi.style.display='none';
          btnCancel.style.display  = 'none';
          btnRestart.style.display = 'none';
          document.getElementById("login-area").style.display="none"
          showIntroVideo(false);
          showNews(false);
          hideMeasureUI();
          await controlChar.writeValue(new Uint8Array([0]));
          await dataChar.stopNotifications();
          const result = await runAnalysis({ acc, gyro });
          lastResult = result;
          renderResult(result);
        } catch(err) {
          alert(t('analysisFailed') + ': ' + err.message);
        }
      };




      // ãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒãƒ³ãƒ‰ãƒ©
      function handleNotify(event) {
        buffer += new TextDecoder().decode(event.target.value);
        const lines = buffer.split('\n');
        buffer = lines.pop();
        for(const line of lines) {
          const p = line.trim().split(',').map(Number);
          if(p.length===7){
            const [t,ax,ay,az,gx,gy,gz]=p;
            acc.push({ t,ax,ay,az });
            gyro.push({ t,gx,gy,gz });
            accData.labels.push(''); gyroData.labels.push('');
            accData.datasets[0].data.push(ax);
            accData.datasets[1].data.push(ay);
            accData.datasets[2].data.push(az);
            gyroData.datasets[0].data.push(gx);
            gyroData.datasets[1].data.push(gy);
            gyroData.datasets[2].data.push(gz);
            if(accData.labels.length>100){
              accData.labels.shift();
              accData.datasets.forEach(d=>d.data.shift());
            }
            if(gyroData.labels.length>100){
              gyroData.labels.shift();
              gyroData.datasets.forEach(d=>d.data.shift());
            }
            accChart.update(); gyroChart.update();
          }
        }
      }

      // çµæœæç”»
      function renderResult(json){
        // è¦‹å‡ºã—ã‚„ç”»åƒãªã©è¡¨ç¤º
        document.getElementById('Title').style.display='block';
        document.getElementById('RadarTitle').style.display='block';
        document.getElementById('radarChart').style.display='block';
        document.getElementById('radarWrap').style.display = 'inline-block';
        document.getElementById('loopPlot').style.display='block';
        document.getElementById('selfHeatmap').style.display='block';
        document.getElementById('proHeatmap').style.display='block';
        document.getElementById('proExample').style.display='block';
        document.getElementById('saveSection').style.display='block';
        document.getElementById('btnSaveResult').style.display = 'inline-block';

        // ãƒ¬ãƒ¼ãƒ€ãƒ¼ç”»åƒ
        const radarImg = document.getElementById('radarChart');
        radarImg.src = `data:image/png;base64,${json.radar_chart}`;
        document.getElementById('RadarTitle').innerHTML =
          `<span class="num-red">${t('overallScore')}: ${json.total_score.toFixed(1)} ${t('points')}</span>`;

        // â–¼ è‡ªå‹•ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
        const cSec  = document.getElementById('commentSection');
        const typeL = document.getElementById('typeLabel');
        const sDiv  = document.getElementById('strengths');
        const wDiv  = document.getElementById('weaknesses');
        const sugDiv= document.getElementById('suggestions');

        cSec.style.display = 'block';

        // ã‚¿ã‚¤ãƒ—è¡¨ç¤º
        const baseName = currentUserName || (lang === 'ja' ? 'ã‚ãªãŸ' : 'You');
        const labelName = (lang === 'ja' && baseName !== 'ã‚ãªãŸ')
          ? `${baseName}ã•ã‚“`
          : baseName;
        const connector = (lang === 'ja' ? 'ã¯ ' : ' is ');
        typeL.innerHTML = `
          <span style="color:#000;">
            ${labelName}${connector}
          </span><br>
          <span class="num-red">
            ${json.type}
          </span>
        `;


        // å¼·ã¿
        if (json.comments?.strengths?.length){
          sDiv.innerHTML = `
            <div class="blockTitle">è‰¯ã„ç‚¹</div>
            <ul>
              ${json.comments.strengths.map(s => `<li>${s}</li>`).join('')}
            </ul>
          `;
        } else {
          sDiv.innerHTML = '';
        }

        // å¼±ã¿
        if (json.comments?.weaknesses?.length){
          wDiv.innerHTML = `
            <div class="blockTitle">æ”¹å–„ç‚¹</div>
            <ul>
              ${json.comments.weaknesses.map(w => `<li>${w}</li>`).join('')}
            </ul>
          `;
        } else {
          wDiv.innerHTML = '';
        }

        // æ”¹å–„æ¡ˆ
        if (json.comments?.suggestions?.length){
          sugDiv.innerHTML = `
            <div class="blockTitle">æ”¹å–„æ¡ˆ</div>
            <ul>
              ${json.comments.suggestions.map(a => `<li>${a}</li>`).join('')}
            </ul>
          `;
        } else {
          sugDiv.innerHTML = '';
        }



        // ãƒ«ãƒ¼ãƒ—æ¤œå‡ºå›³
        const loopPlotImg = document.getElementById('loopPlot');
        loopPlotImg.src = `data:image/png;base64,${json.loop_plot}`;

        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
        document.getElementById('selfHeatmap').src = `data:image/png;base64,${json.self_heatmap}`;
        document.getElementById('proHeatmap').src  = `data:image/png;base64,${json.pro_heatmap}`;
        document.getElementById('HeatmapTitle').style.display = 'block';
        document.getElementById('Rui').style.display = 'flex';

        // â”€â”€ ã“ã“ã‹ã‚‰ã€Œæ•°å€¤ã®ä¸¦ã³é †ã€ã‚’ scoreDiv ã«é›†ç´„ã—ã¦æç”» â”€â”€
        const totalLoops = json.loop_count;
        const stableStr  = (json.stable_loop !== null) ? `${json.stable_loop} å‘¨ç›®` : 'ãªã—';
        const scoreStr   = `${json.score.toFixed(1)} ç‚¹`;
        const proDistStr = (json.pro_distance_mean !== null && json.pro_distance_mean !== undefined)
          ? json.pro_distance_mean.toFixed(1)
          : 'ãªã—';

        const meanTxt = (json.loop_mean_duration !== null)
          ? `${json.loop_mean_duration.toFixed(3)} ç§’`
          : 'ãªã—';
        const stdTxt  = (json.loop_std_duration !== null)
          ? `${json.loop_std_duration.toFixed(3)} ç§’`
          : 'ãªã—';

        const snapMedTxt = (json.snap_median !== null && json.snap_median !== undefined)
          ? `${json.snap_median.toFixed(2)} m/sÂ²`
          : 'â€”';
        const snapStdTxt = (json.snap_std !== null && json.snap_std !== undefined)
          ? `${json.snap_std.toFixed(2)} m/sÂ²`
          : 'â€”';
        const proScore100  = (json.pro_score_100   != null) ? `${json.pro_score_100.toFixed(1)} ç‚¹` : 'ãªã—';


        // ãƒ›ãƒãƒ¼èª¬æ˜ã¯ãƒ©ãƒ™ãƒ«ãƒ»æ•°å€¤ã¾ã¨ã‚ã¦ inline-tip å†…ã«ç¶­æŒ
        const scoreDiv = document.getElementById('score');
        // å…ƒï¼šscoreDiv.innerHTML = `...å·¨å¤§ãƒ†ãƒ³ãƒ—ãƒ¬...`;
        scoreDiv.innerHTML = `
          <div class="metric-card">
            ${buildMetricsHTML(json)}
          </div>
        `;


        

        

        // æ—§è¡¨ç¤ºã®é ˜åŸŸã¯é‡è¤‡å›é¿ã®ãŸã‚éè¡¨ç¤º
        document.getElementById('proDistance').style.display = 'none';
        document.getElementById('loopSummary').style.display  = 'none';

        // ãƒ«ãƒ¼ãƒ—æ™‚é–“ã®ç”Ÿãƒªã‚¹ãƒˆï¼ˆä»»æ„è¡¨ç¤ºï¼‰
        const loopDetails = document.getElementById('loopDetails');
        if (json.loop_duration_list?.length){
          loopDetails.textContent = json.loop_duration_list.join('\n');
          loopDetails.style.display='block';
        } else {
          loopDetails.style.display='none';
        }

        // CSV ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
        document.getElementById('hrCsv').style.display   = 'block';
        document.getElementById('csvTitle').style.display = 'block';
        document.getElementById('btnSaveCsv').style.display = 'block';
        document.getElementById('accLabel').style.display  = 'block';
        document.getElementById('gyroLabel').style.display = 'block';
        document.getElementById('accOutput').style.display  = 'block';
        document.getElementById('gyroOutput').style.display = 'block';

        // acc / gyro ã® CSV ä¸­èº«ï¼ˆæ—¢å­˜ã® acc, gyro é…åˆ—ã‚’ä½¿ç”¨ï¼‰
        document.getElementById('accOutput').textContent =
          'time,x,y,z\n' + acc.map(d=>`${d.t},${d.ax},${d.ay},${d.az}`).join('\n');
        document.getElementById('gyroOutput').textContent =
          'time,x,y,z\n' + gyro.map(d=>`${d.t},${d.gx},${d.gy},${d.gz}`).join('\n');

        // ãƒœã‚¿ãƒ³å¾©å¸°
        const btnConnect = document.getElementById('btnConnect');
        const btnCsvMode = document.getElementById('btnCsvMode');
        const btnRi      = document.getElementById('btnRi');
        const btnStop    = document.getElementById('btnStop');

        btnConnect.style.display   = 'inline-block';
        btnConnect.disabled        = false;
        setConnectButtonAgain();
        btnCsvMode.style.display   = 'inline-block';
        btnRi.style.display        = 'inline-block';
        btnStop.style.display      = 'none';

        // ---- Three.js å§¿å‹¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ----
        if (json.quaternions) {
        document.getElementById("orientationTitle").style.display = "block";
        const container = document.getElementById("orientation3d");
        container.style.display = "block";

        const width = container.clientWidth;
        const height = container.clientHeight;

        // --------------------
        // Scene / Camera
        // --------------------
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
        camera.position.set(0, 0, 120);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(width, height);
        container.innerHTML = "";
        container.appendChild(renderer.domElement);

        // --------------------
        // Light
        // --------------------
        const light1 = new THREE.DirectionalLight(0xffffff, 1.0);
        light1.position.set(50, 50, 100);
        scene.add(light1);
        scene.add(new THREE.AmbientLight(0x888888));

        let model = null;
        


        // =========================================================
        // â˜… STLãƒ¢ãƒ‡ãƒ«å›ºæœ‰ã®ã€ŒåˆæœŸå‘ãè£œæ­£ã€ã‚¯ã‚©ãƒ¼ã‚¿ãƒ‹ã‚ªãƒ³
        // =========================================================
        // â˜…â˜…â˜… ã“ã“ã‚’å¤‰ãˆã‚Œã°å¿…ãšè¦‹ãŸç›®ãŒå¤‰ã‚ã‚‹ â˜…â˜…â˜…
        const modelFixQ = new THREE.Quaternion();
        modelFixQ.setFromEuler(new THREE.Euler(
          THREE.MathUtils.degToRad(90),   // Xï¼ˆâ†ã“ã“ã‚’è§¦ã‚‹ï¼‰
          THREE.MathUtils.degToRad(180),    // Y
          THREE.MathUtils.degToRad(-270)     // Z
        ));

        // --------------------
        // STL Load
        // --------------------
        const loader = new THREE.STLLoader();
        loader.load("ä¸­æŒ‡2.stl", function (geometry) {
          const material = new THREE.MeshStandardMaterial({
            color: 0xffc9b1,   // è‚Œè‰²
            roughness: 0.7,    // å°‘ã—ã‚¶ãƒ©ã¤ã
            metalness: 0.0    // é‡‘å±æ„Ÿãªã—
          });

          model = new THREE.Mesh(geometry, material);

          geometry.computeBoundingBox();
          geometry.center();

          model.scale.set(6, 6, 6);


          // âš  rotation.set ã¯ä½¿ã‚ãªã„ï¼ˆæ¯ãƒ•ãƒ¬ãƒ¼ãƒ ä¸Šæ›¸ãã•ã‚Œã‚‹ãŸã‚ï¼‰
          scene.add(model);
        });

        

        // --------------------
        // Initial calibration
        // --------------------
        let q0 = null;
        let q0_inv = null;

        function applyQuaternion(q) {
          if (!model) return;

          // Python [w,x,y,z] â†’ Three.js
          const threeQ = new THREE.Quaternion(q[1], -q[3], q[2], q[0]);

          // åˆæœŸã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
          if (!q0) {
            q0 = threeQ.clone();
            q0_inv = q0.clone().invert();
            console.log("ğŸ¯ åˆæœŸå§¿å‹¢ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†");
          }

          // ã‚»ãƒ³ã‚µç›¸å¯¾å›è»¢
          const q_rel = q0_inv.clone().multiply(threeQ);

          // â˜… æ­£ã—ã„åˆæˆé †
          const q_final = modelFixQ.clone().multiply(q_rel);

          model.setRotationFromQuaternion(q_final);
        }

        // --------------------
        // Animation
        // --------------------
        let idx = 0;
        function animate() {
          requestAnimationFrame(animate);

          if (json.quaternions.length > 0) {
            applyQuaternion(json.quaternions[idx]);
            idx = (idx + 1) % json.quaternions.length;
          }

          renderer.render(scene, camera);
        }

        // --------------------
        // IntersectionObserver
        // --------------------
        let animationStarted = false;
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting && !animationStarted) {
              animationStarted = true;
              console.log("ğŸ¬ å§¿å‹¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹");
              animate();
            }
          });
        });

        observer.observe(container);
      }
    }

      function buildMetricsHTML(json){
          const totalLoops = json.loop_count;
          const stableStr  = (json.stable_loop !== null) ? `${json.stable_loop}` : (lang==='ja'?'ãªã—':'â€”');
          const scoreStr   = `${json.score.toFixed(1)}`;
          const meanTxt = (json.loop_mean_duration != null)
            ? `${json.loop_mean_duration.toFixed(3)} ${t('unit_sec')}` : (lang==='ja'?'ãªã—':'â€”');
          const stdTxt  = (json.loop_std_duration != null)
            ? `${json.loop_std_duration.toFixed(3)} ${t('unit_sec')}` : (lang==='ja'?'ãªã—':'â€”');
          const snapMedTxt = (json.snap_median != null)
            ? `${json.snap_median.toFixed(2)} ${t('unit_ms2')}` : (lang==='ja'?'â€”':'â€”');
          const snapStdTxt = (json.snap_std != null)
            ? `${json.snap_std.toFixed(2)} ${t('unit_ms2')}` : (lang==='ja'?'â€”':'â€”');
          const proScore100 = (json.pro_score_100 != null) ? `${json.pro_score_100.toFixed(1)}` : (lang==='ja'?'ãªã—':'â€”');

          const wrap = (label, val, help) => `
            <span class="inline-tip">
              ${label}ï¼š <strong><span class="num-red">${val}</span></strong>
              <span class="bubble">${help}</span>
            </span>`;

          return `
            <div class="metric-line">
              ${wrap(t('m_totalLoops'), `${totalLoops} ${lang==='ja'?'å‘¨':''}`, t('m_totalLoops_help'))}
              ${wrap(t('m_stableStart'), lang==='ja'? `${stableStr} å‘¨ç›®` : (stableStr==='â€”'?'â€”': `#${stableStr}`), t('m_stableStart_help'))}
            </div>

            <div class="metric-line">
              ${wrap(t('m_selfScore'), `${scoreStr} ${t('points')}`, t('m_selfScore_help'))}
              ${wrap(t('m_proScore'), (proScore100==='â€”'||proScore100==='ãªã—') ? (lang==='ja'?'ãªã—':'â€”') : `${proScore100} ${t('points')}`, t('m_proScore_help'))}
            </div>

            <div class="metric-line">
              ${wrap(t('m_loopTime'), `<strong><span class="num-red">${meanTxt}</span></strong>ï¼ˆ${t('m_avg')}ï¼‰ / <strong><span class="num-red">${stdTxt}</span></strong>ï¼ˆ${t('m_var')}ï¼‰`, t('m_loopTime_help'))}
            </div>

            <div class="metric-line">
              ${wrap(t('m_snap'), `<strong><span class="num-red">${snapMedTxt}</span></strong>ï¼ˆ${lang==='ja'?'ä¸­å¤®å€¤':'median'}ï¼‰ / <strong><span class="num-red">${snapStdTxt}</span></strong>ï¼ˆ${t('m_var')}ï¼‰`, t('m_snap_help'))}
            </div>
          `;
        }


      // ä¿å­˜
      btnSaveResult.onclick = async ()=>{
        const user = firebase.auth().currentUser;
        if(!user){
            alert("ä¿å­˜ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
            location.href = "login.html";
            return;
        }

        if(!lastResult){ alert("ä¿å­˜ã§ãã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“"); return; }

        const name = document.getElementById('resultName').value.trim() || "ç„¡é¡Œ";
        const accCsv  = 'time,x,y,z\n'+acc.map(d=>`${d.t},${d.ax},${d.ay},${d.az}`).join('\n');
        const gyroCsv = 'time,x,y,z\n'+gyro.map(d=>`${d.t},${d.gx},${d.gy},${d.gz}`).join('\n');

        const payload = {
            ...lastResult,
            name,
            acc_csv: accCsv,
            gyro_csv: gyroCsv,
            user_id: user.uid,               // UID
            user_name: user.displayName || "æœªè¨­å®š", 
            user_email: user.email           // â†â˜…çµ¶å¯¾ã“ã‚Œ
        };


        const res = await fetch(`${API_ROOT}/save_result`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(payload)
        });

        const r = await res.json();
        alert(r.status==="saved" ? `ä¿å­˜ã—ã¾ã—ãŸï¼ (${name})` : "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
      };



      // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      document.getElementById('btnSaveCsv').onclick = ()=>{
        const now=new Date(),pad=n=>n.toString().padStart(2,'0');
        const ts=`${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
        const accCsv  = 'time,x,y,z\n'+acc.map(d=>`${d.t},${d.ax},${d.ay},${d.az}`).join('\n');
        const gyroCsv = 'time,x,y,z\n'+gyro.map(d=>`${d.t},${d.gx},${d.gy},${d.gz}`).join('\n');
        const saveFile=(c,f)=>{
          const b=new Blob([c],{type:'text/csv'}),u=URL.createObjectURL(b);
          const a=document.createElement('a'); a.href=u; a.download=f; a.click(); URL.revokeObjectURL(u);
        };
        saveFile(accCsv,`${ts}_acc.csv`);
        saveFile(gyroCsv,`${ts}_gyro.csv`);
      };

    
    </script>
  </div>
</body>
</html>
