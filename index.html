<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>インサイド・ループ技能評価</title>
  <style>
    body { font-family: 'Hiragino Sans', sans-serif; padding: 20px; }
    button { margin-right: 10px; padding: 10px; font-size: 16px; }
    #score, #loopSummary, #loopDetails { font-size: 18px; margin-top: 10px; }
    pre { background: #f4f4f4; padding: 10px; max-height: 200px; overflow: auto; }
    img { display: block; margin-top: 20px; max-width: 100%; height: auto; }
  </style>
</head>
<body>
  <button id="btnConnect">接続 &amp; センシング開始</button>
  <button id="btnStop" disabled>センシング終了 &amp; 解析</button>
  <div id="loading" style="display: none; font-size: 18px; margin-top: 20px;">解析中...</div>

  <canvas id="liveChart" width="800" height="300" style="display: none;"></canvas>
  <img id="loopPlot" style="display: none; width: 800px; height: auto;" />
  <div id="score"></div>
  <div id="loopSummary"></div>
  <pre id="loopDetails" style="display: none;"></pre>
  <img id="heatmap" alt="ヒートマップ" style="display: none;" />
  <h2 id="csvTitle" style="display: none;">取得データ (CSV形式)</h2>
  <button id="btnSaveCsv" style="display: none;">CSVを保存</button>

  <h3 id="accLabel" style="display: none;">加速度データ</h3>
  <pre id="accOutput" style="display: none;"></pre>

  <h3 id="gyroLabel" style="display: none;">角速度データ</h3>
  <pre id="gyroOutput" style="display: none;"></pre>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const SERVICE_UUID = '88888888-4abd-ba0d-b7c6-ff0a00200021';
    const CONTROL_UUID = '88888888-4abd-ba0d-b7c6-ff0a00200022';
    const DATA_UUID    = '88888888-4abd-ba0d-b7c6-ff0a00200023';
    const API_BASE     = 'https://yoyo-backend.kajilab.dev/analyze';

    let device, dataChar, controlChar;
    let buffer = '';
    const acc = [], gyro = [];

    const btnConnect = document.getElementById('btnConnect');
    const btnStop    = document.getElementById('btnStop');
    const scoreDiv   = document.getElementById('score');
    const loopPlotImg = document.getElementById('loopPlot');
    const heatmapImg  = document.getElementById('heatmap');
    const loadingDiv = document.getElementById('loading');
    const accOutput = document.getElementById('accOutput');
    const gyroOutput = document.getElementById('gyroOutput');

    const ctx = document.getElementById('liveChart').getContext('2d');
    const chartData = {
      labels: [],
      datasets: [
        { label: 'ax', data: [], borderColor: 'blue', fill: false, pointRadius: 0 },
        { label: 'ay', data: [], borderColor: 'skyblue', fill: false, pointRadius: 0 },
        { label: 'az', data: [], borderColor: 'navy', fill: false, pointRadius: 0 },
        { label: 'gx', data: [], borderColor: 'red', fill: false, pointRadius: 0 },
        { label: 'gy', data: [], borderColor: 'orange', fill: false, pointRadius: 0 },
        { label: 'gz', data: [], borderColor: 'darkred', fill: false, pointRadius: 0 }
      ]
    };

    const liveChart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: {
        animation: false,
        scales: { x: { display: false } },
        plugins: { legend: { labels: { font: { size: 14 } } } }
      }
    });

    // センシング開始
    btnConnect.onclick = async () => {
      acc.length = 0;
      gyro.length = 0;
      chartData.labels.length = 0;
      chartData.datasets.forEach(ds => ds.data.length = 0);
      liveChart.update();

      document.getElementById('liveChart').style.display = 'block';
      document.getElementById('loopPlot').style.display = 'none';

      try {
        if (!device || !device.gatt.connected) {
          device = await navigator.bluetooth.requestDevice({
            filters: [{ name: 'ArduinoIMU' }],
            optionalServices: [SERVICE_UUID]
          });
        }
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        controlChar = await service.getCharacteristic(CONTROL_UUID);
        dataChar = await service.getCharacteristic(DATA_UUID);

        await controlChar.writeValue(new Uint8Array([1]));
        await new Promise(r => setTimeout(r, 100));
        await dataChar.startNotifications();
        dataChar.addEventListener('characteristicvaluechanged', handleNotify);

        btnConnect.disabled = true;
        btnStop.disabled = false;
        console.log('▶ センシング開始');
      } catch (err) {
        console.error(err);
        alert('接続失敗: ' + err.message);
      }
    };

    // センサデータ受信
    function handleNotify(event) {
      buffer += new TextDecoder().decode(event.target.value);
      const lines = buffer.split('\n');
      buffer = lines.pop();
      for (const line of lines) {
        const p = line.trim().split(',').map(Number);
        if (p.length === 7) {
          const [t, ax, ay, az, gx, gy, gz] = p;
          acc.push({ t, ax, ay, az });
          gyro.push({ t, gx, gy, gz });

          chartData.labels.push('');
          chartData.datasets[0].data.push(ax);
          chartData.datasets[1].data.push(ay);
          chartData.datasets[2].data.push(az);
          chartData.datasets[3].data.push(gx);
          chartData.datasets[4].data.push(gy);
          chartData.datasets[5].data.push(gz);

          if (chartData.labels.length > 100) {
            chartData.labels.shift();
            chartData.datasets.forEach(ds => ds.data.shift());
          }
          liveChart.update();
        }
      }
    }

    // センシング終了 → 解析
    btnStop.onclick = async () => {
      try {
        loadingDiv.style.display = 'block';
        await controlChar.writeValue(new Uint8Array([0]));
        await dataChar.stopNotifications();
        btnStop.disabled = true;

        accOutput.textContent = 'time,x,y,z\n' + acc.map(d => `${d.t},${d.ax},${d.ay},${d.az}`).join('\n');
        gyroOutput.textContent = 'time,x,y,z\n' + gyro.map(d => `${d.t},${d.gx},${d.gy},${d.gz}`).join('\n');

        document.getElementById('csvTitle').style.display = 'block';
        document.getElementById('btnSaveCsv').style.display = 'inline-block';
        document.getElementById('accLabel').style.display = 'block';
        document.getElementById('gyroLabel').style.display = 'block';
        accOutput.style.display = 'block';
        gyroOutput.style.display = 'block';

        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ acc, gyro })
        });
        const json = await res.json();

        document.getElementById('liveChart').style.display = 'none';

        if (json.loop_plot && typeof json.loop_plot === 'string' && json.loop_plot.length > 0) {
          loopPlotImg.src = `data:image/png;base64,${json.loop_plot}`;
          loopPlotImg.style.display = 'block';
        } else {
          console.warn('loop_plot is null or invalid');
          loopPlotImg.style.display = 'none';
        }


        if (json.heatmap) {
          heatmapImg.src = `data:image/png;base64,${json.heatmap}`;
          heatmapImg.style.display = 'block';
        } else {
          heatmapImg.style.display = 'none';
          console.warn('heatmap is null or undefined');
        }

        scoreDiv.textContent = `類似度スコア: ${json.score.toFixed(1)}　総ループ数: ${json.loop_count}　${json.stable_loop !== null ? `安定開始ループ: ${json.stable_loop}周目` : '安定開始ループ: なし'}`;
        const meanStr = (json.loop_mean_duration !== null) ? `平均ループ時間: ${json.loop_mean_duration.toFixed(3)} 秒` : `平均ループ時間: なし`;
        const stdStr  = (json.loop_std_duration !== null)  ? `　ループ時間の標準偏差: ${json.loop_std_duration.toFixed(3)} 秒` : `　ループ時間の標準偏差: なし`;
        document.getElementById('loopSummary').textContent = `${meanStr}\n${stdStr}`;

        const loopDetails = document.getElementById('loopDetails');
        if (json.loop_duration_list?.length) {
          loopDetails.textContent = json.loop_duration_list.join('\n');
          loopDetails.style.display = 'block';
        } else {
          loopDetails.textContent = '';
          loopDetails.style.display = 'none';
        }

      } catch (err) {
        console.error(err);
        alert('解析失敗: ' + err.message);
      } finally {
        loadingDiv.style.display = 'none';
        btnConnect.disabled = false;
        btnConnect.textContent = 'もう一度センシング';
      }

      // 保存ボタンの処理
      document.getElementById('btnSaveCsv').onclick = () => {
        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        const ts = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
        const accCsv = 'time,x,y,z\n' + acc.map(d => `${d.t},${d.ax},${d.ay},${d.az}`).join('\n');
        const gyroCsv = 'time,x,y,z\n' + gyro.map(d => `${d.t},${d.gx},${d.gy},${d.gz}`).join('\n');

        const saveFile = (content, filename) => {
          const blob = new Blob([content], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.click();
          URL.revokeObjectURL(url);
        };

        saveFile(accCsv, `${ts}_acc.csv`);
        saveFile(gyroCsv, `${ts}_gyro.csv`);
      };
    };
  </script>
</body>
</html>
